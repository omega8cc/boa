#!/bin/bash


###----------------------------------------###
###
###  Octopus Aegir Installer
###
###  Copyright (C) 2010-2016 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: https://github.com/omega8cc/boa
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###


###
### Helper variables
###
bldPth="/opt/tmp/boa"
crlGet="-L --max-redirs 10 -k -s --retry 10 --retry-delay 5 -A iCab"
filIncO="octopus.sh.cnf"
gCb="git clone --branch"
gitHub="https://github.com/omega8cc"
gitLab="https://gitlab.com/omega8cc"
libFnc="${bldPth}/lib/functions"
tocIncO="${filIncO}.$1"
vBs="/var/backups"
vSet="vset --always-set"


###
### Panic on missing include
###
panic_exit() {
  echo
  echo " EXIT: Required lib file not available?"
  echo " EXIT: $1"
  echo " EXIT: Cannot continue"
  echo " EXIT: Bye (0)"
  echo
  touch /opt/tmp/status-AegirSetupB-FAIL
  exit 1
}


###
### Include helper functions
###
if [ -e "${vBs}/${tocIncO}" ]; then
  source "${vBs}/${tocIncO}"
  tInc="${vBs}/${tocIncO}"
elif [ -e "${vBs}/${filIncO}" ]; then
  source "${vBs}/${filIncO}"
  tInc="${vBs}/${filIncO}"
else
  panic_exit "${tInc}"
fi


###
### Env debugging
###
if [ "${_DEBUG_MODE}" = "YES" ]; then
  echo DEBUG AegirSetupB
  echo DEBUG AegirSetupB
  echo Effective _USER is $1
  [ -r "${vBs}/${tocIncO}" ] && echo Effective tocIncO is ${tocIncO}
  echo DEBUG AegirSetupB
  echo DEBUG AegirSetupB
  env
  echo DEBUG AegirSetupB
  echo DEBUG AegirSetupB
fi


###
### More helper variables
###
urlDev="http://${_USE_MIR}/dev"
urlHmr="http://${_USE_MIR}/versions/master/aegir"


###
### Include shared functions
###
_FL="helper satellite"
for f in ${_FL}; do
  [ -r "${libFnc}/${f}.sh.inc" ] || panic_exit "${f}"
  source "${libFnc}/${f}.sh.inc"
done


###
### Local variables
###
if [ "${_THIS_DB_HOST}" = "FQDN" ]; then
  _THIS_DB_HOST=$(uname -n 2>&1)
fi
_DIST_INSTALL=NO
_STATUS=INIT
_LOCAL_STATUS="${_STATUS}"
_ROOT="/data/disk/${_USER}"
_HM_ROOT="${_ROOT}/aegir/distro/${_HM_DISTRO}"
_DISTRO_ROOT="${_ROOT}/distro/${_DISTRO}"
_PREV_HM_ROOT="${_ROOT}/aegir/distro/${_LAST_HMR}"
_D="/data/all"
_SRCDIR="/opt/tmp/files"
_LOG="/var/backups/octopus-${_USER}-${_NOW}.log"
if [ "${_PHP_CLI_VERSION}" = "7.0" ] \
  && [ -x "/opt/php70/bin/php" ]; then
  _T_CLI=/opt/php70/bin
elif [ "${_PHP_CLI_VERSION}" = "5.6" ] \
  && [ -x "/opt/php56/bin/php" ]; then
  _T_CLI=/opt/php56/bin
elif [ "${_PHP_CLI_VERSION}" = "5.5" ] \
  && [ -x "/opt/php55/bin/php" ]; then
  _T_CLI=/opt/php55/bin
elif [ "${_PHP_CLI_VERSION}" = "5.4" ] \
  && [ -x "/opt/php54/bin/php" ]; then
  _T_CLI=/opt/php54/bin
elif [ "${_PHP_CLI_VERSION}" = "5.3" ] \
  && [ -x "/opt/php53/bin/php" ]; then
  _T_CLI=/opt/php53/bin
fi
if [ -e "/opt/tools/d7.ini" ] \
  && [ -e "/opt/tools/drush/7/drush/drush.php" ]; then
  _DRUSHCMD="${_T_CLI}/php /opt/tools/drush/7/drush/drush.php"
else
  _DRUSHCMD="${_T_CLI}/php ${_ROOT}/tools/drush/drush.php"
fi
PATH=${_T_CLI}:/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin
SHELL=/bin/bash


###
### Status check and update on the fly
###
if [ -e "${_ROOT}/aegir.sh" ]; then
  _STATUS=UPGRADE
  cd ${_ROOT}
fi


###
### User check
###
if [ `whoami` = "root" ]; then
  msg "${_STATUS} B: FATAL ERROR: This script should be ran as a non-root user"
  msg "${_STATUS} B: FATAL ERROR: Aborting AegirSetupB installer NOW!"
  touch /opt/tmp/status-AegirSetupB-FAIL
  exit 1
else
  if [ "${_DEBUG_MODE}" = "YES" ]; then
    msg "${_STATUS} B: Aegir automated install script part B"
  fi
fi


###
### Run all child B procedures
###
satellite_child_b_prepare_dirs_permissions
satellite_child_b_install_drush
satellite_child_b_drush_xts_cleanup
satellite_child_b_drush_xts_install
satellite_child_b_drush_test
satellite_child_b_aegir_build
satellite_child_b_aegir_health_check
satellite_child_b_letsencrypt
satellite_child_b_aegir_ui_enhance
satellite_child_b_vhosts_hotfix
satellite_child_b_symlink_global_inc
satellite_child_b_redis_enable_finalize


###----------------------------------------###
###
###  Octopus Aegir Installer
###  Copyright (C) 2010-2016 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###----------------------------------------###

#!/bin/dash
### BEGIN INIT INFO
# Provides:          unbound
# Required-Start:    $network $local_fs $remote_fs
# Required-Stop:     $network $local_fs $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: DNS resolver and recursive DNS server
# Description:       Unbound DNS resolver
### END INIT INFO

# Configuration
DAEMON="/usr/sbin/unbound"
CONFIG="/etc/unbound/unbound.conf.d/unbound.conf"
PIDFILE="/run/unbound/unbound.pid"
CTLFILE="/run/unbound/unbound.ctl"
DAEMON_OPTS="-c $CONFIG"

# Check if Unbound is running
is_running() {
    [ -f "$PIDFILE" ] && ps -p "$(cat $PIDFILE)" > /dev/null 2>&1
}

# Start Unbound
do_start() {
    if is_running; then
        echo "Unbound is already running."
        return 1
    fi

    echo "Starting Unbound..."
    $DAEMON $DAEMON_OPTS &
    sleep 2

    if is_running; then
        echo "Unbound started successfully."
    else
        echo "Failed to start Unbound."
        return 1
    fi
}

# Stop Unbound
do_stop() {
    if ! is_running; then
        echo "Unbound is not running."
        return 1
    fi

    echo "Stopping Unbound..."
    kill "$(cat $PIDFILE)"
    sleep 2

    if is_running; then
        echo "Failed to stop Unbound."
        return 1
    else
        echo "Unbound stopped successfully."
        rm -f $PIDFILE $CTLFILE
    fi
}

# Restart Unbound
do_restart() {
    do_stop
    do_start
}

# Status of Unbound
do_status() {
    if is_running; then
        echo "Unbound is running (PID $(cat $PIDFILE))."
    else
        echo "Unbound is not running."
        return 1
    fi
}

# Main logic
case "$1" in
    start)
        do_start
        ;;
    stop)
        do_stop
        ;;
    restart)
        do_restart
        ;;
    status)
        do_status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

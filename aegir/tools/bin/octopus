#!/bin/bash

HOME=/root
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/local/sbin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin

export PATH=${PATH}
export SHELL=${SHELL}
export HOME=${HOME}

_TODAY=$(date +%y%m%d 2>&1)
export _TODAY=${_TODAY//[^0-9]/}

_NOW=$(date +%y%m%d-%H%M%S 2>&1)
export _NOW=${_NOW//[^0-9-]/}

barCnf="/root/.barracuda.cnf"
barName="BARRACUDA.sh.txt"
bldPth="/opt/tmp/boa"
crlGet="-L --max-redirs 10 -k -s --retry 10 --retry-delay 5 -A iCab"
aptYesUnth="-y --allow-unauthenticated"
filIncB="barracuda.sh.cnf"
filIncO="octopus.sh.cnf"
gCb="git clone --branch"
octName="OCTOPUS.sh.txt"
pthIncB="lib/settings/${filIncB}"
pthIncO="lib/settings/${filIncO}"
rgUrl="https://raw.githubusercontent.com/omega8cc/boa"
vBs="/var/backups"

_CHECK_HOST=$(uname -n 2>&1)
_LOG_DIR="${vBs}/reports/up/$(basename "$0")/${_TODAY}"
_VMFAMILY=XEN
_VM_TEST=$(uname -a 2>&1)
if [[ "${_VM_TEST}" =~ "-beng" ]]; then
  _VMFAMILY="VS"
fi

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi

clean_pid_exit() {
  echo "REASON ${e} on $(date 2>&1)" >> /root/.octopus.exit.exceptions.log
  [ -e "/run/boa_wait.pid" ] && rm -f /run/boa_wait.pid
  [ -e "/run/boa_run.pid" ] && rm -f /run/boa_run.pid
  [ -e "/tmp/aegir_backup_mode.txt" ] && rm -f /tmp/aegir_backup_mode.txt
  service cron start &> /dev/null
  exit 1
}

os_detection_minimal() {
  _APT_UPDATE="apt-get update"
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  _OS_LIST="daedalus chimaera beowulf buster bullseye bookworm"
  for e in ${_OS_LIST}; do
    if [ "${e}" = "${_OS_CODE}" ]; then
      _APT_UPDATE="apt-get update --allow-releaseinfo-change"
    fi
  done
}

apt_clean_update() {
  #apt-get clean -qq 2> /dev/null
  #rm -rf /var/lib/apt/lists/* &> /dev/null
  ${_APT_UPDATE} -qq 2> /dev/null
}

_CHECK_HOST=$(uname -n 2>&1)
if_hosted_sys() {
  if [ -e "/root/.host8.cnf" ] \
    || [[ "${_CHECK_HOST}" =~ ".aegir.cc"($) ]]; then
    hostedSys=YES
  else
    hostedSys=NO
  fi
}

check_sql_running() {
  while [ -z "${_IS_MYSQLD_RUNNING}" ] \
    || [ ! -e "/run/mysqld/mysqld.sock" ]; do
    _IS_MYSQLD_RUNNING=$(ps aux | grep '[m]ysqld' | awk '{print $2}' 2>&1)
    echo "INFO: Waiting for MySQLD availability..."
    sleep 3
  done
}

check_sql_access() {
  if [ -e "/root/.my.pass.txt" ] && [ -e "/root/.my.cnf" ]; then
    _SQL_PSWD=$(cat /root/.my.pass.txt 2>&1)
    _SQL_PSWD=$(echo -n ${_SQL_PSWD} | tr -d "\n" 2>&1)
    _IS_SYNC_SQL_PSWD=$(grep "${_SQL_PSWD}" /root/.my.cnf 2>&1)
  else
    echo "ALERT: /root/.my.cnf or /root/.my.pass.txt not found."
    echo "ALERT: Please fix this before trying again, giving up."
    echo "Bye"
    echo " "
    clean_pid_exit check_sql_access_a
  fi
  if [ -z "${_IS_SYNC_SQL_PSWD}" ] \
    || [[ ! "${_IS_SYNC_SQL_PSWD}" =~ "password=${_SQL_PSWD}" ]]; then
    echo "ALERT: SQL password is out of sync between"
    echo "ALERT: /root/.my.cnf and /root/.my.pass.txt"
    echo "ALERT: Please fix this before trying again, giving up."
    echo "Bye"
    echo " "
    clean_pid_exit check_sql_access_b
  else
    _IS_MYSQLD_RUNNING=$(ps aux | grep '[m]ysqld' | awk '{print $2}' 2>&1)
    if [ -z "${_IS_MYSQLD_RUNNING}" ]; then
      echo "ALERT: SQL server on this system is not running at all."
      echo "ALERT: Please fix this before trying again, giving up."
      echo "Bye"
      echo " "
      clean_pid_exit check_sql_access_c
    else
      _MYSQL_CONN_TEST=$(mysql -u root -e "status" 2>&1)
      if [ -z "${_MYSQL_CONN_TEST}" ] \
        || [[ "${_MYSQL_CONN_TEST}" =~ "Access denied" ]]; then
        echo "ALERT: SQL password in /root/.my.cnf does not work."
        echo "ALERT: Please fix this before trying again, giving up."
        echo "Bye"
        echo " "
        clean_pid_exit check_sql_access_d
      fi
    fi
  fi
}

fix_dns_settings() {
  mkdir -p ${vBs}
  rm -f ${vBs}/resolv.conf.tmp
  if [ -e "/etc/resolv.conf" ]; then
    if [ -L "/etc/resolv.conf" ]; then
      rslvT=`readlink -n /etc/resolv.conf`
      if [ ! -e "${rslvT}" ]; then
        rm -f /etc/resolv.conf
      fi
    fi
    if [ -e "/etc/resolv.conf" ]; then
      cp -a /etc/resolv.conf ${vBs}/resolv.conf.tmp
    fi
  fi
  if [ ! -e "${vBs}/resolv.conf.tmp" ]; then
    echo "nameserver 127.0.0.1" > ${vBs}/resolv.conf.tmp
    echo "nameserver 1.1.1.1" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 1.0.0.1" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 8.8.8.8" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 8.8.4.4" >> ${vBs}/resolv.conf.tmp
  fi
  if [ ! -e "${vBs}/resolv.conf.vanilla" ] \
    && [ -e "${vBs}/resolv.conf.tmp" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp ${vBs}/resolv.conf.vanilla
    fi
  fi
  sed -i "/^$/d" ${vBs}/resolv.conf.vanilla &> /dev/null
  if [ -e "${vBs}/resolv.conf.vanilla" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.vanilla /etc/resolv.conf
    fi
  else
    if [ -e "${vBs}/resolv.conf.tmp" ] \
      && [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
    fi
  fi
}

check_dns_settings() {
  if [ -e "/root/.use.default.nameservers.cnf" ]; then
    _USE_DEFAULT_DNS=YES
  fi
  if [ -e "/root/.use.local.nameservers.cnf" ]; then
    _USE_PROVIDER_DNS=YES
  else
    _REMOTE_DNS_TEST=$(host files.aegir.cc 1.1.1.1 -w 10 2>&1)
  fi
  if [[ "${_REMOTE_DNS_TEST}" =~ "no servers could be reached" ]] \
    || [[ "${_REMOTE_DNS_TEST}" =~ "Host files.aegir.cc not found" ]] \
    || [ "${_USE_DEFAULT_DNS}" = "YES" ] \
    || [ "${_USE_PROVIDER_DNS}" = "YES" ]; then
    if [ "${_USE_DEFAULT_DNS}" = "YES" ] \
      || [ "${_USE_PROVIDER_DNS}" = "YES" ] \
      || [ ! -e "${vBs}/resolv.conf.vanilla" ]; then
      fix_dns_settings
      if [ -e "/etc/init.d/postfix" ]; then
        service postfix restart &> /dev/null
      fi
    fi
  fi
}

extract_archive() {
  if [ ! -z "$1" ]; then
    case $1 in
      *.tar.bz2)   tar xjf $1    ;;
      *.tar.gz)    tar xzf $1    ;;
      *.tar.xz)    tar xvf $1    ;;
      *.bz2)       bunzip2 $1    ;;
      *.rar)       unrar x $1    ;;
      *.gz)        gunzip -q $1  ;;
      *.tar)       tar xf $1     ;;
      *.tbz2)      tar xjf $1    ;;
      *.tgz)       tar xzf $1    ;;
      *.zip)       unzip -qq $1  ;;
      *.Z)         uncompress $1 ;;
      *.7z)        7z x $1       ;;
      *)           echo "'$1' cannot be extracted via >extract<" ;;
    esac
    rm -f $1
  fi
}

get_dev_ext() {
  if [ ! -z "$1" ]; then
    curl ${crlGet} "${urlDev}/DEV/$1" -o "$1"
    if [ -e "$1" ]; then
      extract_archive "$1"
    else
      echo "OOPS: $1 failed download from ${urlDev}/DEV/$1"
    fi
  fi
}

send_report() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    if_hosted_sys
    if [ "${hostedSys}" = "YES" ]; then
      _MY_EMAIL="$(basename "$0")@omega8.cc"
    fi
    if [ ! -z "${_MY_EMAIL}" ]; then
      repSub="Successful Octopus upgrade for ${octUsr}"
      repSub="REPORT: ${repSub} on ${_CHECK_HOST}"
      repSub=$(echo -n ${repSub} | fmt -su -w 2500 2>&1)
      cat ${_UP_LOG} | s-nail -s "${repSub} at ${_NOW}" ${_MY_EMAIL}
      echo "${repSub} sent to ${_MY_EMAIL}"
    fi
  fi
}

send_alert() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    if_hosted_sys
    if [ "${hostedSys}" = "YES" ]; then
      _MY_EMAIL="$(basename "$0")@omega8.cc"
    fi
    if [ ! -z "${_MY_EMAIL}" ]; then
      repSub="ALERT: Failed Octopus upgrade for ${octUsr} on ${_CHECK_HOST}"
      repSub=$(echo -n ${repSub} | fmt -su -w 2500 2>&1)
      cat ${_UP_LOG} | s-nail -s "${repSub} at ${_NOW}" ${_MY_EMAIL}
      echo "${repSub} sent to ${_MY_EMAIL}"
    fi
  fi
}

check_report() {
  _SEND_ALERT=NO
  _RESULT_ALRT=$(grep "ALRT" ${_UP_LOG} 2>&1)
  _RESULT_FATAL=$(grep "FATAL ERROR" ${_UP_LOG} 2>&1)
  _RESULT_ALREADY=$(grep "This Aegir Instance is already up" ${_UP_LOG} 2>&1)
  _RESULT_BYE=$(grep "BYE" ${_UP_LOG} 2>&1)
  if [[ "${_RESULT_ALRT}" =~ "ALRT" ]] \
    || [[ "${_RESULT_ALRT}" =~ "binary file matches" ]]; then
    _SEND_ALERT=YES
  fi
  if [[ "${_RESULT_FATAL}" =~ "FATAL ERROR" ]] \
    || [[ "${_RESULT_FATAL}" =~ "binary file matches" ]]; then
    _SEND_ALERT=YES
  fi
  if [[ "${_RESULT_ALREADY}" =~ "This Aegir Instance is already up" ]] \
    || [[ "${_RESULT_ALREADY}" =~ "binary file matches" ]]; then
    _SEND_ALERT=NO
  fi
  if [[ "${_RESULT_BYE}" =~ "BYE" ]] \
    || [[ "${_RESULT_BYE}" =~ "binary file matches" ]]; then
    _SEND_ALERT=NO
  else
    _SEND_ALERT=YES
  fi
  if [ "${_SEND_ALERT}" = "YES" ]; then
    send_alert
  else
    send_report
  fi
}

php_cli_local_ini_update() {
  _U_HD="${User}/.drush"
  _U_TP="${User}/.tmp"
  _U_II="${_U_HD}/php.ini"
  chattr -i -R ${_U_HD}/ &> /dev/null
  if [ ! -e "${_U_II}" ] \
    || [ ! -d "${_U_TP}" ]; then
    mkdir -p ${_U_TP}
    touch ${_U_TP}
    find ${_U_TP}/ -mtime +0 -exec rm -rf {} \; &> /dev/null
    mkdir -p ${_U_HD}
    chown ${_USER}:${usrGroup} ${_U_TP}
    chown ${_USER}:${usrGroup} ${_U_HD}
    chmod 755 ${_U_TP}
    chmod 755 ${_U_HD}
    chattr -i ${_U_II} &> /dev/null
    rm -f ${_U_HD}/.ctrl.php*
    rm -f ${_U_II}
    cp -af /opt/php74/lib/php.ini ${_U_II}
    if [ -e "${_U_II}" ]; then
      _INI="open_basedir = \".: \
        /data/all:           \
        /data/conf:          \
        /data/disk/all:      \
        /opt/php74:          \
        /dev/urandom:        \
        /opt/tmp/make_local: \
        /opt/tools/drush:    \
        ${User}:             \
        /usr/local/bin:      \
        /usr/bin\""
      _INI=$(echo "${_INI}" | sed "s/ //g" 2>&1)
      _INI=$(echo "${_INI}" | sed "s/open_basedir=/open_basedir = /g" 2>&1)
      _INI=${_INI//\//\\\/}
      _QTP=${_U_TP//\//\\\/}
      sed -i "s/.*open_basedir =.*/${_INI}/g"                              ${_U_II}
      wait
      sed -i "s/.*error_reporting =.*/error_reporting = 1/g"               ${_U_II}
      wait
      sed -i "s/.*session.save_path =.*/session.save_path = ${_QTP}/g"     ${_U_II}
      wait
      sed -i "s/.*soap.wsdl_cache_dir =.*/soap.wsdl_cache_dir = ${_QTP}/g" ${_U_II}
      wait
      sed -i "s/.*sys_temp_dir =.*/sys_temp_dir = ${_QTP}/g"               ${_U_II}
      wait
      sed -i "s/.*upload_tmp_dir =.*/upload_tmp_dir = ${_QTP}/g"           ${_U_II}
    fi
  fi
}

php_cli_drush_update() {
  usrGroup=users
  _DRUSH_FILE="${User}/tools/drush/drush.php"
  if [ -x "/opt/php74/bin/php" ]; then
    sed -i "s/^#\!\/.*/#\!\/opt\/php74\/bin\/php/g" ${_DRUSH_FILE} &> /dev/null
    _T_CLI=/opt/php74/bin
  fi
  if [ -x "${_T_CLI}/php" ]; then
    #_DRUSH_HOSTING_TASKS_CMD="/usr/bin/drush @hostmaster hosting-tasks --force"
    _DRUSH_HOSTING_DISPATCH_CMD="${_T_CLI}/php ${User}/tools/drush/drush.php @hostmaster hosting-dispatch"
    if [ -e "${User}/aegir.sh" ]; then
      rm -f ${User}/aegir.sh
    fi
    touch ${User}/aegir.sh
    echo -e \
      "#!/bin/bash\n\nPATH=.:${_T_CLI}:/usr/sbin:/usr/bin:/sbin:/bin\n \
       \n${_DRUSH_HOSTING_DISPATCH_CMD} \
       \ntouch ${User}/${_USER}-task.done" \
      | fmt -su -w 2500 | tee -a ${User}/aegir.sh >/dev/null 2>&1
    chown ${_USER}:${usrGroup} ${User}/aegir.sh &> /dev/null
    chmod 0700 ${User}/aegir.sh &> /dev/null
  fi
}

up_mode() {
  if [ "${mcmode}" = "aegir" ]; then
    sed -i "s/^_HM_ONLY=NO/_HM_ONLY=YES/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=NO/_HM_ONLY=YES/g"                     ${vBs}/${tocIncO}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${vBs}/${tocIncO}
    wait
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  elif [ "${mcmode}" = "platforms" ]; then
    sed -i "s/^_PLATFORMS_ONLY=NO/_PLATFORMS_ONLY=YES/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=NO/_PLATFORMS_ONLY=YES/g"       ${vBs}/${tocIncO}
    wait
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${vBs}/${tocIncO}
    wait
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  elif [ "${mcmode}" = "both" ] || [ "${mcmode}" = "force" ]; then
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${vBs}/${tocIncO}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${vBs}/${tocIncO}
    wait
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  else
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${vBs}/${tocIncO}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${vBs}/${tocIncO}
    wait
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  fi
}

satellite_check_strict_php_cli() {
  _PHP_CLI=$(grep "/opt/php" ${User}/tools/drush/drush.php 2>&1)
  if [ "${_OS_CODE}" != "stretch" ] && [ "${_OS_CODE}" != "jessie" ]; then
    if [[ ! "${_PHP_CLI}" =~ "php81" ]] && [ -x "/opt/php81/bin/php" ]; then
      echo
      echo "NOTE: This Aegir version requires PHP 8.1 during Hostmaster upgrade."
      echo "NOTE: It will be reconfigured on the fly now, but you can change it"
      echo "NOTE: later for hosted sites management in ~/static/control/cli.info"
      echo
      php_cli_drush_update
      php_cli_local_ini_update
      echo 8.1 > ${User}/log/cli.txt
      echo 8.1 > ${User}/static/control/cli.info
      chown -R ${octUsr}.ftp:users ${User}/static/control
      sed -i "s/^_PHP_CLI_VERSION=.*/_PHP_CLI_VERSION=8.1/g" \
        /root/.${octUsr}.octopus.cnf &> /dev/null
    fi
  fi
}

satellite_downgrade_protection() {
  User="/data/disk/${second}"
  octUsr="${second}"
  if [ -e "${User}/log/octopus_log.txt" ] \
    && [ "${cmmand}" = "up-lts" ]; then
    _SERIES_TEST=$(cat ${User}/log/octopus_log.txt 2>&1)
    if [[ "${_SERIES_TEST}" =~ "Octopus ${rlsn}-pro" ]]; then
      echo
      echo "ERROR: Your Octopus has been already upgraded to ${rlsn}-pro"
      echo "You can not downgrade back to previous/older/lts BOA version"
      echo "Please use 'octopus up-pro ${octUsr} force' to upgrade"
      echo "Bye"
      echo
      clean_pid_exit satellite_downgrade_protection_a
    elif [[ "${_SERIES_TEST}" =~ "Octopus ${rlsn}-dev" ]]; then
      echo
      echo "ERROR: Your Octopus has been already upgraded to ${rlsn}-dev"
      echo "You can not downgrade back to previous/older/lts BOA version"
      echo "Please use 'octopus up-dev ${octUsr} force' to upgrade"
      echo "Bye"
      echo
      clean_pid_exit satellite_downgrade_protection_b
    fi
  fi
  if [ -e "${User}/log/octopus_log.txt" ] \
    && [ "${cmmand}" != "up-dev" ] \
    && [ "${cmmand}" != "up-pro" ] \
    && [ "${cmmand}" != "up-lts" ] \
    && [ "${cmmand}" != "info" ] \
    && [ "${cmmand}" != "help" ]; then
    _SERIES_TEST=$(cat ${User}/log/octopus_log.txt 2>&1)
    _BOA_SERIES_TEST=$(cat /var/log/barracuda_log.txt 2>&1)
    if [[ "${_SERIES_TEST}" =~ "Octopus ${rlsn}" ]] \
      || [[ "${_BOA_SERIES_TEST}" =~ "Barracuda ${rlsn}" ]]; then
      echo
      echo "ERROR: Your system has been already upgraded to ${rlsn}"
      echo "You can not downgrade back to previous/older BOA version"
      echo "Please use 'octopus up-lts/pro/dev ${octUsr} force' to upgrade"
      echo "Display all supported commands with: $(basename "$0") help"
      echo "Bye"
      echo
      clean_pid_exit satellite_downgrade_protection_c
    fi
  fi
}

satellite_check_supported_php_cli() {
  if [ "${cmmand}" = "up-${tRee}" ]; then
    fmodey=
    _SERIES_TEST=
    _PHP_FPM_LEGACY_FREE=
    _PHP_CLI_LEGACY_FREE=
    mcmode="${orgMcmode}"
    if [ -e "${User}/log/octopus_log.txt" ]; then
      _SERIES_TEST=$(cat ${User}/log/octopus_log.txt 2>&1)
      if [[ "${_SERIES_TEST}" =~ "BOA-5." ]] \
        || [[ "${_SERIES_TEST}" =~ "BOA-4." ]]; then
        if [ -e "${User}/static/control/cli.info" ]; then
          _T_CLI_VRN=$(cat ${User}/static/control/cli.info 2>&1)
          _T_CLI_VRN=${_T_CLI_VRN//[^0-9.]/}
          _T_CLI_VRN=$(echo -n ${_T_CLI_VRN} | tr -d "\n" 2>&1)
          if [ "${_T_CLI_VRN}" = "8.3" ] \
            || [ "${_T_CLI_VRN}" = "8.2" ] \
            || [ "${_T_CLI_VRN}" = "8.1" ] \
            || [ "${_T_CLI_VRN}" = "7.4" ]; then
            _PHP_CLI_LEGACY_FREE=YES
          else
            _PHP_CLI_LEGACY_FREE=NO
          fi
        else
          _PHP_CLI_LEGACY_FREE=YES
        fi
        if [ "${_PHP_CLI_LEGACY_FREE}" = "NO" ]; then
          if [ -x "/opt/php74/bin/php" ]; then
            echo 7.4 > ${User}/static/control/cli.info
          fi
        fi
        chown -R ${octUsr}.ftp:users ${User}/static/control
      fi
      if [[ "${_SERIES_TEST}" =~ "${rlse}" ]]; then
        if [ "${orgMcmode}" != "force" ]; then
          mcmode=
          fmodey=force
          if [ ! -e "/root/.silent-octopus-upgrade.cnf" ]; then
            echo
            echo "This Aegir Instance ${octUsr} is already up to date!"
            echo "If you wish to run/force the upgrade again,"
            echo "please use the forced upgrade mode, as shown below"
            echo
            echo "Usage: $(basename "$0") ${orgCmmand} ${second} force"
            echo
          fi
        fi
      fi
    fi
  fi
  _SERIES_TEST=
}

up_one() {
  if [ -e "${vBs}/${octName}" ]; then
    if [ "${cmmand}" = "up-${tRee}" ]; then
      satellite_check_supported_php_cli
    else
      _dis_strict=YES
      ### satellite_check_strict_php_cli
    fi
    if [ "${cmmand}" = "up-dev" ] \
      || [ "${cmmand}" = "up-pro" ] \
      || [ "${cmmand}" = "up-lts" ]; then
      sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${brnch}/g"        ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${tRee}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${tRee}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_X_VERSION=.*/_X_VERSION=${rlse}/g"           ${vBs}/${tocIncO}
      wait
    else
      sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${brnch}/g"        ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${tRee}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${rlse}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_X_VERSION=.*/_X_VERSION=${rlse}/g"           ${vBs}/${tocIncO}
      wait
    fi
    if [ "${cmmand}" = "up-dev" ] \
      || [ "${cmmand}" = "up-pro" ] \
      || [ "${cmmand}" = "up-lts" ]; then
      sed -i "s/^_BRANCH_BOA=.*/_BRANCH_BOA=${brnch}/g"        ${vBs}/${tocIncO}
      wait
    fi
    sed -i "s/^_AUTOPILOT=NO/_AUTOPILOT=YES/g"                 ${vBs}/${tocIncO}
    wait
    sed -i "s/^_DNS_SETUP_TEST=YES/_DNS_SETUP_TEST=NO/g"       ${vBs}/${tocIncO}
    wait
    sed -i "s/^_USER=o1/_USER=${octUsr}/g"                     ${vBs}/${tocName}
    wait
    sed -i "s/^_STRONG_PASSW.*/_STRONG_PASSWORDS=YES/g"        ${vBs}/${tocIncO}
    wait
    sed -i "s/^_PLATFORMS_LIST.*/_PLATFORMS_LIST=none/g"       ${vBs}/${tocIncO}
    wait
    sed -i "s/^_PLATFORMS_LIST=.*/_PLATFORMS_LIST=none/g"      ${octCnf}
    wait
    sed -i "s/^_AUTOPILOT=NO/_AUTOPILOT=YES/g"                 ${octCnf}
    wait
    sed -i "s/^_DNS_SETUP_TEST=YES/_DNS_SETUP_TEST=NO/g"       ${octCnf}
    wait
    sed -i "s/^_STRONG_PASSW.*/_STRONG_PASSWORDS=YES/g"        ${octCnf}
    wait

    if [ -e "${vBs}/${tocName}" ]; then
      if [ -e "${User}/.drush/sys/provision/http" ]; then
        _IS_OLD=$(find ${User}/.drush/sys/provision/ \
          -maxdepth 1 -mindepth 1 -mtime +0 -type d | grep example)
      elif [ -e "${User}/.drush/provision" ]; then
        _IS_OLD=$(find ${User}/.drush/provision/ \
          -maxdepth 1 -mindepth 1 -mtime +0 -type d | grep example)
      fi
      if [ -e "${User}/.drush/.ctrl.${_X_SE}.pid" ]; then
        _IS_OLD=
      else
        _IS_OLD=OLD
      fi
      if [ -z "${_IS_OLD}" ] \
        && [ -z "${mcmode}" ] \
        && [ -e "${User}/.drush/sys/provision/http" ]; then
        if [ -z "${fmodey}" ]; then
          echo
          echo "This Aegir Instance is already up to date!"
          echo "If you wish to run/force the upgrade again,"
          echo "please specify desired upgrade mode:"
          echo "aegir, platforms or both - as shown below"
          echo
          echo "Usage: $(basename "$0") ${cmmand} ${second} {aegir|platforms|both}"
          echo
        fi
      else
        if [ -e "${User}/.drush/sys/provision/http" ]; then
          up_mode
        elif [ -e "${User}/.drush/provision" ]; then
          up_mode
        else
          echo "${User}/.drush/sys/provision does not exist!"
          rm -rf ${User}/.drush/{sys,xts,usr}
          rm -rf ${User}/.drush/{provision,drush_make}
          mkdir -p ${User}/.drush/{sys,xts,usr}
          ${gCb} ${branch} ${gitHub}/provision.git \
            ${User}/.drush/sys/provision &> /dev/null
          chown -R ${octUsr}:users ${User}/.drush/sys
          up_mode
        fi
      fi
    else
      echo "${vBs}/${tocName} installer not available - try again"
      clean_pid_exit up_one_a
    fi
  fi
}

count_cpu() {
  _CPU_INFO=$(grep -c processor /proc/cpuinfo 2>&1)
  _CPU_INFO=${_CPU_INFO//[^0-9]/}
  _NPROC_TEST=$(which nproc 2>&1)
  if [ -z "${_NPROC_TEST}" ]; then
    _CPU_NR="${_CPU_INFO}"
  else
    _CPU_NR=$(nproc 2>&1)
  fi
  _CPU_NR=${_CPU_NR//[^0-9]/}
  if [ ! -z "${_CPU_NR}" ] \
    && [ ! -z "${_CPU_INFO}" ] \
    && [ "${_CPU_NR}" -gt "${_CPU_INFO}" ] \
    && [ "${_CPU_INFO}" -gt "0" ]; then
    _CPU_NR="${_CPU_INFO}"
  fi
  if [ -z "${_CPU_NR}" ] || [ "${_CPU_NR}" -lt "1" ]; then
    _CPU_NR=1
  fi
}

load_control() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    _CPU_MAX_RATIO=${_CPU_MAX_RATIO//[^0-9]/}
  fi
  if [ -z "${_CPU_MAX_RATIO}" ]; then
    _CPU_MAX_RATIO=6
  fi
  _O_LOAD=$(awk '{print $1*100}' /proc/loadavg 2>&1)
  _O_LOAD=$(( _O_LOAD / _CPU_NR ))
  _O_LOAD_MAX=$(( 100 * _CPU_MAX_RATIO ))
}

up_action_all() {
  for User in `find /data/disk/ -maxdepth 1 -mindepth 1 | sort`; do
    count_cpu
    load_control
    if [ -d "${User}/config/server_master/nginx/vhost.d" ] \
      && [ -e "${User}/log/cores.txt" ] \
      && [ ! -e "${User}/log/CANCELLED" ]; then
      if [ "${_O_LOAD}" -lt "${_O_LOAD_MAX}" ]; then
        octUsr=$(echo ${User} | cut -d'/' -f4 | awk '{ print $1}')
        tocName="${octName}.${octUsr}"
        tocIncO="${filIncO}.${octUsr}"
        if [ -e "${vBs}/${octName}" ]; then
          cp -af ${vBs}/${octName} ${vBs}/${tocName}
        fi
        if [ -e "${vBs}/${filIncO}" ]; then
          cp -af ${vBs}/${filIncO} ${vBs}/${tocIncO}
        fi
        octCnf="/root/.${octUsr}.octopus.cnf"
        echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
        echo Octopus upgrade for User ${User}
        n=$((RANDOM%9+2))
        echo Waiting $n seconds...
        sleep $n

        ### Enable debugging if requested
        if [ -e "/root/.debug-boa-installer.cnf" ] \
          || [ -e "/root/.debug-octopus-installer.cnf" ]; then
          sed -i "s/^_DEBUG_MODE=.*/_DEBUG_MODE=YES/g"         ${vBs}/${tocIncO}
          wait
          sed -i "s/^_DEBUG_MODE=.*/_DEBUG_MODE=YES/g"         ${octCnf}
          wait
        fi

        if [ "${silent}" = "log" ]; then
          _UP_LOG="${_LOG_DIR}/$(basename "$0")-up-${octUsr}-${_NOW}.log"
          echo
          echo "Preparing the upgrade in silent mode..."
          echo
          echo "NOTE: There will be no progress displayed in the console"
          echo "but you will receive an email once the upgrade is complete"
          echo
          sleep 5
          echo "You could watch the progress in another window with command:"
          echo "  tail -f ${_UP_LOG}"
          echo "or wait until you will see the line: OCTOPUS upgrade completed"
          echo
          echo "Starting the upgrade in silent mode now..."
          echo
          if [ -e "${vBs}/${octName}" ]; then
            sed -i "s/^_SPINNER=YES/_SPINNER=NO/g"             ${vBs}/${octName}
            wait
            sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"         ${vBs}/${tocIncO}
            wait
            sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"         ${octCnf}
            wait
          fi
          up_one >>${_UP_LOG} 2>&1
          check_report
        else
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=NO/g"            ${octCnf}
          wait
          up_one
        fi
        n=$((RANDOM%9+2))
        echo "Waiting $n seconds..."
        sleep $n
        rm -f ${vBs}/${tocName}
        rm -f ${vBs}/${tocIncO}
        rm -rf ${User}/.tmp/cache
        echo "Done for ${User}"
      else
        echo "load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}"
        echo "...we have to wait..."
      fi
    fi
  done
}

up_action_one() {
  User="/data/disk/${second}"
  count_cpu
  load_control
  if [ -d "${User}/config/server_master/nginx/vhost.d" ] \
    && [ -e "${User}/log/cores.txt" ] \
    && [ ! -e "${User}/log/CANCELLED" ]; then
    if [ "${_O_LOAD}" -lt "${_O_LOAD_MAX}" ]; then
      octUsr="${second}"
      tocName="${octName}.${octUsr}"
      tocIncO="${filIncO}.${octUsr}"
      if [ -e "${vBs}/${octName}" ]; then
        cp -af ${vBs}/${octName} ${vBs}/${tocName}
      fi
      if [ -e "${vBs}/${filIncO}" ]; then
        cp -af ${vBs}/${filIncO} ${vBs}/${tocIncO}
      fi
      octCnf="/root/.${octUsr}.octopus.cnf"
      echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
      echo Octopus upgrade for User ${User}
      n=$((RANDOM%9+2))

      ### Enable debugging if requested
      if [ -e "/root/.debug-boa-installer.cnf" ] \
        || [ -e "/root/.debug-octopus-installer.cnf" ]; then
        sed -i "s/^_DEBUG_MODE=.*/_DEBUG_MODE=YES/g"           ${vBs}/${tocIncO}
        wait
        sed -i "s/^_DEBUG_MODE=.*/_DEBUG_MODE=YES/g"           ${octCnf}
        wait
      fi

      if [ "${silent}" = "log" ]; then
        _UP_LOG="${_LOG_DIR}/$(basename "$0")-up-${octUsr}-${_NOW}.log"
        echo
        echo "Preparing the upgrade in silent mode..."
        echo
        echo "NOTE: There will be no progress displayed in the console"
        echo "but you will receive an email once the upgrade is complete"
        echo
        sleep $n
        echo "You could watch the progress in another window with command:"
        echo "  tail -f ${_UP_LOG}"
        echo "or wait until you will see the line: OCTOPUS upgrade completed"
        echo
        echo "Starting the upgrade in silent mode now..."
        echo
        if [ -e "${vBs}/${octName}" ]; then
          sed -i "s/^_SPINNER=YES/_SPINNER=NO/g"               ${vBs}/${octName}
          wait
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"           ${vBs}/${tocIncO}
          wait
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"           ${octCnf}
          wait
        fi
        up_one >>${_UP_LOG} 2>&1
        check_report
      else
        sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=NO/g"              ${octCnf}
        wait
        up_one
      fi
      sleep 3
      rm -f ${vBs}/${tocName}
      rm -f ${vBs}/${tocIncO}
      rm -rf ${User}/.tmp/cache
      echo Done for ${User}
    else
      echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
      echo try again later
    fi
  fi
}

up_start() {
  if [ -e "/run/boa_run.pid" ]; then
    echo
    echo "  Another BOA installer is running probably"
    echo "  because /run/boa_run.pid exists"
    echo
    exit 1
  elif [ -e "/run/boa_wait.pid" ]; then
    echo
    echo "  Some important system task is running probably"
    echo "  because /run/boa_wait.pid exists"
    echo
    exit 1
  else
    touch /run/boa_run.pid
    touch /run/boa_wait.pid
    touch /run/octopus_install_run.pid
    [ -e "/tmp/aegir_backup_mode.txt" ] && rm -f /tmp/aegir_backup_mode.txt
    mkdir -p ${_LOG_DIR}
    cd ${vBs}
    rm -f ${vBs}/OCTOPUS.sh*
    ## rm -f ${vBs}/*.sh.cnf*
  fi
  if [ "${cmmode}" = "log" ]; then
    silent="${cmmode}"
  fi
  if [ ! -z "${cmmode}" ] && [ "${cmmode}" != "log" ]; then
    mcmode="${cmmode}"
    orgMcmode="${mcmode}"
  fi
  if [ -e "/opt/local/bin/php" ] || [ -e "/usr/local/bin/php" ]; then
    rm -f /opt/local/bin/php
    rm -f /usr/local/bin/php
  fi
  orgCmmand="${cmmand}"
}

up_finish() {
  rm -f /root/BOA.sh*
  [ -e "/run/boa_run.pid" ] && rm -f /run/boa_run.pid
  [ -e "/run/boa_wait.pid" ] && rm -f /run/boa_wait.pid
  [ -e "/run/manage_ltd_users.pid" ] && rm -f /run/manage_ltd_users.pid
  [ -e "/run/manage_ruby_users.pid" ] && rm -f /run/manage_ruby_users.pid
  [ -e "/run/octopus_install_run.pid" ] && rm -f /run/octopus_install_run.pid
  [ -e "/tmp/aegir_backup_mode.txt" ] && rm -f /tmp/aegir_backup_mode.txt
  rm -f ${vBs}/*.sh.cnf*
  rm -f ${vBs}/OCTOPUS.sh*
  if [ -e "/opt/local/bin/php" ] || [ -e "/usr/local/bin/php" ]; then
    rm -f /opt/local/bin/php
    rm -f /usr/local/bin/php
  fi
  rm -rf /opt/tmp/*
  echo
  echo OCTOPUS upgrade completed
  echo Bye
  echo
  exit 0
}

find_fast_mirror_early() {
  isNetc=$(which netcat 2>&1)
  if [ ! -x "${isNetc}" ] || [ -z "${isNetc}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install netcat ${aptYesUnth} 2> /dev/null
    apt-get install netcat-traditional ${aptYesUnth} 2> /dev/null
    wait
  fi
  ffMirr=$(which ffmirror 2>&1)
  if [ -x "${ffMirr}" ]; then
    ffList="/var/backups/boa-mirrors-2024-01.txt"
    mkdir -p /var/backups
    if [ ! -e "${ffList}" ]; then
      echo "de.files.aegir.cc"  > ${ffList}
      echo "ny.files.aegir.cc" >> ${ffList}
      echo "sg.files.aegir.cc" >> ${ffList}
    fi
    if [ -e "${ffList}" ]; then
      _BROKEN_FFMIRR_TEST=$(grep "stuff" ${ffMirr} 2>&1)
      if [[ "${_BROKEN_FFMIRR_TEST}" =~ "stuff" ]]; then
        _CHECK_MIRROR=$(bash ${ffMirr} < ${ffList} 2>&1)
        _USE_MIR="${_CHECK_MIRROR}"
        [[ "${_USE_MIR}" =~ "printf" ]] && _USE_MIR="files.aegir.cc"
      else
        _USE_MIR="files.aegir.cc"
      fi
    else
      _USE_MIR="files.aegir.cc"
    fi
  else
    _USE_MIR="files.aegir.cc"
  fi
  urlDev="http://${_USE_MIR}/dev"
  urlHmr="http://${_USE_MIR}/versions/${tRee}/boa/aegir"
}

if_reinstall_curl() {
  _CURL_VRN=8.9.1
  if ! command -v lsb_release &> /dev/null; then
    apt-get update -qq &> /dev/null
    apt-get install lsb-release -y -qq &> /dev/null
  fi
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  [ "${_OS_CODE}" = "jessie" ] && _CURL_VRN=7.71.1
  [ "${_OS_CODE}" = "stretch" ] && _CURL_VRN=8.2.1
  isCurl=$(curl --version 2>&1)
  if [[ ! "${isCurl}" =~ "OpenSSL" ]] || [ -z "${isCurl}" ]; then
    echo "OOPS: cURL is broken! Re-installing.."
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    echo "curl install" | dpkg --set-selections 2> /dev/null
    apt_clean_update
    apt-get remove libssl1.0-dev -y --purge --auto-remove -qq 2> /dev/null
    apt-get autoremove -y 2> /dev/null
    apt-get install libssl-dev -y -qq 2> /dev/null
    apt-get install libc-client2007e libc-client2007e-dev -y -qq 2> /dev/null
    apt-get build-dep curl -y 2> /dev/null
    if [ ! -e "/var/aegir/drush" ]; then
      apt-get install curl --reinstall -y -qq 2> /dev/null
    fi
    if [ -e "/var/aegir/drush" ]; then
      echo "INFO: Installing curl from sources..."
      mkdir -p /var/opt
      rm -rf /var/opt/curl*
      cd /var/opt
      wget -q -U iCab http://files.aegir.cc/dev/src/curl-${_CURL_VRN}.tar.gz &> /dev/null
      tar -xzf curl-${_CURL_VRN}.tar.gz &> /dev/null
      if [ -e "/root/.install.modern.openssl.cnf" ] \
        && [ -x "/usr/local/ssl3/bin/openssl" ]; then
        _SSL_BINARY=/usr/local/ssl3/bin/openssl
      else
        _SSL_BINARY=/usr/local/ssl/bin/openssl
      fi
      if [ -e "/usr/local/ssl3/lib64/libssl.so.3" ]; then
        _SSL_PATH="/usr/local/ssl3"
        _SSL_LIB_PATH="${_SSL_PATH}/lib64"
      else
        _SSL_PATH="/usr/local/ssl"
        _SSL_LIB_PATH="${_SSL_PATH}/lib"
      fi
      _PKG_CONFIG_PATH="${_SSL_LIB_PATH}/pkgconfig"

      if [ -e "${_PKG_CONFIG_PATH}" ] \
        && [ -e "/var/opt/curl-${_CURL_VRN}" ]; then
        cd /var/opt/curl-${_CURL_VRN}
        LIBS="-ldl -lpthread" PKG_CONFIG_PATH="${_PKG_CONFIG_PATH}" ./configure \
          --with-openssl \
          --with-zlib=/usr \
          --prefix=/usr/local &> /dev/null
        make -j $(nproc) --quiet &> /dev/null
        make --quiet install &> /dev/null
        ldconfig 2> /dev/null
      fi
    fi
    if [ -f "/usr/local/bin/curl" ]; then
      isCurl=$(/usr/local/bin/curl --version 2>&1)
      if [[ ! "${isCurl}" =~ "OpenSSL" ]] || [ -z "${isCurl}" ]; then
        echo "ERRR: curl is still broken, please install it and debug manually"
        clean_pid_exit
      else
        echo "GOOD: /usr/local/bin/curl works"
      fi
    fi
  fi
}

check_dns_curl() {
  if [ ! -f "/etc/resolv.conf" ]; then
    rm -f /etc/resolv.conf
    echo "nameserver 127.0.0.1" > /etc/resolv.conf
    if [ -e "${vBs}/resolv.conf.vanilla" ]; then
      cat ${vBs}/resolv.conf.vanilla >> /etc/resolv.conf
    fi
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
    echo "nameserver 1.0.0.1" >> /etc/resolv.conf
    echo "nameserver 8.8.8.8" >> /etc/resolv.conf
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf
    check_dns_settings
  else
    check_dns_settings
  fi
  if [ -x "/usr/sbin/unbound-control" ] \
    && [ -e "/etc/resolvconf/run/interface/lo.unbound" ]; then
    unbound-control reload &> /dev/null
  fi
  find_fast_mirror_early
  if_reinstall_curl
  _CURL_TEST=$(curl -L -k -s \
    --max-redirs 10 \
    --retry 3 \
    --retry-delay 10 \
    -I "http://${_USE_MIR}" 2> /dev/null)
  if [[ ! "${_CURL_TEST}" =~ "200 OK" ]]; then
    if [[ "${_CURL_TEST}" =~ "unknown option was passed in to libcurl" ]]; then
      echo "ERROR: cURL libs are out of sync! Re-installing again.."
      if_reinstall_curl
    else
      echo "ERROR: ${_USE_MIR} is not available, please try later"
      clean_pid_exit check_dns_curl_a
    fi
  fi
}

check_root_direct() {
  _U_TEST=DENY
  [ "${SUDO_USER}" ] && _U_TEST_SDO=${SUDO_USER} || _U_TEST_SDO=`whoami`
  _U_TEST_WHO=$(who am i | awk '{print $1}' 2>&1)
  _U_TEST_LNE=$(logname 2>&1)
  if [ "${_U_TEST_SDO}" = "root" ] || [ "${_U_TEST_LNE}" = "root" ]; then
    if [ -z "${_U_TEST_WHO}" ]; then
      _U_TEST=ALLOW
      ### normal for root scripts running from cron
    else
      if [ "${_U_TEST_WHO}" = "root" ]; then
        _U_TEST=ALLOW
      fi
    fi
  fi
  if [ "${_U_TEST}" = "DENY" ]; then
    echo
    echo "ERROR: This script must be run as root directly,"
    echo "ERROR: without sudo/su switch from regular system user"
    echo "ERROR: Please add and test your SSH (RSA) keys for root account"
    echo "ERROR: with direct access before trying again"
    echo
    echo "HINT:  You can always restrict access later, or"
    echo "       allow only SSH (RSA) keys for root with directive"
    echo "         PermitRootLogin prohibit-password"
    echo "       in the /etc/ssh/sshd_config file"
    echo "Bye"
    clean_pid_exit check_root_direct_a
  fi
}

check_root_keys_pwd() {
  _S_TEST=$(grep "root:\*:" /etc/shadow 2>&1)
  _R_TEST=CHECK
  if [ -e "/root/.ssh/authorized_keys" ]; then
    _R_TEST=$(grep "ssh-rsa" /root/.ssh/authorized_keys 2>&1)
  fi
  if [[ ! "${_S_TEST}" =~ "root:" ]] \
    && [[ ! "${_R_TEST}" =~ "ssh-rsa" ]]; then
    echo
    echo "ERROR: BOA requires working SSH (RSA) keys for system root present"
    echo "ERROR: Please add and test your SSH (RSA) keys for root account"
    echo "ERROR: before trying again"
    echo
    echo "HINTS: Run this command on your local PC machine:"
    echo "HINTS:   ssh-keygen -b 4096 -t rsa -N '' -f ~/.ssh/id_rsa"
    echo "HINTS: Then copy the ~/.ssh/id_rsa.pub file from your PC"
    echo "HINTS: to ~/.ssh/authorized_keys file on the server"
    echo "HINTS: Make sure the key is not split into more than 1 line"
    echo "HINTS: Remember to run: chmod 600 ~/.ssh/authorized_keys"
    echo
    echo "Bye"
    echo
    clean_pid_exit check_root_keys_pwd_a
  fi
}

check_root() {
  if [ `whoami` = "root" ]; then
    if [ -e "/root/.barracuda.cnf" ]; then
      source /root/.barracuda.cnf
      _B_NICE=${_B_NICE//[^0-9]/}
    fi
    if [ -z "${_B_NICE}" ]; then
      _B_NICE=10
    fi
    renice ${_B_NICE} -p $$ &> /dev/null
    ionice -c2 -n7 -p $$
  else
    echo "ERROR: This script should be run as a root user"
    clean_pid_exit check_root_a
  fi
  _DF_TEST=$(df -kTh / -l \
    | grep '/' \
    | sed 's/\%//g' \
    | awk '{print $6}' 2> /dev/null)
  _DF_TEST=${_DF_TEST//[^0-9]/}
  if [ ! -z "${_DF_TEST}" ] && [ "${_DF_TEST}" -gt "90" ]; then
    echo "ERROR: Your disk space is almost full !!! ${_DF_TEST}/100"
    echo "ERROR: We can not proceed until it is below 90/100"
    clean_pid_exit check_root_b
  fi
}

check_no_systemd() {
  if [ -e "/lib/systemd/systemd" ]; then
    echo "ERROR: This script can not be used with systemd"
    echo "ERROR: Please run 'autoinit' first"
    clean_pid_exit check_no_systemd_a_octopus
  fi
}

if_start_screen() {
  if [[ -n "$SSH_CONNECTION" || -n "$SSH_CLIENT" ]]; then
    # Check if the user is inside a screen session
    if [[ ! "${ARGS}" =~ (^|[[:space:]])(info|help)([[:space:]]|$) ]]; then
      if [ -z "$STY" ]; then
        # If not in screen, start a new screen session with the same script
        echo "You are not inside a screen session. Starting screen..."
        screen -S session_octopus bash -c "$0 $ARGS"
        exit
      else
        # If already inside screen, continue the script
        echo "You are already in a screen session, OK"
      fi
    fi
  fi
}

if_display_help() {
  if [ "${cmmand}" = "help" ] || [ "${cmmand}" = "info" ]; then
    echo
    echo "Usage: $(basename "$0") {version} {instance} {mode}"
    cat <<EOF

    Accepted keywords and values in every option:

    {version}
      up-lts <------- upgrade to Octopus LTS release (no license)
      up-pro <------- upgrade to Octopus PRO release (requires license)
      up-dev <------- upgrade to Octopus Cutting Edge (requires license)

    {instance}
      all <---------- upgrade all active Octopus instances in a batch
      o1 <----------- upgrade only listed Octopus instance (system name)

    {mode}
      aegir <-------- upgrade only Aegir Hostmaster
      platforms <---- upgrade only Aegir Platforms
      both <--------- upgrade both Aegir Hostmaster and Platforms
      force <-------- force upgrade of either specified instance or all

    See docs/UPGRADE.md for more details.

EOF
    clean_pid_exit cmmand_a
  fi
}

up_proceed() {
  if [ -e "/root/.run-to-daedalus.cnf" ] \
    || [ -e "/root/.run-to-chimaera.cnf" ] \
    || [ -e "/root/.run-to-beowulf.cnf" ] \
    || [ "${cmmand}" = "info" ] \
    || [ "${cmmand}" = "help" ]; then
    _CHECK_SQL=NO
  elif [ "${cmmand}" = "up-lts" ] \
    || [ "${cmmand}" = "up-pro" ] \
    || [ "${cmmand}" = "up-dev" ]; then
    _CHECK_SQL=YES
  else
    _CHECK_SQL=NO
  fi
  if [ "${_CHECK_SQL}" = "YES" ]; then
    check_sql_running
    check_sql_access
  fi
  if [ "${cmmand}" = "up-dev" ]; then
    tRee=dev
  elif [ "${cmmand}" = "up-pro" ]; then
    tRee=pro
  elif [ "${cmmand}" = "up-lts" ]; then
    tRee=lts
  elif [ "${cmmand}" = "help" ] || [ "${cmmand}" = "info" ]; then
    tRee=lts
  else
    echo
    echo "Sorry, you are trying not supported command.."
    echo "Display supported commands with: $(basename "$0") help"
    echo
    clean_pid_exit up_proceed_a
  fi
  rlsn="BOA-5.4.0"
  rlse="${rlsn}-${tRee}"
  branch="5.x-${tRee}"
  brnch=${branch//\//\\\/}
  export tRee="${tRee}"
  export rlsn="${rlsn}"
  satellite_downgrade_protection
  up_start
  curl ${crlGet} "${rgUrl}/${brnch}/${octName}"  -o ${vBs}/${octName}
  curl ${crlGet} "${rgUrl}/${brnch}/${pthIncO}"  -o ${vBs}/${filIncO}
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

cmmand="$1"
second="$2"
cmmode="$3"
silent="$4"
ARGS="$@"

if_display_help
check_root_direct
check_root_keys_pwd
check_root
check_no_systemd
os_detection_minimal
check_dns_curl
if_start_screen
up_proceed

exit 0

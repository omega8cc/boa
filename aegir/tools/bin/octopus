#!/bin/bash

HOME=/root
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/local/sbin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin

export PATH=${PATH}
export SHELL=${SHELL}
export HOME=${HOME}

dvhd="DEV"
dvbranch="5.x-dev"
dvmaster="5.x-dev"
dvrn="BOA-5.0.0-dev"

hd="HEAD"
branch="4.x-stable"
master="4.x-stable"
stbl="BOA-4.2.0-stable"
cluster="BOA-4.2.0-stable"
lgcA="BOA-2.2.9"
lgcB="BOA-2.3.8"
lgcC="BOA-2.4.9"
lgcD="BOA-3.2.2"

mstr=${master//\//\\\/}
brnch=${branch//\//\\\/}
dvmstr=${dvmaster//\//\\\/}
dvbrnch=${dvbranch//\//\\\/}

barCnf="/root/.barracuda.cnf"
barName="BARRACUDA.sh.txt"
bldPth="/opt/tmp/boa"
crlGet="-L --max-redirs 10 -k -s --retry 10 --retry-delay 5 -A iCab"
aptYesUnth="-y --allow-unauthenticated"
filIncB="barracuda.sh.cnf"
filIncO="octopus.sh.cnf"
gCb="git clone --branch"
octName="OCTOPUS.sh.txt"
pthIncB="lib/settings/${filIncB}"
pthIncO="lib/settings/${filIncO}"
rgUrl="https://raw.githubusercontent.com/omega8cc/boa"
vBs="/var/backups"

_TODAY=$(date +%y%m%d 2>&1)
_TODAY=${_TODAY//[^0-9]/}
_NOW=$(date +%y%m%d-%H%M%S 2>&1)
_NOW=${_NOW//[^0-9-]/}
_CHECK_HOST=$(uname -n 2>&1)
_LOG_DIR="${vBs}/reports/up/$(basename "$0")/${_TODAY}"
_VMFAMILY=XEN
_VM_TEST=$(uname -a 2>&1)
if [[ "${_VM_TEST}" =~ "-beng" ]]; then
  _VMFAMILY="VS"
fi

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi

clean_pid_exit() {
  rm -f /var/run/boa_wait.pid
  rm -f /var/run/boa_run.pid
  service cron start &> /dev/null
  exit 1
}

os_detection_minimal() {
  _THIS_RV=$(lsb_release -sc 2>&1)
  if [ "${_THIS_RV}" = "chimaera" ] \
    || [ "${_THIS_RV}" = "beowulf" ] \
    || [ "${_THIS_RV}" = "bullseye" ] \
    || [ "${_THIS_RV}" = "buster" ]; then
    _APT_UPDATE="apt-get update --allow-releaseinfo-change"
  else
    _APT_UPDATE="apt-get update"
  fi
}

apt_clean_update() {
  apt-get clean -qq 2> /dev/null
  rm -rf /var/lib/apt/lists/* &> /dev/null
  ${_APT_UPDATE} -qq 2> /dev/null
}

check_sql_access() {
  if [ -e "/root/.my.pass.txt" ] && [ -e "/root/.my.cnf" ]; then
    _SQL_PSWD=$(cat /root/.my.pass.txt 2>&1)
    _SQL_PSWD=$(echo -n ${_SQL_PSWD} | tr -d "\n" 2>&1)
    _IS_SYNC_SQL_PSWD=$(grep "${_SQL_PSWD}" /root/.my.cnf 2>&1)
  else
    echo "ALERT: /root/.my.cnf or /root/.my.pass.txt not found."
    echo "ALERT: Please fix this before trying again, giving up."
    echo "Bye"
    echo " "
    clean_pid_exit
  fi
  if [ -z "${_IS_SYNC_SQL_PSWD}" ] \
    || [[ ! "${_IS_SYNC_SQL_PSWD}" =~ "password=${_SQL_PSWD}" ]]; then
    echo "ALERT: SQL password is out of sync between"
    echo "ALERT: /root/.my.cnf and /root/.my.pass.txt"
    echo "ALERT: Please fix this before trying again, giving up."
    echo "Bye"
    echo " "
    clean_pid_exit
  else
    _IS_MYSQLD_RUNNING=$(ps aux | grep '[m]ysqld' | awk '{print $2}' 2>&1)
    if [ -z "${_IS_MYSQLD_RUNNING}" ]; then
      echo "ALERT: SQL server on this system is not running at all."
      echo "ALERT: Please fix this before trying again, giving up."
      echo "Bye"
      echo " "
      clean_pid_exit
    else
      _MYSQL_CONN_TEST=$(mysql -u root -e "status" 2>&1)
      if [ -z "${_MYSQL_CONN_TEST}" ] \
        || [[ "${_MYSQL_CONN_TEST}" =~ "Access denied" ]]; then
        echo "ALERT: SQL password in /root/.my.cnf does not work."
        echo "ALERT: Please fix this before trying again, giving up."
        echo "Bye"
        echo " "
        clean_pid_exit
      fi
    fi
  fi
}
check_sql_access

fix_dns_settings() {
  dnsLi="/root/.local.dns.IP.list"
  mkdir -p ${vBs}
  rm -f ${vBs}/resolv.conf.tmp
  if [ -e "/etc/resolv.conf" ]; then
    if [ -L "/etc/resolv.conf" ]; then
      rslvT=`readlink -n /etc/resolv.conf`
      if [ ! -e "${rslvT}" ]; then
        rm -f /etc/resolv.conf
      fi
    fi
    if [ -e "/etc/resolv.conf" ]; then
      cp -a /etc/resolv.conf ${vBs}/resolv.conf.tmp
    fi
  fi
  if [ ! -e "${vBs}/resolv.conf.tmp" ]; then
    echo "nameserver 1.1.1.1" >${vBs}/resolv.conf.tmp
    echo "nameserver 1.0.0.1" >>${vBs}/resolv.conf.tmp
  fi
  if [ ! -e "${vBs}/resolv.conf.vanilla" ] \
    && [ -e "${vBs}/resolv.conf.tmp" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp ${vBs}/resolv.conf.vanilla
    fi
  fi
  sed -i "/^$/d" ${vBs}/resolv.conf.vanilla &> /dev/null
  if [ -e "${vBs}/resolv.conf.vanilla" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.vanilla /etc/resolv.conf
    fi
  else
    if [ -e "${vBs}/resolv.conf.tmp" ] \
      && [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
    fi
  fi
  if [ -e "/etc/pdnsd.conf" ]; then
    if [ -e "${dnsLi}" ]; then
      sed -i "s/.*127.0.0.1.*//g; s/ *$//g; /^$/d" ${dnsLi}
      wait
      sed -i "s/.*Dynamic.*//g; s/ *$//g; /^$/d"   ${dnsLi}
      wait
      _BROKEN_DNS_TEST_X=$(grep "\." ${dnsLi} 2>&1)
      if [ -z "${_BROKEN_DNS_TEST_X}" ]; then
        echo "        label = \"cloudflare-servers\";" > ${dnsLi}
        echo "        ip=1.1.1.1;" >> ${dnsLi}
        echo "        ip=1.0.0.1;" >> ${dnsLi}
      fi
    fi
    _CUSTOM_DNS_TEST=$(grep 1.1.1.1 /etc/pdnsd.conf 2>&1)
    _BROKEN_DNS_CONF=$(grep "ip=Dynamic" /etc/pdnsd.conf 2>&1)
    _MISSING_DNS_TEST=$(grep "ip=" /etc/pdnsd.conf 2>&1)
    if [[ "${_CUSTOM_DNS_TEST}" =~ "1.1.1.1" ]] \
      || [ ! -e "${dnsLi}" ] \
      || [ -e "/root/.use.default.nameservers.cnf" ] \
      || [ -e "/root/.use.local.nameservers.cnf" ] \
      || [[ "${_BROKEN_DNS_CONF}" =~ "Dynamic" ]] \
      || [[ -z "${_MISSING_DNS_TEST}" ]]; then
      echo "        label = \"cloudflare-servers\";" > ${dnsLi}
      for _IP in `cat /etc/resolv.conf \
        | sed 's/.*127.0.0.1.*//g; s/.*search.*//g; s/.*Dynamic.*//g' \
        | cut -d ' ' -f2 \
        | sort \
        | uniq`;do echo "        ip=${_IP};" >> ${dnsLi};done
      wait
      sed -i "s/ip=.*//g; s/ *$//g; /^$/d" /etc/pdnsd.conf
      wait
      sed -i "s/.*127.0.0.1.*//g; s/ *$//g; /^$/d" ${dnsLi}
      wait
      sed -i "s/.*Dynamic.*//g; s/ *$//g; /^$/d"   ${dnsLi}
      wait
      _BROKEN_DNS_TEST_Y=$(grep "\." ${dnsLi} 2>&1)
      if [ -z "${_BROKEN_DNS_TEST_Y}" ]; then
         echo "        ip=1.1.1.1;" >> ${dnsLi}
         echo "        ip=1.0.0.1;" >> ${dnsLi}
      fi
      ### echo debug dns A
      _DNS_TPL_TEST_GE=$(grep "google-servers" /etc/pdnsd.conf 2>&1)
      _DNS_TPL_TEST_CF=$(grep "cloudflare-servers" /etc/pdnsd.conf 2>&1)
      _DNS_RGX_TEST=$(grep "cloudflare-servers" /root/.local.dns.IP.list 2>&1)
      if [[ "${_DNS_TPL_TEST_CF}" =~ "cloudflare-servers" ]] \
        && [[ "${_DNS_RGX_TEST}" =~ "cloudflare-servers" ]]; then
        sed -i '/        label = \"cloudflare-servers\";/ {r /root/.local.dns.IP.list
d;};' /etc/pdnsd.conf
        wait
      fi
      if [[ "${_DNS_TPL_TEST_GE}" =~ "google-servers" ]] \
        && [[ "${_DNS_RGX_TEST}" =~ "cloudflare-servers" ]]; then
        sed -i '/        label = \"google-servers\";/ {r /root/.local.dns.IP.list
d;};' /etc/pdnsd.conf
        wait
      fi
      resolvconf -u         &> /dev/null
      service pdnsd restart &> /dev/null
      pdnsd-ctl empty-cache &> /dev/null
    fi
  fi
}

check_dns_settings() {
  if [ -e "/root/.use.default.nameservers.cnf" ]; then
    _USE_DEFAULT_DNS=YES
    rm -f /root/.local.dns.IP.list
  fi
  if [ -e "/root/.use.local.nameservers.cnf" ]; then
    _USE_PROVIDER_DNS=YES
  else
    _REMOTE_DNS_TEST=$(host files.aegir.cc 1.1.1.1 -w 10 2>&1)
  fi
  if [[ "${_REMOTE_DNS_TEST}" =~ "no servers could be reached" ]] \
    || [[ "${_REMOTE_DNS_TEST}" =~ "Host files.aegir.cc not found" ]] \
    || [ "${_USE_DEFAULT_DNS}" = "YES" ] \
    || [ "${_USE_PROVIDER_DNS}" = "YES" ]; then
    if [ "${_USE_DEFAULT_DNS}" = "YES" ] \
      || [ "${_USE_PROVIDER_DNS}" = "YES" ] \
      || [ ! -e "${vBs}/resolv.conf.vanilla" ]; then
      fix_dns_settings
      if [ -e "/etc/init.d/postfix" ]; then
        service postfix restart &> /dev/null
      fi
    fi
  fi
}

extract_archive() {
  if [ ! -z "$1" ]; then
    case $1 in
      *.tar.bz2)   tar xjf $1    ;;
      *.tar.gz)    tar xzf $1    ;;
      *.tar.xz)    tar xvf $1    ;;
      *.bz2)       bunzip2 $1    ;;
      *.rar)       unrar x $1    ;;
      *.gz)        gunzip -q $1  ;;
      *.tar)       tar xf $1     ;;
      *.tbz2)      tar xjf $1    ;;
      *.tgz)       tar xzf $1    ;;
      *.zip)       unzip -qq $1  ;;
      *.Z)         uncompress $1 ;;
      *.7z)        7z x $1       ;;
      *)           echo "'$1' cannot be extracted via >extract<" ;;
    esac
    rm -f $1
  fi
}

get_dev_ext() {
  if [ ! -z "$1" ]; then
    curl ${crlGet} "${urlDev}/HEAD/$1" -o "$1"
    if [ -e "$1" ]; then
      extract_archive "$1"
    else
      echo "OOPS: $1 failed download from ${urlDev}/HEAD/$1"
    fi
  fi
}

send_report() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    if [ -e "/root/.auto.up.cnf" ] \
      || [ -e "/root/.host8.cnf" ] \
      || [[ "${_CHECK_HOST}" =~ ".host8." ]] \
      || [[ "${_CHECK_HOST}" =~ ".boa.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".o8.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".aegir.cc"($) ]]; then
      _MY_EMAIL="$(basename "$0")@omega8.cc"
    fi
    if [ ! -z "${_MY_EMAIL}" ]; then
      repSub="Successful Octopus upgrade for ${octUsr}"
      repSub="REPORT: ${repSub} on ${_CHECK_HOST}"
      repSub=$(echo -n ${repSub} | fmt -su -w 2500 2>&1)
      cat ${_UP_LOG} | mail -e -s "${repSub} at ${_NOW}" ${_MY_EMAIL}
      echo "${repSub} sent to ${_MY_EMAIL}"
    fi
  fi
}

send_alert() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    if [ -e "/root/.auto.up.cnf" ] \
      || [ -e "/root/.host8.cnf" ] \
      || [[ "${_CHECK_HOST}" =~ ".host8." ]] \
      || [[ "${_CHECK_HOST}" =~ ".boa.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".o8.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".aegir.cc"($) ]]; then
      _MY_EMAIL="$(basename "$0")@omega8.cc"
    fi
    if [ ! -z "${_MY_EMAIL}" ]; then
      repSub="ALERT: Failed Octopus upgrade for ${octUsr} on ${_CHECK_HOST}"
      repSub=$(echo -n ${repSub} | fmt -su -w 2500 2>&1)
      cat ${_UP_LOG} | mail -e -s "${repSub} at ${_NOW}" ${_MY_EMAIL}
      echo "${repSub} sent to ${_MY_EMAIL}"
    fi
  fi
}

check_report() {
  _SEND_ALERT=NO
  _RESULT_BYE=$(grep "BYE" ${_UP_LOG} 2>&1)
  if [[ "${_RESULT_BYE}" =~ "BYE" ]]; then
    _DO_NOTHING=YES
  else
    _SEND_ALERT=YES
  fi
  _RESULT_ALRT=$(grep "ALRT" ${_UP_LOG} 2>&1)
  if [[ "${_RESULT_ALRT}" =~ "ALRT" ]]; then
    _SEND_ALERT=YES
  fi
  _RESULT_ABORTING=$(grep "Aborting" ${_UP_LOG} 2>&1)
  if [[ "${_RESULT_ABORTING}" =~ "Aborting" ]]; then
    _SEND_ALERT=YES
  fi
  _RESULT_ALREADY=$(grep "This Aegir Instance is already up" ${_UP_LOG} 2>&1)
  if [[ "${_RESULT_ALREADY}" =~ "This Aegir Instance is already up" ]]; then
    _SEND_ALERT=NO
  fi
  if [ "${_SEND_ALERT}" = "YES" ]; then
    send_alert
  else
    send_report
  fi
}

up_mode() {
  if [ "${mcmode}" = "aegir" ]; then
    sed -i "s/^_HM_ONLY=NO/_HM_ONLY=YES/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=NO/_HM_ONLY=YES/g"                     ${vBs}/${tocName}
    wait
    if [ -e "${vBs}/${tocIncO}" ]; then
      sed -i "s/^_HM_ONLY=NO/_HM_ONLY=YES/g"                   ${vBs}/${tocIncO}
      wait
    fi
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  elif [ "${mcmode}" = "platforms" ]; then
    sed -i "s/^_PLATFORMS_ONLY=NO/_PLATFORMS_ONLY=YES/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=NO/_PLATFORMS_ONLY=YES/g"       ${vBs}/${tocName}
    wait
    if [ -e "${vBs}/${tocIncO}" ]; then
      sed -i "s/^_PLATFORMS_ONLY=NO/_PLATFORMS_ONLY=YES/g"     ${vBs}/${tocIncO}
      wait
    fi
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  elif [ "${mcmode}" = "both" ] || [ "${mcmode}" = "force" ]; then
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${octCnf}
    wait
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${vBs}/${tocName}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${vBs}/${tocName}
    wait
    if [ -e "${vBs}/${tocIncO}" ]; then
      sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                   ${vBs}/${tocIncO}
      wait
    fi
    if [ -e "${vBs}/${tocIncO}" ]; then
      sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"     ${vBs}/${tocIncO}
      wait
    fi
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  else
    sed -i "s/^_HM_ONLY=YES/_HM_ONLY=NO/g"                     ${octCnf}
    wait
    sed -i "s/^_PLATFORMS_ONLY=YES/_PLATFORMS_ONLY=NO/g"       ${octCnf}
    wait
    bash  ${vBs}/${tocName}
    touch ${User}/log/up-${_TODAY}
  fi
  if [ ! -z "${switchCLIback}" ]; then
    echo "${switchCLIback}" > ${User}/static/control/cli.info
  fi
  if [ ! -z "${switchFPMback}" ]; then
    echo "${switchFPMback}" > ${User}/static/control/fpm.info
  fi
}

satellite_check_up_php() {
  if [ "${cmmand}" = "up-head" ] \
    || [ "${cmmand}" = "up-dev" ] \
    || [ "${cmmand}" = "up-legacy" ] \
    || [ "${cmmand}" = "up-stable" ]; then
    fmodey=
    _SERIES_TEST=
    _PHP_FPM_LEGACY_FREE=
    _PHP_CLI_LEGACY_FREE=
    mcmode="${orgMcmode}"
    if [ -e "${User}/log/octopus_log.txt" ]; then
      _SERIES_TEST=$(cat ${User}/log/octopus_log.txt 2>&1)
      if [[ "${_SERIES_TEST}" =~ "BOA-4." ]] \
        || [[ "${_SERIES_TEST}" =~ "BOA-3." ]]; then
        if [ -e "${User}/static/control/fpm.info" ]; then
          _T_FPM_VRN=$(cat ${User}/static/control/fpm.info 2>&1)
          _T_FPM_VRN=${_T_FPM_VRN//[^0-9.]/}
          _T_FPM_VRN=$(echo -n ${_T_FPM_VRN} | tr -d "\n" 2>&1)
          if [ "${_T_FPM_VRN}" = "8.2" ] \
            || [ "${_T_FPM_VRN}" = "8.1" ] \
            || [ "${_T_FPM_VRN}" = "8.0" ] \
            || [ "${_T_FPM_VRN}" = "7.4" ] \
            || [ "${_T_FPM_VRN}" = "7.3" ] \
            || [ "${_T_FPM_VRN}" = "7.2" ] \
            || [ "${_T_FPM_VRN}" = "7.1" ] \
            || [ "${_T_FPM_VRN}" = "7.0" ] \
            || [ "${_T_FPM_VRN}" = "5.6" ]; then
            _PHP_FPM_LEGACY_FREE=YES
          else
            _PHP_FPM_LEGACY_FREE=NO
          fi
        else
          _PHP_FPM_LEGACY_FREE=YES
        fi
        if [ -e "${User}/static/control/cli.info" ]; then
          _T_CLI_VRN=$(cat ${User}/static/control/cli.info 2>&1)
          _T_CLI_VRN=${_T_CLI_VRN//[^0-9.]/}
          _T_CLI_VRN=$(echo -n ${_T_CLI_VRN} | tr -d "\n" 2>&1)
          if [ "${_T_CLI_VRN}" = "8.2" ] \
            || [ "${_T_CLI_VRN}" = "8.1" ] \
            || [ "${_T_CLI_VRN}" = "8.0" ] \
            || [ "${_T_CLI_VRN}" = "7.4" ] \
            || [ "${_T_CLI_VRN}" = "7.3" ] \
            || [ "${_T_CLI_VRN}" = "7.2" ] \
            || [ "${_T_CLI_VRN}" = "7.1" ] \
            || [ "${_T_CLI_VRN}" = "7.0" ] \
            || [ "${_T_CLI_VRN}" = "5.6" ]; then
            _PHP_CLI_LEGACY_FREE=YES
          else
            _PHP_CLI_LEGACY_FREE=NO
          fi
        else
          _PHP_CLI_LEGACY_FREE=YES
        fi
        if [ "${_PHP_FPM_LEGACY_FREE}" = "NO" ]; then
          if [ -x "/opt/php56/bin/php" ]; then
            echo 5.6 > ${User}/static/control/fpm.info
          fi
        fi
        if [ "${_PHP_CLI_LEGACY_FREE}" = "NO" ]; then
          if [ -x "/opt/php56/bin/php" ]; then
            echo 5.6 > ${User}/static/control/cli.info
          fi
        fi
        chown -R ${octUsr}.ftp:users ${User}/static/control
      fi
      if [[ "${_SERIES_TEST}" =~ "${stbl}" ]]; then
        if [ "${orgMcmode}" != "force" ]; then
          mcmode=
          fmodey=force
          if [ ! -e "/root/.silent-octopus-upgrade.cnf" ]; then
            echo
            echo "This Aegir Instance ${octUsr} is already up to date!"
            echo "If you wish to run/force the upgrade again,"
            echo "please use the forced upgrade mode, as shown below"
            echo
            echo "Usage: $(basename "$0") ${orgCmmand} ${second} force"
            echo
          fi
        fi
      fi
    fi
  fi
  _SERIES_TEST=
}

satellite_check_switch_php() {
  if [ "${cmmand}" = "up-head" ] \
    || [ "${cmmand}" = "up-dev" ] \
    || [ "${cmmand}" = "up-legacy" ] \
    || [ "${cmmand}" = "up-stable" ]; then
    if [ -e "${User}/log/octopus_log.txt" ]; then
      _SERIES_TEST_RESULT=
      _SERIES_TEST=$(cat ${User}/log/octopus_log.txt 2>&1)
      if [[ "${_SERIES_TEST}" =~ "${dvrn}" ]] \
        || [[ "${_SERIES_TEST}" =~ "${stbl}-dev" ]] \
        || [[ "${_SERIES_TEST}" =~ "${stbl}" ]]; then
        _SERIES_TEST_RESULT=OK
        if [ "${orgMcmode}" != "force" ]; then
          mcmode=
          fmodey=force
          if [ ! -e "/root/.silent-octopus-upgrade.cnf" ]; then
            echo
            echo "This Aegir Instance ${octUsr} is already up to date!"
            echo "If you wish to run/force the upgrade again,"
            echo "please use the forced upgrade mode, as shown below"
            echo
            echo "Usage: $(basename "$0") ${orgCmmand} ${second} force"
            echo
          fi
        fi
      else
        if [[ ! "${_SERIES_TEST}" =~ "${lgcD}" ]]; then
          cmmand="up-3.2"
          mcmode="${orgMcmode}"
          echo
          echo "This Aegir Instance ${octUsr} can not be upgraded"
          echo "via '$(basename "$0") ${orgCmmand}' mode"
          echo "We will run legacy upgrade to ${lgcD} instead"
          echo "Once the upgrade to ${lgcD} is complete, you will be able"
          echo "to use the '$(basename "$0") ${orgCmmand}' upgrade mode"
          echo "Please wait..."
          echo
          sleep 5
        fi
      fi
    fi
    if [ -e "${User}/static/control/fpm.info" ]; then
      _T_FPM_VRN=$(cat ${User}/static/control/fpm.info 2>&1)
      _T_FPM_VRN=${_T_FPM_VRN//[^0-9.]/}
      _T_FPM_VRN=$(echo -n ${_T_FPM_VRN} | tr -d "\n" 2>&1)
      if [ "${_T_FPM_VRN}" = "8.2" ] \
        || [ "${_T_FPM_VRN}" = "8.1" ] \
        || [ "${_T_FPM_VRN}" = "8.0" ] \
        || [ "${_T_FPM_VRN}" = "7.4" ] \
        || [ "${_T_FPM_VRN}" = "7.3" ] \
        || [ "${_T_FPM_VRN}" = "7.2" ] \
        || [ "${_T_FPM_VRN}" = "7.1" ] \
        || [ "${_T_FPM_VRN}" = "7.0" ] \
        || [ "${_T_FPM_VRN}" = "5.6" ]; then
        _PHP_FPM_LEGACY_FREE=YES
      else
        _PHP_FPM_LEGACY_FREE=NO
      fi
    else
      _PHP_FPM_LEGACY_FREE=YES
    fi
    if [ -e "${User}/static/control/cli.info" ]; then
      _T_CLI_VRN=$(cat ${User}/static/control/cli.info 2>&1)
      _T_CLI_VRN=${_T_CLI_VRN//[^0-9.]/}
      _T_CLI_VRN=$(echo -n ${_T_CLI_VRN} | tr -d "\n" 2>&1)
      if [ "${_T_CLI_VRN}" = "8.2" ] \
        || [ "${_T_CLI_VRN}" = "8.1" ] \
        || [ "${_T_CLI_VRN}" = "8.0" ] \
        || [ "${_T_CLI_VRN}" = "7.4" ] \
        || [ "${_T_CLI_VRN}" = "7.3" ] \
        || [ "${_T_CLI_VRN}" = "7.2" ] \
        || [ "${_T_CLI_VRN}" = "7.1" ] \
        || [ "${_T_CLI_VRN}" = "7.0" ] \
        || [ "${_T_CLI_VRN}" = "5.6" ]; then
        _PHP_CLI_LEGACY_FREE=YES
      else
        _PHP_CLI_LEGACY_FREE=NO
      fi
    else
      _PHP_CLI_LEGACY_FREE=YES
    fi
    if [ "${_PHP_CLI_LEGACY_FREE}" = "YES" ] \
      && [ "${_PHP_FPM_LEGACY_FREE}" = "YES" ]; then
      _PHP_LEGACY_FREE=YES
    else
      _PHP_LEGACY_FREE=NO
    fi
    if [ "${_PHP_LEGACY_FREE}" = "NO" ] \
      && [ -z "${_SERIES_TEST_RESULT}" ]; then
      cmmand="up-3.2"
      switchFPMback="${_T_FPM_VRN}"
      if [ -z "${switchFPMback}" ]; then
        switchFPMback="5.6"
      fi
      switchCLIback="${_T_CLI_VRN}"
      if [ -z "${switchCLIback}" ]; then
        switchCLIback="5.6"
      fi
      if [ -x "/opt/php56/bin/php" ]; then
        echo 5.6 > ${User}/static/control/fpm.info
        echo 5.6 > ${User}/static/control/cli.info
      fi
      chown -R ${octUsr}.ftp:users ${User}/static/control
      echo
      echo "This instance ${octUsr} still depends on the old PHP version"
      echo "FPM.${_T_FPM_VRN} CLI.${_T_CLI_VRN}"
      echo "We will switch FPM and CLI on ${octUsr} to PHP 5.6 temporarily"
      echo "Then we will run legacy upgrade to ${lgcD}"
      echo "Please wait..."
      echo
      sleep 5
    else
      switchFPMback=""
      switchCLIback=""
    fi
  fi
  _SERIES_TEST=
}

up_one() {
  if [ -e "${vBs}/${octName}" ]; then
    cp -af ${vBs}/${octName}  ${vBs}/${tocName}
    if [ -e "${vBs}/${filIncO}" ]; then
      cp -af ${vBs}/${filIncO}  ${vBs}/${tocIncO}
    fi
    satellite_check_up_php
    ### satellite_check_switch_php
    if [ "${cmmand}" = "up-dev" ]; then
      sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${dvbrnch}/g"      ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${dvhd}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${dvhd}/g"   ${vBs}/${tocIncO}
      wait
      sed -i "s/^_X_VERSION=.*/_X_VERSION=${dvrn}/g"           ${vBs}/${tocIncO}
      wait
    elif [ "${cmmand}" = "up-head" ] \
      || [ "${cmmand}" = "up-legacy" ] \
      || [ "${cmmand}" = "up-stable" ]; then
      sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${brnch}/g"        ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${hd}/g"     ${vBs}/${tocIncO}
      wait
      sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${hd}/g"     ${vBs}/${tocIncO}
      wait
      sed -i "s/^_X_VERSION=.*/_X_VERSION=${stbl}/g"           ${vBs}/${tocIncO}
      wait
    else
      if [ -e "${vBs}/${tocIncO}" ]; then
        sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${brnch}/g"      ${vBs}/${tocIncO}
        wait
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${hd}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${stbl}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${stbl}/g"         ${vBs}/${tocIncO}
        wait
      fi
      ### Legacy method
      sed -i "s/^_BRANCH_PRN=.*/_BRANCH_PRN=${brnch}/g"        ${vBs}/${tocName}
      wait
      sed -i "s/^_BRANCH_PRO.*/_BRANCH_PROVISION=${brnch}/g"   ${vBs}/${tocName}
      wait
      if [ "${cmmand}" = "up-2.2" ]; then
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${lgcA}/g" ${vBs}/${tocName}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${lgcA}/g" ${vBs}/${tocName}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${lgcA}/g"         ${vBs}/${tocName}
        wait
      elif [ "${cmmand}" = "up-2.3" ]; then
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${lgcB}/g" ${vBs}/${tocName}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${lgcB}/g" ${vBs}/${tocName}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${lgcB}/g"         ${vBs}/${tocName}
        wait
      elif [ "${cmmand}" = "up-2.4" ]; then
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${lgcC}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${lgcC}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${lgcC}/g"         ${vBs}/${tocIncO}
        wait
      elif [ "${cmmand}" = "up-3.2" ]; then
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${lgcD}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${lgcD}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${lgcD}/g"         ${vBs}/${tocIncO}
        wait
      else
        sed -i "s/^_AEGIR_VERSION=.*/_AEGIR_VERSION=${hd}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_AEGIR_XTS_VRN=.*/_AEGIR_XTS_VRN=${stbl}/g" ${vBs}/${tocIncO}
        wait
        sed -i "s/^_X_VERSION=.*/_X_VERSION=${stbl}/g"         ${vBs}/${tocIncO}
        wait
      fi
    fi
    if [ "${cmmand}" = "up-head" ] \
      || [ "${cmmand}" = "up-dev" ] \
      || [ "${cmmand}" = "up-legacy" ] \
      || [ "${cmmand}" = "up-stable" ]; then
      sed -i "s/^_BRANCH_BOA=.*/_BRANCH_BOA=${mstr}/g"         ${vBs}/${tocIncO}
      wait
    elif [ "${cmmand}" = "up-cluster" ]; then
      sed -i "s/^_BRANCH_BOA=.*/_BRANCH_BOA=${cluster}/g"      ${vBs}/${tocIncO}
      wait
    else
      if [ -e "${vBs}/${tocIncO}" ]; then
        sed -i "s/^_BRANCH_BOA=.*/_BRANCH_BOA=${mstr}/g"       ${vBs}/${tocIncO}
        wait
      fi
      ### Legacy method
      sed -i "s/^_BRANCH_BOA=.*/_BRANCH_BOA=${mstr}/g"         ${vBs}/${tocName}
      wait
    fi
    if [ -e "${vBs}/${tocIncO}" ]; then
      sed -i "s/^_AUTOPILOT=NO/_AUTOPILOT=YES/g"               ${vBs}/${tocIncO}
      wait
      sed -i "s/^_DNS_SETUP_TEST=YES/_DNS_SETUP_TEST=NO/g"     ${vBs}/${tocIncO}
      wait
    fi
    sed -i "s/^_USER=o1/_USER=${octUsr}/g"                     ${vBs}/${tocName}
    wait
    ### Legacy method
    sed -i "s/^_AUTOPILOT=NO/_AUTOPILOT=YES/g"                 ${vBs}/${tocName}
    wait
    sed -i "s/^_DNS_SETUP_TEST=YES/_DNS_SETUP_TEST=NO/g"       ${vBs}/${tocName}
    wait
    if [ -e "/root/.auto.up.cnf" ] \
      || [ -e "/root/.host8.cnf" ] \
      || [[ "${_CHECK_HOST}" =~ ".host8." ]] \
      || [[ "${_CHECK_HOST}" =~ ".boa.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".o8.io"($) ]] \
      || [[ "${_CHECK_HOST}" =~ ".aegir.cc"($) ]]; then
      if [ -e "/root/.debug.cnf" ] && [ ! -e "/root/.default.cnf" ]; then
        _DO_NOTHING=YES
      else
        if [ -e "${vBs}/${tocIncO}" ]; then
          sed -i "s/^_STRONG_PASSW.*/_STRONG_PASSWORDS=YES/g"  ${vBs}/${tocIncO}
          wait
          sed -i "s/^_PLATFORMS_LIST.*/_PLATFORMS_LIST=none/g" ${vBs}/${tocIncO}
          wait
        fi
        ### Legacy method
        sed -i "s/^_STRONG_PASSW.*/_STRONG_PASSWORDS=YES/g"    ${vBs}/${tocName}
        wait
        sed -i "s/^_PLATFORMS_LIST=.*/_PLATFORMS_LIST=none/g"  ${vBs}/${tocName}
        wait
        sed -i "s/^_PLATFORMS_LIST=.*/_PLATFORMS_LIST=none/g"  ${octCnf}
        wait
        sed -i "s/^_AUTOPILOT=NO/_AUTOPILOT=YES/g"             ${octCnf}
        wait
        sed -i "s/^_DNS_SETUP_TEST=YES/_DNS_SETUP_TEST=NO/g"   ${octCnf}
        wait
        sed -i "s/^_STRONG_PASSW.*/_STRONG_PASSWORDS=YES/g"    ${octCnf}
        wait
      fi
    fi
    if [ -e "${vBs}/${tocName}" ]; then
      if [ -e "${User}/.drush/sys/provision" ]; then
        _IS_OLD=$(find ${User}/.drush/sys/provision/ \
          -maxdepth 1 -mindepth 1 -mtime +0 -type d | grep example)
      elif [ -e "${User}/.drush/provision" ]; then
        _IS_OLD=$(find ${User}/.drush/provision/ \
          -maxdepth 1 -mindepth 1 -mtime +0 -type d | grep example)
      fi
      if [ -z "${_IS_OLD}" ] \
        && [ -z "${mcmode}" ] \
        && [ -e "${User}/.drush/sys/provision" ]; then
        if [ -z "${fmodey}" ]; then
          echo
          echo "This Aegir Instance is already up to date!"
          echo "If you wish to run/force the upgrade again,"
          echo "please specify desired upgrade mode:"
          echo "aegir, platforms or both - as shown below"
          echo
          echo "Usage: $(basename "$0") ${cmmand} ${second} {aegir|platforms|both}"
          echo
        fi
      else
        if [ -e "${User}/.drush/sys/provision" ]; then
          up_mode
        elif [ -e "${User}/.drush/provision" ]; then
          up_mode
        else
          echo "${User}/.drush/sys/provision does not exist!"
          rm -rf ${User}/.drush/{sys,xts,usr}
          rm -rf ${User}/.drush/{provision,drush_make}
          mkdir -p ${User}/.drush/{sys,xts,usr}
          ${gCb} ${branch} https://github.com/omega8cc/provision.git \
            ${User}/.drush/sys/provision &> /dev/null
          chown -R ${octUsr}:users ${User}/.drush/sys
          up_mode
        fi
      fi
    else
      echo "${vBs}/${tocName} installer not available - try again"
      clean_pid_exit
    fi
  fi
}

count_cpu() {
  _CPU_INFO=$(grep -c processor /proc/cpuinfo 2>&1)
  _CPU_INFO=${_CPU_INFO//[^0-9]/}
  _NPROC_TEST=$(which nproc 2>&1)
  if [ -z "${_NPROC_TEST}" ]; then
    _CPU_NR="${_CPU_INFO}"
  else
    _CPU_NR=$(nproc 2>&1)
  fi
  _CPU_NR=${_CPU_NR//[^0-9]/}
  if [ ! -z "${_CPU_NR}" ] \
    && [ ! -z "${_CPU_INFO}" ] \
    && [ "${_CPU_NR}" -gt "${_CPU_INFO}" ] \
    && [ "${_CPU_INFO}" -gt "0" ]; then
    _CPU_NR="${_CPU_INFO}"
  fi
  if [ -z "${_CPU_NR}" ] || [ "${_CPU_NR}" -lt "1" ]; then
    _CPU_NR=1
  fi
}

load_control() {
  if [ -e "${barCnf}" ]; then
    source ${barCnf}
    _CPU_MAX_RATIO=${_CPU_MAX_RATIO//[^0-9]/}
  fi
  if [ -z "${_CPU_MAX_RATIO}" ]; then
    _CPU_MAX_RATIO=6
  fi
  _O_LOAD=$(awk '{print $1*100}' /proc/loadavg 2>&1)
  _O_LOAD=$(( _O_LOAD / _CPU_NR ))
  _O_LOAD_MAX=$(( 100 * _CPU_MAX_RATIO ))
}

up_action_all() {
  for User in `find /data/disk/ -maxdepth 1 | sort`; do
    count_cpu
    load_control
    if [ -d "${User}/config/server_master/nginx/vhost.d" ] \
      && [ -e "${User}/log/cores.txt" ] \
      && [ ! -e "${User}/log/CANCELLED" ]; then
      if [ "${_O_LOAD}" -lt "${_O_LOAD_MAX}" ]; then
        octUsr=$(echo ${User} | cut -d'/' -f4 | awk '{ print $1}')
        tocName="${octName}.${octUsr}"
        tocIncO="${filIncO}.${octUsr}"
        octCnf="/root/.${octUsr}.octopus.cnf"
        echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
        echo Octopus upgrade for User ${User}
        n=$((RANDOM%9+2))
        echo Waiting $n seconds...
        sleep $n
        if [ "${silent}" = "log" ]; then
          _UP_LOG="${_LOG_DIR}/$(basename "$0")-up-${octUsr}-${_NOW}.log"
          echo
          echo "Preparing the upgrade in silent mode..."
          echo
          echo "NOTE: There will be no progress displayed in the console"
          echo "but you will receive an email once the upgrade is complete"
          echo
          sleep 5
          echo "You could watch the progress in another window with command:"
          echo "  tail -f ${_UP_LOG}"
          echo "or wait until you will see the line: OCTOPUS upgrade completed"
          echo
          echo "Starting the upgrade in silent mode now..."
          echo
          if [ -e "${vBs}/${octName}" ]; then
            sed -i "s/^_SPINNER=YES/_SPINNER=NO/g"             ${vBs}/${octName}
            wait
            sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"         ${vBs}/${filIncO}
            wait
            sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"         ${octCnf}
            wait
          fi
          up_one >>${_UP_LOG} 2>&1
          check_report
        else
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=NO/g"            ${octCnf}
          wait
          up_one
        fi
        n=$((RANDOM%9+2))
        echo "Waiting $n seconds..."
        sleep $n
        rm -f ${vBs}/${tocName}
        rm -f ${vBs}/${tocIncO}
        echo "Done for ${User}"
      else
        echo "load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}"
        echo "...we have to wait..."
      fi
    fi
  done
}

up_action_one() {
  User="/data/disk/${second}"
  count_cpu
  load_control
  if [ -d "${User}/config/server_master/nginx/vhost.d" ] \
    && [ -e "${User}/log/cores.txt" ] \
    && [ ! -e "${User}/log/CANCELLED" ]; then
    if [ "${_O_LOAD}" -lt "${_O_LOAD_MAX}" ]; then
      octUsr="${second}"
      tocName="${octName}.${octUsr}"
      tocIncO="${filIncO}.${octUsr}"
      octCnf="/root/.${octUsr}.octopus.cnf"
      echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
      echo Octopus upgrade for User ${User}
      sleep 3
      if [ "${silent}" = "log" ]; then
        _UP_LOG="${_LOG_DIR}/$(basename "$0")-up-${octUsr}-${_NOW}.log"
        echo
        echo "Preparing the upgrade in silent mode..."
        echo
        echo "NOTE: There will be no progress displayed in the console"
        echo "but you will receive an email once the upgrade is complete"
        echo
        sleep 5
        echo "You could watch the progress in another window with command:"
        echo "  tail -f ${_UP_LOG}"
        echo "or wait until you will see the line: OCTOPUS upgrade completed"
        echo
        echo "Starting the upgrade in silent mode now..."
        echo
        if [ -e "${vBs}/${octName}" ]; then
          sed -i "s/^_SPINNER=YES/_SPINNER=NO/g"               ${vBs}/${octName}
          wait
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"           ${vBs}/${filIncO}
          wait
          sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=YES/g"           ${octCnf}
          wait
        fi
        up_one >>${_UP_LOG} 2>&1
        check_report
      else
        sed -i "s/^_AUTOPILOT=.*/_AUTOPILOT=NO/g"              ${octCnf}
        wait
        up_one
      fi
      sleep 3
      rm -f ${vBs}/${tocName}
      rm -f ${vBs}/${tocIncO}
      echo Done for ${User}
    else
      echo load is ${_O_LOAD} while maxload is ${_O_LOAD_MAX}
      echo try again later
    fi
  fi
}

up_start() {
  if [ -e "/var/run/boa_run.pid" ]; then
    echo
    echo "  Another BOA installer is running probably"
    echo "  because /var/run/boa_run.pid exists"
    echo
    exit 1
  elif [ -e "/var/run/boa_wait.pid" ]; then
    echo
    echo "  Some important system task is running probably"
    echo "  because /var/run/boa_wait.pid exists"
    echo
    exit 1
  else
    touch /var/run/boa_run.pid
    touch /var/run/boa_wait.pid
    mkdir -p ${_LOG_DIR}
    cd ${vBs}
    rm -f ${vBs}/OCTOPUS.sh*
    ## rm -f ${vBs}/*.sh.cnf*
  fi
  if [ "${cmmode}" = "log" ]; then
    silent="${cmmode}"
  fi
  if [ ! -z "${cmmode}" ] && [ "${cmmode}" != "log" ]; then
    mcmode="${cmmode}"
    orgMcmode="${mcmode}"
  fi
  if [ -e "/opt/local/bin/php" ] || [ -e "/usr/local/bin/php" ]; then
    rm -f /opt/local/bin/php
    rm -f /usr/local/bin/php
  fi
  if [ "${cmmand}" = "up-cluster" ]; then
    if [ ! -e "/var/run/mysqld/mysqld.pid" ] \
      && [ ! -e "/root/.dbhd.clstr.cnf" ] \
      && [ -e "/etc/init.d/mysql" ]; then
      rm -f /root/.remote.db.cnf
      sleep 5
      if [ ! -e "/var/run/mysqld/mysqld.sock" ]; then
        service mysql start &> /dev/null
      fi
    fi
  fi
  orgCmmand="${cmmand}"
}

up_finish() {
  rm -f /root/BOA.sh*
  rm -f /var/run/boa_run.pid
  rm -f /var/run/boa_wait.pid
  rm -f /var/run/manage_ltd_users.pid
  rm -f /var/run/manage_rvm_users.pid
  rm -f ${vBs}/*.sh.cnf*
  rm -f ${vBs}/OCTOPUS.sh*
  if [ -e "/opt/local/bin/php" ] || [ -e "/usr/local/bin/php" ]; then
    rm -f /opt/local/bin/php
    rm -f /usr/local/bin/php
  fi
  rm -rf /opt/tmp/*
  echo
  echo OCTOPUS upgrade completed
  echo Bye
  echo
  exit 0
}

up_dev() {
  up_start
  curl ${crlGet} "${rgUrl}/${dvmstr}/${octName}"  -o ${vBs}/${octName}
  curl ${crlGet} "${rgUrl}/${dvmstr}/${pthIncO}"  -o ${vBs}/${filIncO}
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

up_head() {
  up_start
  if [ "${silent}" = "cluster" ] \
    || [ "${silent}" = "foobar" ]; then
    echo "FEATURE MODE: ${silent}"
    master="feature/${silent}"
    branch="feature/${silent}"
  fi
  curl ${crlGet} "${rgUrl}/${mstr}/${octName}"  -o ${vBs}/${octName}
  curl ${crlGet} "${rgUrl}/${mstr}/${pthIncO}"  -o ${vBs}/${filIncO}
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

up_cluster() {
  up_start
  branch="2.4.x-dev"
  curl ${crlGet} "${rgUrl}/${cluster}/${octName}" -o ${vBs}/${octName}
  curl ${crlGet} "${rgUrl}/${cluster}/${pthIncO}" -o ${vBs}/${filIncO}
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

up_stable() {
  up_start
  curl ${crlGet} "${rgUrl}/${stbl}/${octName}"    -o ${vBs}/${octName}
  curl ${crlGet} "${rgUrl}/${stbl}/${pthIncO}"    -o ${vBs}/${filIncO}
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

up_legacy() {
  up_start
  if [ "${cmmand}" = "up-3.2" ]; then
    branch="3.2.x-dev"
    curl ${crlGet} "${rgUrl}/${lgcD}/${octName}"  -o ${vBs}/${octName}
    curl ${crlGet} "${rgUrl}/${lgcD}/${pthIncO}"  -o ${vBs}/${filIncO}
  elif [ "${cmmand}" = "up-2.4" ]; then
    branch="2.4.x-dev"
    curl ${crlGet} "${rgUrl}/${lgcC}/${octName}"  -o ${vBs}/${octName}
    curl ${crlGet} "${rgUrl}/${lgcC}/${pthIncO}"  -o ${vBs}/${filIncO}
  elif [ "${cmmand}" = "up-2.3" ]; then
    branch="2.3.x-dev"
    curl ${crlGet} "${rgUrl}/${lgcB}/${octName}"  -o ${vBs}/${octName}
  elif [ "${cmmand}" = "up-2.2" ]; then
    branch="2.2.x-legacy"
    curl ${crlGet} "${rgUrl}/${lgcA}/${octName}"  -o ${vBs}/${octName}
  fi
  if [ "${second}" = "all" ]; then
    up_action_all
  else
    up_action_one
  fi
  up_finish
}

find_fast_mirror() {
  isNetc=$(which netcat 2>&1)
  if [ ! -x "${isNetc}" ] || [ -z "${isNetc}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install netcat ${aptYesUnth} &> /dev/null
    sleep 3
  fi
  ffMirr=$(which ffmirror 2>&1)
  if [ -x "${ffMirr}" ]; then
    ffList="/var/backups/boa-mirrors-2023-01.txt"
    mkdir -p /var/backups
    if [ ! -e "${ffList}" ]; then
      echo "de.files.aegir.cc"  > ${ffList}
      echo "ny.files.aegir.cc" >> ${ffList}
      echo "sg.files.aegir.cc" >> ${ffList}
    fi
    if [ -e "${ffList}" ]; then
      _BROKEN_FFMIRR_TEST=$(grep "stuff" ${ffMirr} 2>&1)
      if [[ "${_BROKEN_FFMIRR_TEST}" =~ "stuff" ]]; then
        _CHECK_MIRROR=$(bash ${ffMirr} < ${ffList} 2>&1)
        _USE_MIR="${_CHECK_MIRROR}"
        [[ "${_USE_MIR}" =~ "printf" ]] && _USE_MIR="files.aegir.cc"
      else
        _USE_MIR="files.aegir.cc"
      fi
    else
      _USE_MIR="files.aegir.cc"
    fi
  else
    _USE_MIR="files.aegir.cc"
  fi
  urlDev="http://${_USE_MIR}/dev"
  urlHmr="http://${_USE_MIR}/versions/stable/boa/aegir"
}

check_dns_curl() {
  if [ ! -e "/etc/resolv.conf" ]; then
    rm -f /etc/resolv.conf
    if [ -e "${vBs}/resolv.conf.vanilla" ]; then
      cat ${vBs}/resolv.conf.vanilla >/etc/resolv.conf
    fi
    echo "nameserver 1.1.1.1" >>/etc/resolv.conf
    echo "nameserver 1.0.0.1" >>/etc/resolv.conf
    check_dns_settings
  else
    check_dns_settings
  fi
  if [ -d "/var/cache/pdnsd" ] \
    && [ -e "/etc/resolvconf/run/interface/lo.pdnsd" ]; then
    pdnsd-ctl empty-cache &> /dev/null
  fi
  find_fast_mirror
  isCurl=$(curl --version 2>&1)
  if [[ ! "${isCurl}" =~ "OpenSSL" ]] || [ -z "${isCurl}" ]; then
    rm -f /etc/apt/sources.list.d/openssl.list
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    echo "curl install" | dpkg --set-selections &> /dev/null
    apt_clean_update
    apt-get install curl ${aptYesUnth} &> /dev/null
    mkdir -p /var/backups/libcurl
    mv -f /usr/local/lib/libcurl* /var/backups/libcurl/ &> /dev/null
    mv -f /usr/local/lib/pkgconfig/libcurl* /var/backups/libcurl/ &> /dev/null
    touch /root/.use.curl.from.packages.cnf
  fi
  _CURL_TEST=$(curl -L -k -s \
    --max-redirs 10 \
    --retry 3 \
    --retry-delay 10 \
    -I "http://${_USE_MIR}" 2> /dev/null)
  if [[ ! "${_CURL_TEST}" =~ "200 OK" ]]; then
    if [[ "${_CURL_TEST}" =~ "unknown option was passed in to libcurl" ]]; then
      echo "curl install" | dpkg --set-selections &> /dev/null
      apt_clean_update
      apt-get install curl ${aptYesUnth} &> /dev/null
      mkdir -p /var/backups/libcurl
      mv -f /usr/local/lib/libcurl* /var/backups/libcurl/ &> /dev/null
      mv -f /usr/local/lib/pkgconfig/libcurl* /var/backups/libcurl/ &> /dev/null
      touch /root/.use.curl.from.packages.cnf
    fi
    echo "ERROR: ${_USE_MIR} is not available, please try later"
    clean_pid_exit
  fi
}

check_root_direct() {
  _U_TEST=DENY
  [ "${SUDO_USER}" ] && _U_TEST_SDO=${SUDO_USER} || _U_TEST_SDO=`whoami`
  _U_TEST_WHO=$(who am i | awk '{print $1}' 2>&1)
  _U_TEST_LNE=$(logname 2>&1)
  if [ "${_U_TEST_SDO}" = "root" ] || [ "${_U_TEST_LNE}" = "root" ]; then
    if [ -z "${_U_TEST_WHO}" ]; then
      _U_TEST=ALLOW
      ### normal for root scripts running from cron
    else
      if [ "${_U_TEST_WHO}" = "root" ]; then
        _U_TEST=ALLOW
      fi
    fi
  fi
  if [ "${_U_TEST}" = "DENY" ]; then
    echo
    echo "ERROR: This script must be run as root directly,"
    echo "ERROR: without sudo/su switch from regular system user"
    echo "ERROR: Please add and test your SSH (RSA) keys for root account"
    echo "ERROR: with direct access before trying again"
    echo
    echo "HINT:  You can always restrict access later, or"
    echo "       allow only SSH (RSA) keys for root with directive"
    echo "         PermitRootLogin without-password"
    echo "       in the /usr/etc/sshd_config file"
    echo "Bye"
    clean_pid_exit
  fi
}

check_root_keys_pwd() {
  _S_TEST=$(grep "root:\*:" /etc/shadow 2>&1)
  _R_TEST=CHECK
  if [ -e "/root/.ssh/authorized_keys" ]; then
    _R_TEST=$(grep "ssh-rsa" /root/.ssh/authorized_keys 2>&1)
  fi
  if [[ ! "${_S_TEST}" =~ "root:" ]] \
    && [[ ! "${_R_TEST}" =~ "ssh-rsa" ]]; then
    echo
    echo "ERROR: BOA requires working SSH (RSA) keys for system root present"
    echo "ERROR: Please add and test your SSH (RSA) keys for root account"
    echo "ERROR: before trying again"
    echo
    echo "HINTS: Run this command on your local PC machine:"
    echo "HINTS:   ssh-keygen -b 4096 -t rsa -N '' -f ~/.ssh/id_rsa"
    echo "HINTS: Then copy the ~/.ssh/id_rsa.pub file from your PC"
    echo "HINTS: to ~/.ssh/authorized_keys file on the server"
    echo "HINTS: Make sure the key is not split into more than 1 line"
    echo "HINTS: Remember to run: chmod 600 ~/.ssh/authorized_keys"
    echo
    echo "Bye"
    echo
    clean_pid_exit
  fi
}

check_root() {
  if [ `whoami` = "root" ]; then
    if [ -e "/root/.barracuda.cnf" ]; then
      source /root/.barracuda.cnf
      _B_NICE=${_B_NICE//[^0-9]/}
    fi
    if [ -z "${_B_NICE}" ]; then
      _B_NICE=10
    fi
    renice ${_B_NICE} -p $$ &> /dev/null
    ionice -c2 -n7 -p $$
    chmod a+w /dev/null
    if [ ! -e "/dev/fd" ]; then
      if [ -e "/proc/self/fd" ]; then
        rm -rf /dev/fd
        ln -s /proc/self/fd /dev/fd
      fi
    fi
    sed -i "s/.*173.231.133.190.*//g" /etc/hosts
    wait
    sed -i "s/^127.0.0.1.*/127.0.0.1 localhost/g" /etc/hosts
    wait
    sed -i "s/.*files.aegir.cc.*//g" /etc/hosts
    wait
    sed -i "s/.*github.*//g" /etc/hosts
    wait
    echo >>/etc/hosts
    sed -i "/^$/d" /etc/hosts
    wait
    if [ -e "/etc/init.d/postfix" ]; then
      service postfix restart &> /dev/null
    fi
  else
    echo "ERROR: This script should be ran as a root user"
    clean_pid_exit
  fi
  _DF_TEST=$(df -kTh / -l \
    | grep '/' \
    | sed 's/\%//g' \
    | awk '{print $6}' 2> /dev/null)
  _DF_TEST=${_DF_TEST//[^0-9]/}
  if [ ! -z "${_DF_TEST}" ] && [ "${_DF_TEST}" -gt "90" ]; then
    echo "ERROR: Your disk space is almost full !!! ${_DF_TEST}/100"
    echo "ERROR: We can not proceed until it is below 90/100"
    clean_pid_exit
  fi
}

check_no_systemd() {
  if [ -e "/lib/systemd/systemd" ]; then
    echo "ERROR: This script can not be used with systemd"
    echo "ERROR: Please run 'boa init' first"
    clean_pid_exit
  fi
}

check_root_direct
check_root_keys_pwd
check_root
check_no_systemd
os_detection_minimal
check_dns_curl

case "$1" in
  up-head)   cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_head
  ;;
  up-dev)    cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_dev
  ;;
  up-stable) cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_head
  ;;
  up-cluster) cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_cluster
  ;;
  up-legacy) cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_stable
  ;;
  up-3.2)    cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_legacy "3.2"
  ;;
  up-2.4)    cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_legacy "2.4"
  ;;
  up-2.3)    cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_legacy "2.3"
  ;;
  up-2.2)    cmmand="$1"
             second="$2"
             cmmode="$3"
             silent="$4"
             up_legacy "2.2"
  ;;
  *)         echo
             echo "Usage: $(basename "$0") {up-head|up-stable|up-dev} {all|o1} {aegir|platforms|both|force}"
             echo
             clean_pid_exit
  ;;
esac

#!/bin/bash


###----------------------------------------###
###
###  Automatic BOA System AUTO-INIT Tool
###
###  Copyright (C) 2010-2024 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: https://github.com/omega8cc/boa
###
###----------------------------------------###


###----------------------------------------###
### HOW-TO: Launch AUTO-INIT properly      ###
###----------------------------------------###
###
###  Use clean minimal Debian OS based VPS.
###
###  Initialise the system before installing
###  BOA to either remove systemd and use
###  Debian or also quickly upgrade to the
###  compatible Devuan OS version.
###
###   $ wget http://files.aegir.cc/BOA.sh.txt
###   $ bash BOA.sh.txt
###   $ touch /root/.init-to-devuan-loop.cnf
###      OR
###   $ touch /root/.init-to-debian.cnf
###   $ autoinit
###
###  Once started, the autoinit will launch
###  a series of boa init/reboots until
###  you get a basic latest system installed
###  to be able to run standard BOA install.
###
###  The script logs its actions in the file
###  you can examine later:
###
###   $ cat /root/.autoinit.log
###
###  If you prefer to have verbose log mode:
###
###   $ touch /root/.autoinit-verbose.cnf
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

HOME=/root
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/local/sbin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin

export PATH=${PATH}
export SHELL=${SHELL}
export HOME=${HOME}

barCnf="/root/.barracuda.cnf"
logInt="/root/.autoinit.log"
logSlt="/root/.autoinit-silent.log"

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi
tRee=dev
export tRee="${tRee}"
_INITINS="/usr/bin/apt-get -y --allow-unauthenticated install"
dstUpArg="-fuy --allow-unauthenticated -q --config-file /opt/apt/apt.conf.noi.dist"
nrmUpArg="-fuy --allow-unauthenticated -q --config-file /opt/apt/apt.conf.noi.nrml"

#

check_root() {
  if [ `whoami` = "root" ]; then
    ionice -c2 -n7 -p $$
    renice 19 -p $$
    chmod a+w /dev/null
    if [ ! -e "/dev/fd" ]; then
      if [ -e "/proc/self/fd" ]; then
        rm -rf /dev/fd
        ln -s /proc/self/fd /dev/fd
      fi
    fi
  else
    echo "ERROR: This script should be ran as a root user"
    exit 1
  fi
  _DF_TEST=$(df -kTh / -l \
    | grep '/' \
    | sed 's/\%//g' \
    | awk '{print $6}' >> ${logSlt})
  _DF_TEST=${_DF_TEST//[^0-9]/}
  if [ ! -z "${_DF_TEST}" ] && [ "${_DF_TEST}" -gt "90" ]; then
    echo "ERROR: Your disk space is almost full !!! ${_DF_TEST}/100"
    echo "ERROR: We can not proceed until it is below 90/100"
    exit 1
  fi
}
check_root
cd /root/

if [ -e "/var/aegir" ]; then
  echo
  echo "ERROR: This script can not be used once BOA is installed"
  echo
  exit 1
fi

###
### Noticeable messages
###
msg() {
  echo "AutoInit [$(date +%T 2>&1)] ==> $*"
}

if [ -e "/var/run/autoinit.pid" ]; then
  echo " " >> ${logSlt}
  msg "The /var/run/autoinit.pid is blocking this run..." >> ${logSlt}
  echo " " >> ${logSlt}
  exit 1
fi

if [ -e "/root/.autoinit-verbose.cnf" ]; then
  silentMode=verbose
else
  silentMode=silent
fi

init_pre() {
  if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
    && [ -e "/etc/apt/apt.conf.d" ]; then
    echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
  fi
  if [ ! -e "/opt/apt/apt.conf.noi.dist" ] \
    || [ ! -e "/opt/apt/apt.conf.noi.nrml" ]; then
    mkdir -p /opt/apt
    echo "APT::Get::Assume-Yes \"true\";" > /opt/apt/apt.conf.noi.dist
    echo "APT::Get::Show-Upgraded \"true\";" >> /opt/apt/apt.conf.noi.dist
    echo "APT::Get::Install-Recommends \"false\";" >> /opt/apt/apt.conf.noi.dist
    echo "APT::Get::Install-Suggests \"false\";" >> /opt/apt/apt.conf.noi.dist
    echo "APT::Quiet \"true\";" >> /opt/apt/apt.conf.noi.dist
    echo "DPkg::Options {\"--force-confnew\";\"--force-confmiss\";};" >> /opt/apt/apt.conf.noi.dist
    echo "DPkg::Pre-Install-Pkgs {\"/usr/sbin/dpkg-preconfigure --apt\";};" >> /opt/apt/apt.conf.noi.dist
    echo "Dir::Etc::SourceList \"/etc/apt/sources.list\";" >> /opt/apt/apt.conf.noi.dist
    echo "APT::Get::Assume-Yes \"true\";" > /opt/apt/apt.conf.noi.nrml
    echo "APT::Get::Show-Upgraded \"true\";" >> /opt/apt/apt.conf.noi.nrml
    echo "APT::Get::Install-Recommends \"false\";" >> /opt/apt/apt.conf.noi.nrml
    echo "APT::Get::Install-Suggests \"false\";" >> /opt/apt/apt.conf.noi.nrml
    echo "APT::Quiet \"true\";" >> /opt/apt/apt.conf.noi.nrml
    echo "DPkg::Options {\"--force-confdef\";\"--force-confmiss\";\"--force-confold\"};" >> /opt/apt/apt.conf.noi.nrml
    echo "DPkg::Pre-Install-Pkgs {\"/usr/sbin/dpkg-preconfigure --apt\";};" >> /opt/apt/apt.conf.noi.nrml
    echo "Dir::Etc::SourceList \"/etc/apt/sources.list\";" >> /opt/apt/apt.conf.noi.nrml
  fi
  _SYS_IFNAMES=$(grep GRUB_CMDLINE_LINUX= /etc/default/grub | grep "net.ifnames=0" 2>&1)
  if [ -e "/etc/default/grub" ] && [[ ! "${_SYS_IFNAMES}" =~ "net.ifnames=0" ]]; then
    echo "Running init_pre procedure A..."
    touch /var/run/autoinit.pid
    echo "OOPS, we need to fix GRUB_CMDLINE_LINUX and reboot first"
    echo "But do not worry, just log in back in five minutes"
    echo 'GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 memhp_default_state=online"' >> /etc/default/grub
    if [ "${silentMode}" = "verbose" ]; then
      grub-mkconfig -o /boot/grub/grub.cfg >> ${logInt}
    else
      grub-mkconfig -o /boot/grub/grub.cfg >> ${logSlt}
    fi
    echo "Waiting five seconds before reboot..."
    sleep 5
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo "*/1 *   * * *   root    bash /opt/local/bin/autoinit" >> /etc/crontab
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  else
    if [ ! -x "/usr/bin/aptitude" ] || [ ! -x "/usr/bin/cc" ]; then
      echo "Running init_pre procedure B..."
      touch /var/run/autoinit.pid
      /usr/bin/apt-get update >> ${logSlt}
      ${_INITINS} lsb-release >> ${logSlt}
      _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
      _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
      msg "This system is ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
      msg "We need to install some tools early..." >> ${logInt}
      echo " " >> ${logInt}
      if [ "${silentMode}" = "verbose" ]; then
        echo " " >> ${logInt}
        /usr/bin/apt-get update >> ${logInt}
        _INITD_TEST=$(ls -la /etc/init.d/*cloud* 2>&1)
        if [[ ! "${_INITD_TEST}" =~ "No such file" ]] \
          || [ -e "/etc/cloud/cloud.cfg.d" ]; then
          /usr/bin/apt-get remove cloud-utils cloud-init -y -qq --purge --auto-remove --allow-remove-essential >> ${logInt}
          /usr/bin/apt-get remove cloud-image-utils cloud-guest-utils -y -qq --purge --auto-remove --allow-remove-essential >> ${logInt}
          /usr/bin/apt-get autoremove --purge -y >> ${logInt}
          /usr/bin/apt-get autoclean -y >> ${logInt}
          if [ -e "/etc/cloud/cloud.cfg.d" ]; then
            mv -f /etc/cloud /var/backups/
          fi
        fi
        ${_INITINS} locales-all aptitude >> ${logInt}
        ${_INITINS} build-essential curl git >> ${logInt}
        ${_INITINS} libgd-dev libmagickwand-dev libcurl4-openssl-dev >> ${logInt}
      else
        echo " " >> ${logSlt}
        /usr/bin/apt-get update >> ${logSlt}
        _INITD_TEST=$(ls -la /etc/init.d/*cloud* 2>&1)
        if [[ ! "${_INITD_TEST}" =~ "No such file" ]] \
          || [ -e "/etc/cloud/cloud.cfg.d" ]; then
          /usr/bin/apt-get remove cloud-utils cloud-init -y -qq --purge --auto-remove --allow-remove-essential >> ${logSlt}
          /usr/bin/apt-get remove cloud-image-utils cloud-guest-utils -y -qq --purge --auto-remove --allow-remove-essential >> ${logSlt}
          /usr/bin/apt-get autoremove --purge -y >> ${logSlt}
          /usr/bin/apt-get autoclean -y >> ${logSlt}
          if [ -e "/etc/cloud/cloud.cfg.d" ]; then
            mv -f /etc/cloud /var/backups/
          fi
        fi
        ${_INITINS} locales-all aptitude >> ${logSlt}
        ${_INITINS} build-essential curl git >> ${logSlt}
        ${_INITINS} libgd-dev libmagickwand-dev libcurl4-openssl-dev >> ${logSlt}
      fi
      echo "Waiting five seconds before reboot..."
      sleep 5
      sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
      echo "*/1 *   * * *   root    bash /opt/local/bin/autoinit" >> /etc/crontab
      rm -f /var/run/autoinit.pid
      reboot
      exit 0
    fi
  fi
}

init_info() {
  echo "Running init_pre procedure, please wait..."
  sleep 3
  echo "The system will reboot and continue several times..."
  sleep 3
  if [ -e "/root/.init-to-devuan-loop.cnf" ]; then
    echo "until it is ugraded to latest Devuan/daedalus version."
  else
    echo "until it is ugraded to systemd-free Debian version."
  fi
  sleep 3
  echo "Once all upgrades are complete, you can run boa install"
  sleep 3
  echo "Let's go!"
  sleep 3
  echo "It will take only a few minutes..."
}

init_run_two_quick() {
  echo " " >> ${logInt}
  _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  msg "Running init_run_two_quick procedure..." >> ${logInt}
  touch /var/run/autoinit.pid
  msg "Launching a quick dist-upgrade to ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
  if [ ! -e "/etc/apt/preferences.d/offsystemd" ]; then
    rm -f /etc/apt/preferences.d/systemd
    echo -e 'Package: systemd\nPin: release *\nPin-Priority: -1' > /etc/apt/preferences.d/offsystemd
    echo -e '\n\nPackage: *systemd*\nPin: release *\nPin-Priority: -1' >> /etc/apt/preferences.d/offsystemd
  fi
  if [ "${silentMode}" = "verbose" ]; then
    /usr/bin/apt-get update >> ${logInt}
    /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logInt}
    /usr/bin/apt-get remove systemd -y -qq --purge --auto-remove --allow-remove-essential >> ${logInt}
    /usr/bin/apt-get remove libnss-systemd -y -qq --purge --auto-remove --allow-remove-essential >> ${logInt}
    /usr/bin/apt-get remove systemd-sysv -y -qq --purge --auto-remove --allow-remove-essential >> ${logInt}
    /usr/bin/apt-get autoremove --purge -y >> ${logInt}
    /usr/bin/apt-get autoclean -y >> ${logInt}
  else
    /usr/bin/apt-get update -qq >> ${logSlt}
    /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logSlt}
    /usr/bin/apt-get remove systemd -y -qq --purge --auto-remove --allow-remove-essential >> ${logSlt}
    /usr/bin/apt-get remove libnss-systemd -y -qq --purge --auto-remove --allow-remove-essential >> ${logSlt}
    /usr/bin/apt-get remove systemd-sysv -y -qq --purge --auto-remove --allow-remove-essential >> ${logSlt}
    /usr/bin/apt-get autoremove --purge -y -qq >> ${logSlt}
    /usr/bin/apt-get autoclean -y -qq >> ${logSlt}
  fi
  _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  msg "Your system now runs on ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
  if [ "${_OS_CODE}" = "daedalus" ]; then
    msg "Time for reboot and then you can run boa install" >> ${logInt}
    rm -f /root/.init-to-devuan.cnf
    rm -f /root/.init-to-devuan-loop.cnf
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
  else
    msg "Time for reboot and next upgrade cycle..." >> ${logInt}
  fi
  echo " " >> ${logInt}
  sleep 5
  touch /root/.run-two-devuan-quick.cnf
  rm -f /var/run/autoinit.pid
  reboot
  exit 0
}

init_run_one_quick() {
  echo " " >> ${logInt}
  _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  msg "Running init_run_one_quick procedure..." >> ${logInt}
  touch /var/run/autoinit.pid
  msg "Your current system is ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
  echo " " >> ${logInt}
  _NEW_SYS=Devuan
  _OLD_SYS=Devuan
  if [ "${_OS_CODE}" = "bookworm" ]; then
    _NEW_OS_CODE=daedalus
    _OLD_SYS=Debian
  elif [ "${_OS_CODE}" = "bullseye" ]; then
    _NEW_OS_CODE=chimaera
    _OLD_SYS=Debian
  elif [ "${_OS_CODE}" = "buster" ]; then
    _NEW_OS_CODE=beowulf
    _OLD_SYS=Debian
  elif [ "${_OS_CODE}" = "beowulf" ]; then
    _NEW_OS_CODE=chimaera
  elif [ "${_OS_CODE}" = "chimaera" ]; then
    _NEW_OS_CODE=daedalus
  elif [ "${_OS_CODE}" = "daedalus" ]; then
    _NEW_OS_CODE=
    _NEW_SYS=
  else
    msg "This procedure does not support ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
    msg "Bye!" >> ${logInt}
    echo " " >> ${logInt}
    exit 1
  fi
  if [ "${_OLD_SYS}" = "Devuan" ]; then
    if [ "${silentMode}" = "verbose" ]; then
      /usr/bin/apt-get update >> ${logInt}
      /usr/bin/apt-get upgrade ${nrmUpArg} >> ${logInt}
    else
      /usr/bin/apt-get update -qq >> ${logSlt}
      /usr/bin/apt-get upgrade ${nrmUpArg} >> ${logSlt}
    fi
  fi
  if [ ! -z "${_NEW_OS_CODE}" ] && [ ! -z "${_NEW_SYS}" ]; then
    msg "Launching a quick upgrade to ${_NEW_SYS}/${_NEW_OS_CODE}" >> ${logInt}
    echo " " >> ${logInt}
    aptLiSys="/etc/apt/sources.list"
    _TGT_MRR="deb.devuan.org/merged"
    echo "## DEVUAN MAIN REPOSITORIES" > ${aptLiSys}
    echo "deb http://${_TGT_MRR} ${_NEW_OS_CODE} main" >> ${aptLiSys}
    echo "deb-src http://${_TGT_MRR} ${_NEW_OS_CODE} main" >> ${aptLiSys}
    echo "" >> ${aptLiSys}
    echo "## MAJOR BUG FIX UPDATES produced after the final release" >> ${aptLiSys}
    echo "deb http://${_TGT_MRR} ${_NEW_OS_CODE}-updates main" >> ${aptLiSys}
    echo "deb-src http://${_TGT_MRR} ${_NEW_OS_CODE}-updates main" >> ${aptLiSys}
    echo "" >> ${aptLiSys}
    echo "## DEVUAN SECURITY UPDATES" >> ${aptLiSys}
    echo "deb http://${_TGT_MRR} ${_NEW_OS_CODE}-security main" >> ${aptLiSys}
    echo "deb-src http://${_TGT_MRR} ${_NEW_OS_CODE}-security main" >> ${aptLiSys}
    if [ -e "/etc/apt/apt.conf" ]; then
      rm -f /etc/apt/apt.conf
    fi
  fi
  if [ ! -z "${_NEW_OS_CODE}" ] && [ ! -z "${_NEW_SYS}" ]; then
    if [ "${silentMode}" = "verbose" ]; then
      if [ "${_OLD_SYS}" = "Debian" ]; then
        /usr/bin/apt-get update --allow-insecure-repositories >> ${logInt}
        /usr/bin/apt-get -y --allow-unauthenticated install devuan-keyring >> ${logInt}
      fi
      /usr/bin/apt-get update >> ${logInt}
      /usr/bin/apt-get upgrade ${dstUpArg} >> ${logInt}
      if [ "${_OLD_SYS}" = "Debian" ]; then
        /usr/bin/apt-get install eudev sysvinit-core -y >> ${logInt}
        /usr/bin/apt-get -f install -y >> ${logInt}
      else
        /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logInt}
        /usr/bin/apt-get -f install -y >> ${logInt}
        /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logInt}
        /usr/bin/apt-get autoremove --purge -y >> ${logInt}
        /usr/bin/apt-get autoclean -y >> ${logInt}
      fi
    else
      if [ "${_OLD_SYS}" = "Debian" ]; then
        /usr/bin/apt-get update --allow-insecure-repositories -qq >> ${logSlt}
        /usr/bin/apt-get -y --allow-unauthenticated install devuan-keyring -qq >> ${logSlt}
      fi
      /usr/bin/apt-get update -qq >> ${logSlt}
      /usr/bin/apt-get upgrade ${dstUpArg} >> ${logSlt}
      if [ "${_OLD_SYS}" = "Debian" ]; then
        /usr/bin/apt-get install eudev sysvinit-core -y -qq >> ${logSlt}
        /usr/bin/apt-get -f install -y -qq >> ${logSlt}
      else
        /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logSlt}
        /usr/bin/apt-get -f install -y -qq >> ${logSlt}
        /usr/bin/apt-get dist-upgrade ${dstUpArg} >> ${logSlt}
        /usr/bin/apt-get autoremove --purge -y -qq >> ${logSlt}
        /usr/bin/apt-get autoclean -y -qq >> ${logSlt}
      fi
    fi
  fi
  _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  if [ "${_OLD_SYS}" = "Debian" ]; then
    msg "Your initial Debian system now runs on ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
    msg "Time for reboot and next upgrade cycle..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    touch /root/.run-one-devuan-quick.cnf
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  else
    if [ "${_OS_CODE}" = "daedalus" ]; then
      msg "Your system now runs on ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
      msg "Time for the last reboot and then you can run boa install" >> ${logInt}
      rm -f /root/.init-to-devuan.cnf
      rm -f /root/.init-to-devuan-loop.cnf
      sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    else
      msg "Your system now runs on ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
      msg "Time for reboot and next upgrade cycle..." >> ${logInt}
    fi
    echo " " >> ${logInt}
    sleep 5
    touch /root/.run-one-devuan-quick.cnf
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  fi
}

init_run_three() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching a third run of ${initRun}" >> ${logInt}
    touch /var/run/autoinit.pid
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-three-devuan.cnf
    rm -f /root/.init-to-devuan.cnf
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo "*/1 *   * * *   root    test -e /root/.run.devuan.os.upgrade.on.init.cnf && { bash /etc/init.d/clean-boa-env start; }" >> /etc/crontab
    rm -f /var/run/autoinit.pid
  fi
}

init_run_two() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching a second run of ${initRun}" >> ${logInt}
    touch /var/run/autoinit.pid
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-two-devuan.cnf
    msg "Time for the second reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    if [ ! -e "/root/.init-to-devuan-loop.cnf" ]; then
      touch /root/.run.devuan.os.upgrade.on.init.cnf
    else
      rm -f /root/.run.devuan.os.upgrade.on.init.cnf
    fi
    reboot
    exit 0
  elif [ "${initArgs}" = "debian" ]; then
    echo " " >> ${logInt}
    msg "Launching a second run of ${initRun}" >> ${logInt}
    touch /var/run/autoinit.pid
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-two-debian.cnf
    msg "Time for the second reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  fi
}

init_run_one() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching a first run of ${initRun}" >> ${logInt}
    touch /var/run/autoinit.pid
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-one-devuan.cnf
    msg "Time for the first reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo "*/1 *   * * *   root    bash /opt/local/bin/autoinit devuan" >> /etc/crontab
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  elif [ "${initArgs}" = "debian" ]; then
    echo " " >> ${logInt}
    msg "Launching a first run of ${initRun}" >> ${logInt}
    touch /var/run/autoinit.pid
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-one-debian.cnf
    msg "Time for the first reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo "*/1 *   * * *   root    bash /opt/local/bin/autoinit debian" >> /etc/crontab
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  fi
}

init_conf() {
  if [ "${tRee}" = "dev" ]; then
    initCmnd="init-dev"
  else
    initCmnd="init"
  fi
  if [ -e "/root/.init-to-devuan-loop.cnf" ]; then
    initArgs="devuan"
    initFile="/root/.init-to-devuan-loop.cnf"
  elif [ -e "/root/.init-to-devuan.cnf" ]; then
    initArgs="devuan"
    initFile="/root/.init-to-devuan.cnf"
  else
    initArgs="debian"
    initFile="/root/.init-to-debian.cnf"
  fi
  initRun="${initCmnd} ${initArgs}"
  if [ ! -z "${initFile}" ] && [ -e "${initFile}" ]; then
    if [ ! -x "/usr/bin/cc" ]; then
      init_info
    fi
    init_pre &> /dev/null
  fi
}

init() {
  initCmnd=
  initArgs=
  initRun=
  initFile=
  init_conf
  if [ -e "/root/.init-to-devuan-loop.cnf" ]; then
    if [ -e "/root/.run-one-devuan-quick.cnf" ] \
      && [ ! -e "/root/.run-two-devuan-quick.cnf" ]; then
      init_run_two_quick
    fi
    init_run_one_quick
  else
    if [ ! -e "/root/.run-one-devuan.cnf" ] \
      && [ ! -e "/root/.run-one-debian.cnf" ]; then
      init_run_one
    fi
    if [ -e "/root/.run-one-devuan.cnf" ] \
      || [ -e "/root/.run-one-debian.cnf" ]; then
      if [ ! -e "/root/.run-two-devuan.cnf" ] \
        && [ ! -e "/root/.run-two-debian.cnf" ]; then
        init_run_two
      fi
    fi
    if [ -e "/root/.run-two-devuan.cnf" ]; then
      if [ ! -e "/root/.run-three-devuan.cnf" ]; then
        init_run_three
      fi
    fi
  fi
}

pre() {
  if [ -e "/root/.init-to-devuan.cnf" ] \
    || [ -e "/root/.init-to-debian.cnf" ] \
    || [ -e "/root/.init-to-devuan-loop.cnf" ]; then
    _OS_DIST=$(lsb_release -ar 2>/dev/null | grep -i distributor | cut -s -f2 2>&1)
    _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
    touch /var/run/autoinit.pid
    echo "Launching BOA System INIT on ${_OS_DIST}/${_OS_CODE}"
    echo "Watch the progress with: tail -f /root/.autoinit.log"
    msg "Launching BOA System INIT on ${_OS_DIST}/${_OS_CODE}" >> ${logInt}
    sleep 15
    init
  else
    echo "Welcome to BOA System INIT"
    echo "This script requires one of supported command files:"
    echo "  for Devuan: touch /root/.init-to-devuan-loop.cnf"
    echo "  for Debian: touch /root/.init-to-debian.cnf"
    echo "Bye!"
    exit 1
  fi
}

if [ ! -e "/var/run/autoinit.pid" ]; then
  pre
fi

exit 0

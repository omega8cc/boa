#!/bin/bash


###----------------------------------------###
###
###  Automatic BOA System AUTO-INIT Tool
###
###  Copyright (C) 2010-2024 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: https://github.com/omega8cc/boa
###
###----------------------------------------###


###----------------------------------------###
### HOW-TO: Launch AUTO-INIT properly      ###
###----------------------------------------###
###
###  Use clean minimal Debian OS based VPS.
###
###  Install and run BOA basic tools:
###
###   $ wget http://files.aegir.cc/BOA.sh.txt
###   $ bash BOA.sh.txt
###   $ touch /root/.run-to-devuan.cnf
###      OR
###   $ touch /root/.run-to-debian.cnf
###   $ autoinit
###
###  Once started, the autoinit will launch
###  a series of boa init/reboots until
###  you get a basic latest system installed
###  to be able to run standard BOA install.
###
###  The script may not start automatically
###  after the first reboot, so you need
###  to watch the log file after each reboot:
###
###   $ tail -f /root/.autoinit.log
###
###  If there is no progress, simply launch
###  the procedure again with:
###
###   $ autoinit
###
###----------------------------------------###


###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

HOME=/root
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/local/sbin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin

export PATH=${PATH}
export SHELL=${SHELL}
export HOME=${HOME}

barCnf="/root/.barracuda.cnf"
logInt="/root/.autoinit.log"

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi

tRee=dev
export tRee="${tRee}"

_TODAY=$(date +%y%m%d 2>&1)
_TODAY=${_TODAY//[^0-9]/}
_X_SE="520devT02"
_THIS_SYS=check
#

check_root() {
  if [ `whoami` = "root" ]; then
    ionice -c2 -n7 -p $$
    renice 19 -p $$
    chmod a+w /dev/null
    if [ ! -e "/dev/fd" ]; then
      if [ -e "/proc/self/fd" ]; then
        rm -rf /dev/fd
        ln -s /proc/self/fd /dev/fd
      fi
    fi
  else
    echo "ERROR: This script should be ran as a root user"
    exit 1
  fi
  _DF_TEST=$(df -kTh / -l \
    | grep '/' \
    | sed 's/\%//g' \
    | awk '{print $6}' 2> /dev/null)
  _DF_TEST=${_DF_TEST//[^0-9]/}
  if [ ! -z "${_DF_TEST}" ] && [ "${_DF_TEST}" -gt "90" ]; then
    echo "ERROR: Your disk space is almost full !!! ${_DF_TEST}/100"
    echo "ERROR: We can not proceed until it is below 90/100"
    exit 1
  fi
}
check_root
cd /root/

###
### Noticeable messages
###
msg() {
  echo "AutoInit [$(date +%T 2>&1)] ==> $*"
}

init_pre() {
  _SYS_IFNAMES=$(grep GRUB_CMDLINE_LINUX= /etc/default/grub | grep "net.ifnames=0" 2>&1)
  if [ -e "/etc/default/grub" ] && [[ ! "${_SYS_IFNAMES}" =~ "net.ifnames=0" ]]; then
    echo "OOPS, we need to fix GRUB_CMDLINE_LINUX and reboot first"
    echo "Once the server us up again, launch the autoinit again"
    echo "Bye"
    echo 'GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"' >> /etc/default/grub
    grub-mkconfig -o /boot/grub/grub.cfg
    wait
    echo "Waiting ten seconds before reboot..."
    sleep 10
    reboot
  else
    echo "We need to install some tools early..."
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt-get update &> /dev/null
    apt-get install locales-all &> /dev/null
    apt-get install aptitude -fuy --allow-unauthenticated &> /dev/null
    apt-get install curl -fuy --allow-unauthenticated &> /dev/null
    apt-get install git -fuy --allow-unauthenticated &> /dev/null
    apt-get install git-core -fuy --allow-unauthenticated &> /dev/null
    apt-get install git-man -fuy --allow-unauthenticated &> /dev/null
  fi
}
init_pre

init_run_three() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching the third run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-three-devuan.cnf
    rm -f /root/.run-to-devuan.cnf
    rm -f /root/.run.devuan.os.upgrade.on.init.cnf
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo " " >> ${logInt}
    msg "Time for the third reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  elif [ "${initArgs}" = "debian" ]; then
    echo " " >> ${logInt}
    msg "Launching the third run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-three-debian.cnf
    rm -f /root/.run-to-debian.cnf
    rm -f /root/.run.devuan.os.upgrade.on.init.cnf
    sed -i "s/.*autoinit.*//gi" /etc/crontab &> /dev/null
    echo " " >> ${logInt}
    msg "Time for the third reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  fi
}

init_run_two() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching the second run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-two-devuan.cnf
    echo " " >> ${logInt}
    msg "Time for the second reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    touch /root/.run.devuan.os.upgrade.on.init.cnf
    reboot
    exit 0
  elif [ "${initArgs}" = "debian" ]; then
    echo " " >> ${logInt}
    msg "Launching the second run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-two-debian.cnf
    echo " " >> ${logInt}
    msg "Time for the second reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    rm -f /var/run/autoinit.pid
    touch /root/.run.devuan.os.upgrade.on.init.cnf
    reboot
    exit 0
  fi
}

init_run_one() {
  if [ "${initArgs}" = "devuan" ]; then
    echo " " >> ${logInt}
    msg "Launching the first run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-one-devuan.cnf
    echo " " >> ${logInt}
    msg "Time for the first reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    echo "*  *    * * *   root    bash /opt/local/bin/autoinit devuan" >> /etc/crontab
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  elif [ "${initArgs}" = "debian" ]; then
    echo " " >> ${logInt}
    msg "Launching the first run of ${initRun}" >> ${logInt}
    /opt/local/bin/boa ${initRun} >> ${logInt}
    wait
    touch /root/.run-one-debian.cnf
    echo " " >> ${logInt}
    msg "Time for the first reboot..." >> ${logInt}
    echo " " >> ${logInt}
    sleep 5
    echo "*  *    * * *   root    bash /opt/local/bin/autoinit debian" >> /etc/crontab
    rm -f /var/run/autoinit.pid
    reboot
    exit 0
  fi
}

init_conf() {
  if [ "${tRee}" = "dev" ]; then
    initCmnd="init-dev"
  else
    initCmnd="init"
  fi
  if [ "${1}" = "devuan" ] || [ -e "/root/.run-to-devuan.cnf" ]; then
    initArgs="devuan"
    toFile="/root/.run-to-devuan.cnf"
  else
    initArgs="debian"
    toFile="/root/.run-to-debian.cnf"
  fi
  initRun="${initCmnd} ${initArgs}"
}

init() {
  initCmnd=
  initArgs=
  initRun=
  touch /var/run/autoinit.pid
  sleep 10
  init_conf
  if [ ! -e "/root/.run-one-devuan.cnf" ] \
    && [ ! -e "/root/.run-one-debian.cnf" ]; then
    init_run_one
  fi
  if [ -e "/root/.run-one-devuan.cnf" ] \
    || [ -e "/root/.run-one-debian.cnf" ]; then
    if [ ! -e "/root/.run-two-devuan.cnf" ] \
      && [ ! -e "/root/.run-two-debian.cnf" ]; then
      init_run_two
    fi
  fi
  if [ -e "/root/.run-two-devuan.cnf" ] \
    || [ -e "/root/.run-two-debian.cnf" ]; then
    if [ ! -e "/root/.run-three-devuan.cnf" ] \
      && [ ! -e "/root/.run-three-debian.cnf" ]; then
      init_run_three
    fi
  fi
}

if [ -e "/root/.run-to-devuan.cnf" ] \
  || [ -e "/root/.run-to-debian.cnf" ]; then
  echo
  echo "Launching BOA System INIT.."
  echo "Watch the progress with: tail -f /root/.autoinit.log"
  echo
  init
fi

exit 0

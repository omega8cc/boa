#!/bin/bash


###----------------------------------------###
###
###  BOA Meta Installer
###
###  Copyright (C) 2010-2024 Omega8.cc
###  noc@omega8.cc www.omega8.cc
###
###  This program is free software. You can
###  redistribute it and/or modify it under
###  the terms of the GNU GPL as published by
###  the Free Software Foundation, version 2
###  or later.
###
###  This program is distributed in the hope
###  that it will be useful, but WITHOUT ANY
###  WARRANTY; without even the implied
###  warranty of MERCHANTABILITY or FITNESS
###  FOR A PARTICULAR PURPOSE. See the GNU GPL
###  for more details.
###
###  You should have received a copy of the
###  GNU GPL along with this program.
###  If not, see http://www.gnu.org/licenses/
###
###  Code: https://github.com/omega8cc/boa
###
###----------------------------------------###


###----------------------------------------###
### How To: run it with bash, not with sh  ###
###----------------------------------------###
###
###  $ wget -qO- http://files.aegir.cc/BOA.sh.txt | bash
###

###----------------------------------------###
### DON'T EDIT ANYTHING BELOW THIS LINE    ###
###----------------------------------------###

HOME=/root
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/local/sbin:/opt/local/bin:/usr/bin:/usr/sbin:/bin:/sbin

export PATH=${PATH}
export SHELL=${SHELL}
export HOME=${HOME}

tRee=lts
export tRee="${tRee}"

###
### Avoid too many questions
###
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
if [ -z "${TERM+x}" ]; then
  export TERM=vt100
fi

_NOW=$(date +%y%m%d-%H%M%S 2>&1)
export _NOW=${_NOW//[^0-9-]/}
_TODAY=$(date +%y%m%d 2>&1)
export _TODAY=${_TODAY//[^0-9]/}
_X_SE="540ltsT02"
#
barCnf="/root/.barracuda.cnf"
crlGet="-L --max-redirs 10 -k -s --retry 10 --retry-delay 5 -A iCab"
aptYesUnth="-y --allow-unauthenticated"
optBin="/opt/local/bin"
usrBin="/usr/local/bin"
pthLog="/var/xdrago/log"
if [ ! -e "${pthLog}" ] && [ -e "/var/xdrago_wait/log" ]; then
  pthLog="/var/xdrago_wait/log"
fi
tBn="tools/bin"
vBs="/var/backups"
#
eldirF="0001-Print-site_footer-if-defined.patch"
eldirP="/var/xdrago/conf/${eldirF}"
#
dctpF="drupal-ten-aegir-01.patch"
dctpP="/data/conf/patches/${dctpF}"
#
dctrF="drupal-ten-aegir-02.patch"
dctrP="/data/conf/patches/${dctrF}"
#
provLeInc="provision_hosting_le.drush.inc"
provLeIncFull="/var/xdrago/conf/${provLeInc}"
#
hoLeInc="hosting_le_vhost.drush.inc"
hoLeIncFull="/var/xdrago/conf/${hoLeInc}"
#
dehydName="dehydrated"
dehydSrcPath="/var/xdrago/conf/${dehydName}"
legacyLeSh="/var/xdrago/conf/letsencrypt.sh"

os_detection_minimal() {
  _APT_UPDATE="apt-get update"
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  _OS_LIST="daedalus chimaera beowulf buster bullseye bookworm"
  for e in ${_OS_LIST}; do
    if [ "${e}" = "${_OS_CODE}" ]; then
      _APT_UPDATE="apt-get update --allow-releaseinfo-change"
    fi
  done
}

apt_clean_update() {
  ${_APT_UPDATE} -qq &> /dev/null
}

_CHECK_HOST=$(uname -n 2>&1)
if_hosted_sys() {
  if [ -e "/root/.host8.cnf" ] \
    || [[ "${_CHECK_HOST}" =~ ".aegir.cc"($) ]]; then
    hostedSys=YES
  else
    hostedSys=NO
  fi
}

#
# Find correct IP.
find_correct_ip() {
  if [ -e "/root/.found_correct_ipv4.cnf" ]; then
    _LOC_IP=$(cat /root/.found_correct_ipv4.cnf 2>&1)
    _LOC_IP=$(echo -n ${_LOC_IP} | tr -d "\n" 2>&1)
  else
    _LOC_IP=$(curl ${crlGet} https://api.ipify.org \
      | sed 's/[^0-9\.]//g' 2>&1)
    if [ -z "${_LOC_IP}" ]; then
      _LOC_IP=$(curl ${crlGet} http://ipv4.icanhazip.com \
        | sed 's/[^0-9\.]//g' 2>&1)
    fi
    if [ ! -z "${_LOC_IP}" ]; then
      echo ${_LOC_IP} > /root/.found_correct_ipv4.cnf
    fi
  fi
}

fix_dns_settings() {
  mkdir -p ${vBs}
  rm -f ${vBs}/resolv.conf.tmp
  if [ -e "/etc/resolv.conf" ]; then
    if [ -L "/etc/resolv.conf" ]; then
      rslvT=`readlink -n /etc/resolv.conf`
      if [ ! -e "${rslvT}" ]; then
        rm -f /etc/resolv.conf
      fi
    fi
    if [ -e "/etc/resolv.conf" ]; then
      cp -a /etc/resolv.conf ${vBs}/resolv.conf.tmp
    fi
  fi
  if [ ! -e "${vBs}/resolv.conf.tmp" ]; then
    echo "nameserver 127.0.0.1" > ${vBs}/resolv.conf.tmp
    echo "nameserver 1.1.1.1" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 1.0.0.1" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 8.8.8.8" >> ${vBs}/resolv.conf.tmp
    echo "nameserver 8.8.4.4" >> ${vBs}/resolv.conf.tmp
  fi
  if [ ! -e "${vBs}/resolv.conf.vanilla" ] \
    && [ -e "${vBs}/resolv.conf.tmp" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp ${vBs}/resolv.conf.vanilla
    fi
  fi
  sed -i "/^$/d" ${vBs}/resolv.conf.vanilla &> /dev/null
  if [ -e "${vBs}/resolv.conf.vanilla" ]; then
    if [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.vanilla /etc/resolv.conf
    fi
  else
    if [ -e "${vBs}/resolv.conf.tmp" ] \
      && [ "${_USE_DEFAULT_DNS}" != "YES" ]; then
      rm -f /etc/resolv.conf
      cp -a ${vBs}/resolv.conf.tmp /etc/resolv.conf
    fi
  fi
}

check_dns_settings() {
  if [ -e "/root/.use.default.nameservers.cnf" ]; then
    _USE_DEFAULT_DNS=YES
  fi
  if [ -e "/root/.use.local.nameservers.cnf" ]; then
    _USE_PROVIDER_DNS=YES
  else
    _REMOTE_DNS_TEST=$(host files.aegir.cc 1.1.1.1 -w 10 2>&1)
  fi
  if [[ "${_REMOTE_DNS_TEST}" =~ "no servers could be reached" ]] \
    || [[ "${_REMOTE_DNS_TEST}" =~ "Host files.aegir.cc not found" ]] \
    || [ "${_USE_DEFAULT_DNS}" = "YES" ] \
    || [ "${_USE_PROVIDER_DNS}" = "YES" ]; then
    if [ "${_USE_DEFAULT_DNS}" = "YES" ] \
      || [ "${_USE_PROVIDER_DNS}" = "YES" ] \
      || [ ! -e "${vBs}/resolv.conf.vanilla" ]; then
      fix_dns_settings
      if [ -e "/etc/init.d/postfix" ]; then
        service postfix restart &> /dev/null
      fi
    fi
  fi
}

find_fast_mirror_early() {
  isNetc=$(which netcat 2>&1)
  if [ ! -x "${isNetc}" ] || [ -z "${isNetc}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install netcat ${aptYesUnth} &> /dev/null
    apt-get install netcat-traditional ${aptYesUnth} &> /dev/null
  fi
  ffMirr=$(which ffmirror 2>&1)
  if [ -x "${ffMirr}" ]; then
    ffList="/var/backups/boa-mirrors-2024-01.txt"
    mkdir -p /var/backups
    if [ ! -e "${ffList}" ]; then
      echo "de.files.aegir.cc"  > ${ffList}
      echo "ny.files.aegir.cc" >> ${ffList}
      echo "sg.files.aegir.cc" >> ${ffList}
    fi
    if [ -e "${ffList}" ]; then
      _BROKEN_FFMIRR_TEST=$(grep "stuff" ${ffMirr} 2>&1)
      if [[ "${_BROKEN_FFMIRR_TEST}" =~ "stuff" ]]; then
        _CHECK_MIRROR=$(bash ${ffMirr} < ${ffList} 2>&1)
        _USE_MIR="${_CHECK_MIRROR}"
        [[ "${_USE_MIR}" =~ "printf" ]] && _USE_MIR="files.aegir.cc"
      else
        _USE_MIR="files.aegir.cc"
      fi
    else
      _USE_MIR="files.aegir.cc"
    fi
  else
    _USE_MIR="files.aegir.cc"
  fi
  urlDev="http://${_USE_MIR}/dev"
  urlHmr="http://${_USE_MIR}/versions/${tRee}/boa/aegir"
}

extract_archive() {
  if [ ! -z "$1" ]; then
    case $1 in
      *.tar.bz2)   tar xjf $1    ;;
      *.tar.gz)    tar xzf $1    ;;
      *.tar.xz)    tar xvf $1    ;;
      *.bz2)       bunzip2 $1    ;;
      *.rar)       unrar x $1    ;;
      *.gz)        gunzip -q $1  ;;
      *.tar)       tar xf $1     ;;
      *.tbz2)      tar xjf $1    ;;
      *.tgz)       tar xzf $1    ;;
      *.zip)       unzip -qq $1  ;;
      *.Z)         uncompress $1 ;;
      *.7z)        7z x $1       ;;
      *)           echo "'$1' cannot be extracted via >extract<" ;;
    esac
    rm -f $1
  fi
}

#
# Download and extract archive from dev/src mirror.
get_dev_src() {
  if [ ! -z "$1" ]; then
    curl ${crlGet} "${urlDev}/src/$1" -o "$1"
    if [ -e "$1" ]; then
      extract_archive "$1"
    else
      echo "OOPS: $1 failed download from ${urlDev}/src/$1"
    fi
  fi
}

#
# Download and extract from dev/contrib mirror.
get_dev_contrib() {
  if [ ! -z "$1" ]; then
    curl ${crlGet} "${urlDev}/DEV/contrib/$1" -o "$1"
    if [ -e "$1" ]; then
      extract_archive "$1"
    else
      msg "OOPS: $1 failed download from ${urlDev}/DEV/contrib/$1"
    fi
  fi
}

if_clean_boa_env() {
  if [ ! -x "/etc/init.d/clean-boa-env" ]; then
    curl ${crlGet} "${urlHmr}/conf/var/clean-boa-env" -o /etc/init.d/clean-boa-env
    if [ -e "/etc/init.d/clean-boa-env" ]; then
      chmod 700 /etc/init.d/clean-boa-env
      chown root:root /etc/init.d/clean-boa-env
      update-rc.d clean-boa-env defaults &> /dev/null
    fi
  fi
}

locales_check_fix_early() {
  isLoc=$(which locale 2>&1)
  if [ ! -x "${isLoc}" ] || [ -z "${isLoc}" ]; then
    _INITINS="/usr/bin/apt-get -y --allow-unauthenticated install"
    apt-get update -qq &> /dev/null
    ${_INITINS} locales locales-all &> /dev/null
  fi
  _LOC_TEST=$(locale 2>&1)
  if [[ "${_LOC_TEST}" =~ LANG=.*UTF-8 ]]; then
    _LOCALE_TEST=OK
  fi
  if [[ "${_LOC_TEST}" =~ "Cannot" ]]; then
    _LOCALE_TEST=BROKEN
  fi
  if [ "${_LOCALE_TEST}" = "BROKEN" ]; then
    _LOCALE_GEN_TEST=$(grep -v "^#" /etc/locale.gen 2>&1)
    if [[ ! "${_LOCALE_GEN_TEST}" =~ "en_US.UTF-8 UTF-8" ]]; then
      echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    fi
    sed -i "/^$/d" /etc/locale.gen
    locale-gen &> /dev/null
    locale-gen en_US.UTF-8 &> /dev/null
    # Explicitly enforce all locale settings
    update-locale \
      LANG=en_US.UTF-8 \
      LC_CTYPE=en_US.UTF-8 \
      LC_COLLATE=POSIX \
      LC_NUMERIC=POSIX \
      LC_TIME=en_US.UTF-8 \
      LC_MONETARY=en_US.UTF-8 \
      LC_MESSAGES=en_US.UTF-8 \
      LC_PAPER=en_US.UTF-8 \
      LC_NAME=en_US.UTF-8 \
      LC_ADDRESS=en_US.UTF-8 \
      LC_TELEPHONE=en_US.UTF-8 \
      LC_MEASUREMENT=en_US.UTF-8 \
      LC_IDENTIFICATION=en_US.UTF-8 \
      LC_ALL= &> /dev/null
    # Define all locale settings on the fly to prevent unnecessary
    # warnings during installation of packages.
    export LANG=en_US.UTF-8 &> /dev/null
    export LC_CTYPE=en_US.UTF-8 &> /dev/null
    export LC_COLLATE=POSIX &> /dev/null
    export LC_NUMERIC=POSIX &> /dev/null
    export LC_TIME=en_US.UTF-8 &> /dev/null
    export LC_MONETARY=en_US.UTF-8 &> /dev/null
    export LC_MESSAGES=en_US.UTF-8 &> /dev/null
    export LC_PAPER=en_US.UTF-8 &> /dev/null
    export LC_NAME=en_US.UTF-8 &> /dev/null
    export LC_ADDRESS=en_US.UTF-8 &> /dev/null
    export LC_TELEPHONE=en_US.UTF-8 &> /dev/null
    export LC_MEASUREMENT=en_US.UTF-8 &> /dev/null
    export LC_IDENTIFICATION=en_US.UTF-8 &> /dev/null
    export LC_ALL= &> /dev/null
  else
    _LOCALE_GEN_TEST=$(grep -v "^#" /etc/locale.gen 2>&1)
    if [[ ! "${_LOCALE_GEN_TEST}" =~ "en_US.UTF-8 UTF-8" ]]; then
      echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
    fi
    sed -i "/^$/d" /etc/locale.gen
    locale-gen &> /dev/null
    locale-gen en_US.UTF-8 &> /dev/null
    # Explicitly enforce locale settings required for consistency
    update-locale \
      LANG=en_US.UTF-8 \
      LC_CTYPE=en_US.UTF-8 \
      LC_COLLATE=POSIX \
      LC_NUMERIC=POSIX \
      LC_ALL= &> /dev/null
    # Define locale settings required for consistency also on the fly
    export LC_COLLATE=POSIX &> /dev/null
    export LC_NUMERIC=POSIX &> /dev/null
    export LC_ALL= &> /dev/null
  fi
  _LOCALES_BASHRC_TEST=$(grep LC_COLLATE /root/.bashrc 2>&1)
  if [[ ! "${_LOCALES_BASHRC_TEST}" =~ "LC_COLLATE" ]]; then
    printf "\n" >> /root/.bashrc
    echo "export LANG=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_CTYPE=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_COLLATE=POSIX" >> /root/.bashrc
    echo "export LC_NUMERIC=POSIX" >> /root/.bashrc
    echo "export LC_TIME=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_MONETARY=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_MESSAGES=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_PAPER=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_NAME=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_ADDRESS=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_TELEPHONE=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_MEASUREMENT=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_IDENTIFICATION=en_US.UTF-8" >> /root/.bashrc
    echo "export LC_ALL=" >> /root/.bashrc
    printf "\n" >> /root/.bashrc
  fi
}

if_fix_iptables_symlinks() {
  ###
  ### Fix for iptables paths backward compatibility
  ###
  if [ -x "/sbin/iptables" ] && [ ! -e "/usr/sbin/iptables" ]; then
    ln -s /sbin/iptables /usr/sbin/iptables
  fi
  if [ -x "/usr/sbin/iptables" ] && [ ! -e "/sbin/iptables" ]; then
    ln -s /usr/sbin/iptables /sbin/iptables
  fi
  if [ -x "/sbin/iptables-save" ] && [ ! -e "/usr/sbin/iptables-save" ]; then
    ln -s /sbin/iptables-save /usr/sbin/iptables-save
  fi
  if [ -x "/usr/sbin/iptables-save" ] && [ ! -e "/sbin/iptables-save" ]; then
    ln -s /usr/sbin/iptables-save /sbin/iptables-save
  fi
  if [ -x "/sbin/iptables-restore" ] && [ ! -e "/usr/sbin/iptables-restore" ]; then
    ln -s /sbin/iptables-restore /usr/sbin/iptables-restore
  fi
  if [ -x "/usr/sbin/iptables-restore" ] && [ ! -e "/sbin/iptables-restore" ]; then
    ln -s /usr/sbin/iptables-restore /sbin/iptables-restore
  fi
  if [ -x "/sbin/ip6tables" ] && [ ! -e "/usr/sbin/ip6tables" ]; then
    ln -s /sbin/ip6tables /usr/sbin/ip6tables
  fi
  if [ -x "/usr/sbin/ip6tables" ] && [ ! -e "/sbin/ip6tables" ]; then
    ln -s /usr/sbin/ip6tables /sbin/ip6tables
  fi
  if [ -x "/sbin/ip6tables-save" ] && [ ! -e "/usr/sbin/ip6tables-save" ]; then
    ln -s /sbin/ip6tables-save /usr/sbin/ip6tables-save
  fi
  if [ -x "/usr/sbin/ip6tables-save" ] && [ ! -e "/sbin/ip6tables-save" ]; then
    ln -s /usr/sbin/ip6tables-save /sbin/ip6tables-save
  fi
  if [ -x "/sbin/ip6tables-restore" ] && [ ! -e "/usr/sbin/ip6tables-restore" ]; then
    ln -s /sbin/ip6tables-restore /usr/sbin/ip6tables-restore
  fi
  if [ -x "/usr/sbin/ip6tables-restore" ] && [ ! -e "/sbin/ip6tables-restore" ]; then
    ln -s /usr/sbin/ip6tables-restore /sbin/ip6tables-restore
  fi
  ###
  ### Fix for iptables paths backward compatibility
  ###
}

update_agents() {

  if_hosted_sys
  if [ "${hostedSys}" = "YES" ]; then
    if [ ! -e "/root/.extended.firewall.exceptions.cnf" ]; then
      echo host8 > /root/.extended.firewall.exceptions.cnf
    fi
  fi

  if [ "${_VMFAMILY}" = "HOSTED" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -d "/data/u" ] \
    && [ -e "/var/xdrago" ]; then
    [ ! -e "/root/.fast.cron.cnf" ] && echo ON > /root/.fast.cron.cnf
    PrTestPower=$(grep "POWER" /root/.*.octopus.cnf 2>&1)
    PrTestPhantom=$(grep "PHANTOM" /root/.*.octopus.cnf 2>&1)
    PrTestCluster=$(grep "CLUSTER" /root/.*.octopus.cnf 2>&1)
    InTest=$(ls /data/disk/*/static/control/cli.info | wc -l 2>&1)
    _SQL_PSWD=$(cat /root/.my.pass.txt 2>&1)
    _SQL_PSWD=$(echo -n ${_SQL_PSWD} | tr -d "\n" 2>&1)
    if [ "${InTest}" -lt "9" ] \
      && [[ ! "${PrTestPower}" =~ "POWER" ]] \
      && [[ ! "${PrTestPhantom}" =~ "PHANTOM" ]] \
      && [[ ! "${PrTestCluster}" =~ "CLUSTER" ]]; then
      [ ! -e "/root/.fast.cron.cnf" ] && echo ${InTest} > /root/.fast.cron.cnf
      [ -e "/root/.hr.monitor.cnf" ] && rm -f /root/.hr.monitor.cnf
      [ -e "/root/.slow.cron.cnf" ] && rm -f /root/.slow.cron.cnf
      [ -e "/root/.tg.cnf" ] && rm -f /root/.tg.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 80;"
      mysql -u root -e "SET GLOBAL max_connections = 100;"
      mysql -u root -e "SET GLOBAL max_user_connections = 80;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    if [ "${InTest}" -ge "9" ] && [ "${InTest}" -le "50" ]; then
      [ ! -e "/root/.fast.cron.cnf" ] && echo ${InTest} > /root/.fast.cron.cnf
      [ -e "/root/.hr.monitor.cnf" ] && rm -f /root/.hr.monitor.cnf
      [ -e "/root/.slow.cron.cnf" ] && rm -f /root/.slow.cron.cnf
      [ -e "/root/.tg.cnf" ] && rm -f /root/.tg.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 80;"
      mysql -u root -e "SET GLOBAL max_connections = 200;"
      mysql -u root -e "SET GLOBAL max_user_connections = 80;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    if [ "${InTest}" -gt "50" ]; then
      [ -e "/root/.fast.cron.cnf" ] && rm -f /root/.fast.cron.cnf
      [ ! -e "/root/.tg.cnf" ] && echo ${InTest} > /root/.tg.cnf
      [ ! -e "/root/.hr.monitor.cnf" ] && echo ${InTest} > /root/.hr.monitor.cnf
      [ ! -e "/root/.slow.cron.cnf" ] && echo ${InTest} > /root/.slow.cron.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 80;"
      mysql -u root -e "SET GLOBAL max_connections = 200;"
      mysql -u root -e "SET GLOBAL max_user_connections = 80;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    if [[ "${PrTestPower}" =~ "POWER" ]]; then
      [ ! -e "/root/.tg.cnf" ] && echo ${InTest} > /root/.tg.cnf
      [ ! -e "/root/.fast.cron.cnf" ] && echo ${InTest} > /root/.fast.cron.cnf
      [ -e "/root/.hr.monitor.cnf" ] && rm -f /root/.hr.monitor.cnf
      [ -e "/root/.slow.cron.cnf" ] && rm -f /root/.slow.cron.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 150;"
      mysql -u root -e "SET GLOBAL max_connections = 200;"
      mysql -u root -e "SET GLOBAL max_user_connections = 150;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    if [[ "${PrTestPhantom}" =~ "PHANTOM" ]]; then
      [ ! -e "/root/.tg.cnf" ] && echo ${InTest} > /root/.tg.cnf
      [ ! -e "/root/.fast.cron.cnf" ] && echo ${InTest} > /root/.fast.cron.cnf
      [ -e "/root/.hr.monitor.cnf" ] && rm -f /root/.hr.monitor.cnf
      [ -e "/root/.slow.cron.cnf" ] && rm -f /root/.slow.cron.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 150;"
      mysql -u root -e "SET GLOBAL max_connections = 200;"
      mysql -u root -e "SET GLOBAL max_user_connections = 150;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    if [[ "${PrTestCluster}" =~ "CLUSTER" ]]; then
      [ ! -e "/root/.tg.cnf" ] && echo ${InTest} > /root/.tg.cnf
      [ ! -e "/root/.fast.cron.cnf" ] && echo ${InTest} > /root/.fast.cron.cnf
      [ -e "/root/.hr.monitor.cnf" ] && rm -f /root/.hr.monitor.cnf
      [ -e "/root/.slow.cron.cnf" ] && rm -f /root/.slow.cron.cnf
      mysql -u root -e "SET GLOBAL max_connect_errors = 150;"
      mysql -u root -e "SET GLOBAL max_connections = 200;"
      mysql -u root -e "SET GLOBAL max_user_connections = 150;"
      mysql -u root -e "SET GLOBAL group_concat_max_len = 10000;"
    fi
    mysql -u root -e "SET GLOBAL optimizer_switch='derived_merge=off';"
    mysql -u root -e "SET GLOBAL sort_buffer_size = 262144;"
    if [ -e "/root/.tg.cnf" ]; then
      if [ ! -e "/root/.fixed_fpm_workers.pid" ]; then
        sed -i "s/^_PHP_FPM_WORKERS=.*/_PHP_FPM_WORKERS=100/g" ${barCnf}
        touch /root/.fixed_fpm_workers.pid
      fi
    fi
    if [ ! -e "/root/.high_traffic.cnf" ]; then
      echo ${InTest} > /root/.high_traffic.cnf
      echo ${InTest} > /root/.no.swap.clear.cnf
    fi
    if [ "${_RANDOMIZE}" = "YES" ]; then
      if [ ! -e "/root/.randomize_duplicity_full_backup_day.cnf" ]; then
        echo ${InTest} > /root/.randomize_duplicity_full_backup_day.cnf
      fi
      if [ ! -e "/root/.skip_duplicity_monthly_cleanup.cnf" ]; then
        echo ${InTest} > /root/.skip_duplicity_monthly_cleanup.cnf
      fi
    else
      [ -e "/root/.randomize_duplicity_full_backup_day.cnf" ] && rm -f /root/.randomize_duplicity_full_backup_day.cnf
      [ -e "/root/.skip_duplicity_monthly_cleanup.cnf" ] && rm -f /root/.skip_duplicity_monthly_cleanup.cnf
    fi
    [ -e "/root/.my.batch_innodb.cnf" ] && rm -f /root/.my.batch_innodb.cnf
    [ -e "/root/.batch_innodb.cnf" ] && rm -f /root/.batch_innodb.cnf
    [ -e "/root/.force.drupalgeddon.cnf" ] && rm -f /root/.force.drupalgeddon.cnf
    [ -e "/root/.skip_cleanup.cnf" ] && rm -f /root/.skip_cleanup.cnf
    [ -e "/root/.giant_traffic.cnf" ] && rm -f /root/.giant_traffic.cnf
    [ -e "/root/.default.cnf" ] && rm -f /root/.default.cnf
    [ -e "/root/.debug.cnf" ] && rm -f /root/.debug.cnf
    if [ -e "/data/conf/override.global.inc" ] \
      && [ ! -e "/data/conf/.prev6.override.global.inc.off" ]; then
      mv -f /data/conf/override.global.inc /data/conf/.prev6.override.global.inc.off
    fi
#     if [ ! -e "/data/conf/override.global.inc" ]; then
#       echo "<?php" > /data/conf/override.global.inc.tmp
#       echo "" >> /data/conf/override.global.inc.tmp
#       echo "\$use_redis = TRUE;" >> /data/conf/override.global.inc.tmp
#       chmod 644 /data/conf/override.global.inc.tmp
#       mv -f /data/conf/override.global.inc.tmp /data/conf/override.global.inc
#     fi
  fi


  if [ -e "/var/aegir/drush" ]; then
    [ ! -e "/var/xdrago/clear.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/daily.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/graceful.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/guest-fire.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/guest-water.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/manage_ltd_users.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/manage_solr_config.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/minute.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/move_sql.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/mysql_backup.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/mysql_cleanup.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/proc_num_ctrl.cgi" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/runner.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/second.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
    [ ! -e "/var/xdrago/usage.sh" ] && rm -f ${pthLog}/*.ctrl.${tRee}.${_X_SE}.pid
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ ! -e "${pthLog}/drush8-symlink.ctrl.${tRee}.${_X_SE}.pid" ]; then
    if [ -x "/opt/tools/drush/8/drush/drush.php" ] \
      && [ -L "/usr/bin/drush8" ]; then
      _DRUSH_SYMLINK=$(readlink -n /usr/bin/drush8 2>&1)
      _DRUSH_SYMLINK=$(echo -n ${_DRUSH_SYMLINK} | tr -d "\n" 2>&1)
      if [ "${_DRUSH_SYMLINK}" != "/opt/tools/drush/8/drush/drush.php" ]; then
        rm -f /usr/bin/drush8
        rm -f /usr/bin/drush
        ln -s /opt/tools/drush/8/drush/drush.php /usr/bin/drush8
        ln -s /opt/tools/drush/8/drush/drush.php /usr/bin/drush
        touch ${pthLog}/drush8-symlink.ctrl.${tRee}.${_X_SE}.pid
      fi
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/clean-boa-env.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /etc/init.d/clean-boa-env /var/xdrago/clean-boa-env.old
    curl ${crlGet} "${urlHmr}/conf/var/clean-boa-env" -o /etc/init.d/clean-boa-env
    if [ -e "/etc/init.d/clean-boa-env" ]; then
      chmod 700 /etc/init.d/clean-boa-env
      chown root:root /etc/init.d/clean-boa-env
      touch ${pthLog}/clean-boa-env.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/clean-boa-env.old /etc/init.d/clean-boa-env
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/mysql_backup.ctrl.hf01.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/mysql_backup.sh /var/xdrago/mysql_backup.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/mysql_backup.sh" -o /var/xdrago/mysql_backup.sh
    if [ -e "/var/xdrago/mysql_backup.sh" ]; then
      chmod 700 /var/xdrago/mysql_backup.sh
      chown root:root /var/xdrago/mysql_backup.sh
      touch ${pthLog}/mysql_backup.ctrl.hf01.${_X_SE}.pid
    else
      mv -f /var/xdrago/mysql_backup.sh.old /var/xdrago/mysql_backup.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/mysql_cleanup.ctrl.hf01.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/mysql_cleanup.sh /var/xdrago/mysql_cleanup.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/mysql_cleanup.sh" -o /var/xdrago/mysql_cleanup.sh
    if [ -e "/var/xdrago/mysql_cleanup.sh" ]; then
      chmod 700 /var/xdrago/mysql_cleanup.sh
      chown root:root /var/xdrago/mysql_cleanup.sh
      touch ${pthLog}/mysql_cleanup.ctrl.hf01.${_X_SE}.pid
    else
      mv -f /var/xdrago/mysql_cleanup.sh.old /var/xdrago/mysql_cleanup.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/mysql_cluster_backup.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/mysql_cluster_backup.sh /var/xdrago/mysql_cluster_backup.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/mysql_cluster_backup.sh" -o /var/xdrago/mysql_cluster_backup.sh
    if [ -e "/var/xdrago/mysql_cluster_backup.sh" ]; then
      chmod 700 /var/xdrago/mysql_cluster_backup.sh
      chown root:root /var/xdrago/mysql_cluster_backup.sh
      touch ${pthLog}/mysql_cluster_backup.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/mysql_cluster_backup.sh.old /var/xdrago/mysql_cluster_backup.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/runner.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/runner.sh /var/xdrago/runner.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/runner.sh" -o /var/xdrago/runner.sh
    if [ -e "/var/xdrago/runner.sh" ]; then
      chmod 700 /var/xdrago/runner.sh
      chown root:root /var/xdrago/runner.sh
      touch ${pthLog}/runner.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/runner.sh.old /var/xdrago/runner.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/minute_f8.ctrl${_X_SE}.pid" ]; then
    mv -f /var/xdrago/minute.sh /var/xdrago/minute.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/minute.sh" -o /var/xdrago/minute.sh
    if [ -e "/var/xdrago/minute.sh" ]; then
      if [ -e "/root/.debug.cnf" ] && [ ! -e "/root/.default.cnf" ]; then
        _DO_NOTHING=YES
      else
        if [ -e "/root/.high_load.cnf" ] \
          && [ ! -e "/root/.big_db.cnf" ] \
          && [ ! -e "/root/.tg.cnf" ]; then
          sed -i "s/3600/300/g" /var/xdrago/minute.sh
        elif [ -e "/root/.big_db.cnf" ] || [ -e "/root/.tg.cnf" ]; then
          _DO_NOTHING=YES
        else
          sed -i "s/3600/1800/g" /var/xdrago/minute.sh
        fi
      fi
      chmod 700 /var/xdrago/minute.sh
      chown root:root /var/xdrago/minute.sh
      touch ${pthLog}/minute_f8.ctrl${_X_SE}.pid
    else
      mv -f /var/xdrago/minute.sh.old /var/xdrago/minute.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/clear.ctrl.a2.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/clear.sh /var/xdrago/clear.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/clear.sh" -o /var/xdrago/clear.sh
    if [ -e "/var/xdrago/clear.sh" ]; then
      chmod 700 /var/xdrago/clear.sh
      chown root:root /var/xdrago/clear.sh
      touch ${pthLog}/clear.ctrl.a2.${_X_SE}.pid
    else
      mv -f /var/xdrago/clear.sh.old /var/xdrago/clear.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/daily.ctrl.hfx04.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/daily.sh /var/xdrago/daily.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/daily.sh" -o /var/xdrago/daily.sh
    if [ -e "/var/xdrago/daily.sh" ]; then
      chmod 700 /var/xdrago/daily.sh
      chown root:root /var/xdrago/daily.sh
      touch ${pthLog}/daily.ctrl.hfx04.${_X_SE}.pid
    else
      mv -f /var/xdrago/daily.sh.old /var/xdrago/daily.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/graceful_f2.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/graceful.sh /var/xdrago/graceful.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/graceful.sh" -o /var/xdrago/graceful.sh
    if [ -e "/var/xdrago/graceful.sh" ]; then
      chmod 700 /var/xdrago/graceful.sh
      chown root:root /var/xdrago/graceful.sh
      touch ${pthLog}/graceful_f2.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/graceful.sh.old /var/xdrago/graceful.sh
    fi
  fi

  if_hosted_sys
  if [ "${hostedSys}" = "YES" ]; then
    _MY_USAGE=YES
  else
    _MY_USAGE=NO
    if [ -e "/var/xdrago/usage.sh" ]; then
      rm -f /var/xdrago/usage.sh
    fi
  fi
  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ "${_MY_USAGE}" = "YES" ] \
    && [ ! -e "${pthLog}/usage.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/usage.sh /var/xdrago/usage.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/usage.sh" -o /var/xdrago/usage.sh
    if [ -e "/var/xdrago/usage.sh" ]; then
      chmod 700 /var/xdrago/usage.sh
      chown root:root /var/xdrago/usage.sh
      touch ${pthLog}/usage.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/usage.sh.old /var/xdrago/usage.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/manage_ltd_users.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/manage_ltd_users.sh /var/xdrago/manage_ltd_users.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/manage_ltd_users.sh" \
      -o /var/xdrago/manage_ltd_users.sh
    if [ -e "/var/xdrago/manage_ltd_users.sh" ]; then
      chmod 700 /var/xdrago/manage_ltd_users.sh
      chown root:root /var/xdrago/manage_ltd_users.sh
      touch ${pthLog}/manage_ltd_users.ctrl.${tRee}.${_X_SE}.pid
      [ -e "/run/manage_ltd_users.pid" ] && rm -f /run/manage_ltd_users.pid
    else
      mv -f /var/xdrago/manage_ltd_users.sh.old /var/xdrago/manage_ltd_users.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/manage_solr_config_f2.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/manage_solr_config.sh /var/xdrago/manage_solr_config.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/manage_solr_config.sh" \
      -o /var/xdrago/manage_solr_config.sh
    if [ -e "/var/xdrago/manage_solr_config.sh" ]; then
      chmod 700 /var/xdrago/manage_solr_config.sh
      chown root:root /var/xdrago/manage_solr_config.sh
      touch ${pthLog}/manage_solr_config_f2.ctrl.${tRee}.${_X_SE}.pid
      rm -f /run/manage_solr_config.pid
    else
      mv -f /var/xdrago/manage_solr_config.sh.old /var/xdrago/manage_solr_config.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/proc_num_ctrl_f2.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/proc_num_ctrl.cgi /var/xdrago/proc_num_ctrl.cgi.old
    curl ${crlGet} "${urlHmr}/tools/system/proc_num_ctrl.cgi" \
      -o /var/xdrago/proc_num_ctrl.cgi
    if [ -e "/var/xdrago/proc_num_ctrl.cgi" ]; then
      chmod 700 /var/xdrago/proc_num_ctrl.cgi
      chown root:root /var/xdrago/proc_num_ctrl.cgi
      touch ${pthLog}/proc_num_ctrl_f2.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/proc_num_ctrl.cgi.old /var/xdrago/proc_num_ctrl.cgi
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/fast_shutdown.ctrl.${tRee}.${_X_SE}.pid" ]; then
    sed -i "s/.*opcache.fast_shutdown.*//g" /opt/etc/fpm/fpm-pool-common.conf
    _PHP_V="83 82 81 80 74 73 72 71 70 56"
    for e in ${_PHP_V}; do
      if [ -e "/etc/init.d/php${e}-fpm" ] && [ -e "/opt/php${e}/bin/php" ]; then
        service php${e}-fpm reload &> /dev/null
      fi
    done
    _PHP_V="55 54 53"
    for e in ${_PHP_V}; do
      if [ -e "/etc/init.d/php${e}-fpm" ] && [ -e "/opt/php${e}/bin/php" ]; then
        service php${e}-fpm force-quit &> /dev/null
      fi
    done
    touch ${pthLog}/fast_shutdown.ctrl.${tRee}.${_X_SE}.pid
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -x "/usr/sbin/csf" ] \
    && [ -e "/etc/csf/csf.deny" ] \
    && [ ! -e "${pthLog}/guest-fire-sh2.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/guest-fire.sh /var/xdrago/guest-fire.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/guest-fire.sh" \
      -o /var/xdrago/guest-fire.sh
    if [ -e "/var/xdrago/guest-fire.sh" ]; then
      chmod 700 /var/xdrago/guest-fire.sh
      chown root:root /var/xdrago/guest-fire.sh
      touch ${pthLog}/guest-fire-sh2.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/guest-fire.sh.old /var/xdrago/guest-fire.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -x "/usr/sbin/csf" ] \
    && [ -e "/etc/csf/csf.deny" ] \
    && [ ! -e "${pthLog}/guest-water-sh2.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/guest-water.sh /var/xdrago/guest-water.sh.old
    curl ${crlGet} "${urlHmr}/tools/system/guest-water.sh" \
      -o /var/xdrago/guest-water.sh
    if [ -e "/var/xdrago/guest-water.sh" ]; then
      chmod 700 /var/xdrago/guest-water.sh
      chown root:root /var/xdrago/guest-water.sh
      touch ${pthLog}/guest-water-sh2.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/guest-water.sh.old /var/xdrago/guest-water.sh
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/hackcheck.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/monitor/check/hackcheck /var/xdrago/monitor/check/hackcheck.old
    curl ${crlGet} "${urlHmr}/tools/system/monitor/check/hackcheck" \
      -o /var/xdrago/monitor/check/hackcheck
    if [ -e "/var/xdrago/monitor/check/hackcheck" ]; then
      chmod 700 /var/xdrago/monitor/check/hackcheck
      chown root:root /var/xdrago/monitor/check/hackcheck
      touch ${pthLog}/hackcheck.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/monitor/check/hackcheck.old /var/xdrago/monitor/check/hackcheck
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/scan_nginx.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/monitor/check/scan_nginx /var/xdrago/monitor/check/scan_nginx.old
    curl ${crlGet} "${urlHmr}/tools/system/monitor/check/scan_nginx" \
      -o /var/xdrago/monitor/check/scan_nginx
    if [ -e "/var/xdrago/monitor/check/scan_nginx" ]; then
      sed -i "s/default_critnumber =.*/default_critnumber = 399;/g" /var/xdrago/monitor/check/scan_nginx
      wait
      sed -i "s/default_lines =.*/default_lines = 1999;/g" /var/xdrago/monitor/check/scan_nginx
      wait
      if_hosted_sys
      if [ "${hostedSys}" = "YES" ]; then
        if [ -z "${_NGINX_DONTCOUNT_KEYWORDS}" ]; then
          _NGINX_DONTCOUNT_KEYWORDS="doccomment"
        fi
      fi
      if [ ! -z "${_NGINX_DONTCOUNT_KEYWORDS}" ]; then
        _NGINX_DONTCOUNT_KEYWORDS=${_NGINX_DONTCOUNT_KEYWORDS//[^a-zA-Z0-9|-]/}
        sed -i "s/dontcount/${_NGINX_DONTCOUNT_KEYWORDS}/g" /var/xdrago/monitor/check/scan_nginx
        wait
      fi
      if [ ! -z "${_NGINX_DOS_KEYWORDS}" ]; then
        _NGINX_DOS_KEYWORDS=${_NGINX_DOS_KEYWORDS//[^a-zA-Z0-9|-]/}
        if [ ! -z "${_NGINX_DOS_KEYWORDS}" ]; then
          sed -i "s/foobar/${_NGINX_DOS_KEYWORDS}/g" /var/xdrago/monitor/check/scan_nginx
          wait
        fi
      fi
      chmod 700 /var/xdrago/monitor/check/scan_nginx
      chown root:root /var/xdrago/monitor/check/scan_nginx
      touch ${pthLog}/scan_nginx.ctrl.${tRee}.${_X_SE}.pid
      if [ ! -e "/var/xdrago/monitor/.scan_nginx_arch.${_X_SE}.pid" ]; then
        if [ -e "/var/xdrago/monitor/scan_nginx.archive.log" ]; then
          mv -f /var/xdrago/monitor/scan_nginx.archive.log /var/xdrago/monitor/scan_nginx.archive.${_X_SE}.log
        fi
        rm -f /var/xdrago/monitor/.scan_nginx_arch*
        touch /var/xdrago/monitor/.scan_nginx_arch.${_X_SE}.pid
        csf -df
        wait
      fi
    else
      mv -f /var/xdrago/monitor/check/scan_nginx.old /var/xdrago/monitor/check/scan_nginx
    fi
  fi

  if [ -x "/opt/tools/drush/8/drush/drush.php" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/lshell.ctrl.${tRee}.${_X_SE}.pid" ]; then
    if [ -z "${_CUSTOM_CONFIG_LSHELL}" ] \
      || [ "${_CUSTOM_CONFIG_LSHELL}" = "NO" ]; then
      mv -f /var/xdrago/conf/lshell.conf /var/xdrago/conf/lshell.conf.old
      curl ${crlGet} "${urlHmr}/tools/system/conf/lshell.conf" \
        -o /var/xdrago/conf/lshell.conf
      if [ -e "/var/xdrago/conf/lshell.conf" ]; then
        chmod 644 /var/xdrago/conf/lshell.conf
        chown root:root /var/xdrago/conf/lshell.conf
        touch ${pthLog}/lshell.ctrl.${tRee}.${_X_SE}.pid
      else
        mv -f /var/xdrago/conf/lshell.conf.old /var/xdrago/conf/lshell.conf
      fi
    fi
  fi

  if [ -x "/opt/tools/drush/8/drush/drush.php" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/multi.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/conf/fpm-pool-foo-multi.conf /var/xdrago/conf/fpm-pool-foo-multi.conf.old
    curl ${crlGet} "${urlHmr}/conf/php/fpm-pool-foo-multi.conf" \
      -o /var/xdrago/conf/fpm-pool-foo-multi.conf
    if [ -e "/var/xdrago/conf/fpm-pool-foo-multi.conf" ]; then
      chmod 644 /var/xdrago/conf/fpm-pool-foo-multi.conf
      chown root:root /var/xdrago/conf/fpm-pool-foo-multi.conf
      touch ${pthLog}/multi.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/conf/fpm-pool-foo-multi.conf.old /var/xdrago/conf/fpm-pool-foo-multi.conf
    fi
  fi

  if [ -e "/opt/tools/drush" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/single.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/conf/fpm-pool-foo.conf /var/xdrago/conf/fpm-pool-foo.conf.old
    curl ${crlGet} "${urlHmr}/conf/php/fpm-pool-foo.conf" \
      -o /var/xdrago/conf/fpm-pool-foo.conf
    if [ -e "/var/xdrago/conf/fpm-pool-foo.conf" ]; then
      chmod 644 /var/xdrago/conf/fpm-pool-foo.conf
      chown root:root /var/xdrago/conf/fpm-pool-foo.conf
      touch ${pthLog}/single.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/conf/fpm-pool-foo.conf.old /var/xdrago/conf/fpm-pool-foo.conf
    fi
  fi

  if [ -e "/etc/ImageMagick-6/policy.xml" ] \
    && [ -e "/var/xdrago" ] \
    && [ ! -e "${pthLog}/policymap-hf-06.ctrl.${tRee}.${_X_SE}.pid" ]; then
    IsCurlBin=$(which curl 2>&1)
    chmod 755 ${IsCurlBin} &> /dev/null
    chgrp root ${IsCurlBin} &> /dev/null
    cp -af /etc/ImageMagick-6/policy.xml /var/xdrago/conf/etc-ImageMagick-6-policy.xml.hf-06.old
    rm -f /var/xdrago/conf/etc-ImageMagick-6-policy.xml
    curl ${crlGet} "${urlHmr}/conf/etc/etc-ImageMagick-6-policy.xml" \
      -o /var/xdrago/conf/etc-ImageMagick-6-policy.xml
    if [ -e "/var/xdrago/conf/etc-ImageMagick-6-policy.xml" ]; then
      cp -af /var/xdrago/conf/etc-ImageMagick-6-policy.xml /etc/ImageMagick-6/policy.xml
      chmod 644 /etc/ImageMagick-6/policy.xml
      chown root:root /etc/ImageMagick-6/policy.xml
      touch ${pthLog}/policymap-hf-06.ctrl.${tRee}.${_X_SE}.pid
      _PHP_V="83 82 81 80 74 73 72 71 70 56"
      for e in ${_PHP_V}; do
        if [ -e "/etc/init.d/php${e}-fpm" ]; then
          service php${e}-fpm reload &> /dev/null
        fi
      done
    else
      if [ -e "/var/xdrago/conf/etc-ImageMagick-6-policy.xml.hf-06.old" ]; then
        cp -af /var/xdrago/conf/etc-ImageMagick-6-policy.xml.hf-06.old /etc/ImageMagick-6/policy.xml
      fi
    fi
  fi

  if [ -e "/opt/tools/drush" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -d "/data/u" ] \
    && [ ! -e "${pthLog}/dispatch.ctrl.${tRee}.${_X_SE}.pid" ]; then
    sed -i "s/.*cache.*//g; s/.*cc drush.*//g; s/ *$//g; /^$/d" /data/disk/*/aegir.sh
    touch ${pthLog}/dispatch.ctrl.${tRee}.${_X_SE}.pid
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/xdrago/conf/control-readme.txt" ] \
    && [ ! -e "${pthLog}/control-readme.txt.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /var/xdrago/conf/control-readme.txt /var/xdrago/conf/control-readme.txt.old
    curl ${crlGet} "${urlHmr}/tools/system/conf/control-readme.txt" -o /var/xdrago/conf/control-readme.txt
    if [ -e "/var/xdrago/conf/control-readme.txt" ]; then
      chmod 644 /var/xdrago/conf/control-readme.txt
      chown root:root /var/xdrago/conf/control-readme.txt
      touch ${pthLog}/control-readme.txt.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/conf/control-readme.txt.old /var/xdrago/conf/control-readme.txt
    fi
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -d "/data/u" ] \
    && [ ! -e "${pthLog}/fpm-cli.ctrl.${tRee}.${_X_SE}.pid" ]; then
    usrGroup=users
    [ -e "/var/backups/off-run/" ] && cp -a /var/backups/off-run/run* /var/xdrago/ &> /dev/null
    for pthSysUsr in `find /data/disk/ -maxdepth 1 -mindepth 1 | sort`; do
      tUsr=
      tUsr=$(echo ${pthSysUsr} | cut -d'/' -f4 | awk '{ print $1}' 2>&1)
      if [ "${tUsr}" != "arch" ]; then
        if [ ! -e "${pthSysUsr}/static/control/MyQuick.info" ] \
          && [ ! -e "${pthSysUsr}/static/control/MyClassic.info" ]; then
          echo ON > ${pthSysUsr}/static/control/MyQuick.info
        fi
        if [ ! -e "${pthSysUsr}/static/control/.disFastTrack.pid" ]; then
          rm -f ${pthSysUsr}/static/control/FastTrack.info
          touch ${pthSysUsr}/static/control/.disFastTrack.pid
        fi
        if [ ! -e "${pthSysUsr}/static/control/FastTrack.info" ] \
          && [ ! -e "${pthSysUsr}/static/control/ClassicTrack.info" ]; then
          echo ON > ${pthSysUsr}/static/control/ClassicTrack.info
        fi
        if [ -e "${pthSysUsr}/static/control/fpm.info" ] \
          && [ ! -e "${pthSysUsr}/static/control/cli.info" ]; then
          cp ${pthSysUsr}/static/control/fpm.info ${pthSysUsr}/static/control/cli.info
        fi
        if [ -e "${pthSysUsr}/log/CANCELLED" ] \
          || [ -e "${pthSysUsr}/log/proxied.pid" ] \
          || [ ! -e "${pthSysUsr}/static/control/cli.info" ]; then
          if [ -e "/var/xdrago/run-${tUsr}" ] \
            && [ -e "/var/aegir/drush" ]; then
            if [ ! -e "/var/backups/off-run" ]; then
              mkdir -p /var/backups/off-run/
            fi
            mv -f /var/xdrago/run-${tUsr} /var/backups/off-run/
          fi
        else
          dscUsr="/data/disk/${tUsr}"
          ngxCnf="${dscUsr}/config/includes/nginx_vhost_common.conf"
          _NGINX_CNF_TEST=$(grep "foobaroff" ${ngxCnf} 2>&1)
          if [[ "${_NGINX_CNF_TEST}" =~ "foobaroff" ]]; then
            _DO_NOTHING=YES
          else
            sed -i "s/args.*q=/args ~* \"foobaroff=/g" ${ngxCnf}
          fi
          if [ ! -e "${dscUsr}/static/control/fpm.info" ] \
            && [ -e "/var/aegir/drush" ]; then
            echo 8.1 > ${dscUsr}/static/control/fpm.info
            chown ${tUsr}.ftp:${usrGroup} ${dscUsr}/static/control/fpm.info
            chmod 0644 ${dscUsr}/static/control/fpm.info
          fi
          if [ ! -e "${dscUsr}/static/control/cli.info" ] \
            && [ -e "/var/aegir/drush" ]; then
            if [ -e "${dscUsr}/static/control/fpm.info" ]; then
              cp -af ${dscUsr}/static/control/fpm.info ${dscUsr}/static/control/cli.info
            else
              echo 8.1 > ${dscUsr}/static/control/cli.info
              chown ${tUsr}.ftp:${usrGroup} ${dscUsr}/static/control/cli.info
              chmod 0644 ${dscUsr}/static/control/cli.info
            fi
          fi
          if [ ! -e "${dscUsr}/static/control/.ctrl.${tRee}.${_X_SE}.pid" ] \
            && [ -e "/home/${tUsr}.ftp/clients" ]; then
            mkdir -p ${dscUsr}/static/control
            chmod 755 ${dscUsr}/static/control
            if [ -e "/var/xdrago/conf/control-readme.txt" ]; then
              cp -af /var/xdrago/conf/control-readme.txt \
                ${dscUsr}/static/control/README.txt &> /dev/null
              chmod 0644 ${dscUsr}/static/control/README.txt
            fi
            chown -R ${tUsr}.ftp:${usrGroup} ${dscUsr}/static/control
            rm -f ${dscUsr}/static/control/.ctrl.*
            echo OK > ${dscUsr}/static/control/.ctrl.${tRee}.${_X_SE}.pid
          fi
        fi
      fi
    done
    touch ${pthLog}/fpm-cli.ctrl.${tRee}.${_X_SE}.pid
    service nginx reload
  fi

  if [ -x "/opt/tools/drush/8/drush/drush.php" ] \
    && [ -e "${provLeIncFull}" ] \
    && [ -e "${hoLeIncFull}" ] \
    && [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -d "/data/u" ] \
    && [ ! -e "${pthLog}/hosting_le_vt.ctrl.${tRee}.${_X_SE}.pid" ]; then
    leBasePath="profiles/hostmaster/modules/aegir/hosting_le"
    lePath="${leBasePath}/drush/${provLeInc}"
    leVhPath="${leBasePath}/hosting_le_vhost/drush/${hoLeInc}"
    for pthSysUsr in `find /data/disk/ -maxdepth 1 -mindepth 1 | sort`; do
      if [ -e "${pthSysUsr}/config/server_master/nginx/vhost.d" ] \
        && [ -e "${pthSysUsr}/static/control/cli.info" ] \
        && [ ! -e "${pthSysUsr}/log/proxied.pid" ] \
        && [ ! -e "${pthSysUsr}/log/CANCELLED" ]; then
        tUsr=
        validReg=
        validIPr=
        tUsr=$(echo ${pthSysUsr} | cut -d'/' -f4 | awk '{ print $1}' 2>&1)
        dscUsr="/data/disk/${tUsr}"
        hmPf=$(cat ${dscUsr}/.drush/hostmaster.alias.drushrc.php \
          | grep "root'" \
          | cut -d: -f2 \
          | awk '{ print $3}' \
          | sed "s/[\,']//g" 2>&1)
        locFile="${hmPf}/${lePath}"
        if [ -e "${locFile}" ] && [ -e "${provLeIncFull}" ]; then
          cp -af ${provLeIncFull} ${locFile}
          chown ${tUsr}:users ${locFile}
          chmod 0644 ${locFile}
        fi
        locVhFile="${hmPf}/${leVhPath}"
        if [ -e "${locVhFile}" ] && [ -e "${hoLeIncFull}" ]; then
          cp -af ${hoLeIncFull} ${locVhFile}
          chown ${tUsr}:users ${locVhFile}
          chmod 0644 ${locVhFile}
        fi
        leRoot="${dscUsr}/tools/le"
        exeLe="${leRoot}/dehydrated"
        dehydFull="${leRoot}/${dehydName}"
        legacyLeShFile="${leRoot}/letsencrypt.sh"
        lockLeFile="${leRoot}/lock"
        configIni="${leRoot}/config"
        acctsDir="${leRoot}/accounts"
        acctsDemoDir="${leRoot}/accounts-demo"
        demoPid="${leRoot}/.ctrl/ssl-demo-mode.pid"
        normalRegPid="${leRoot}/.ctrl/normal-re6-register.pid"
        forcedRegPid="${leRoot}/.ctrl/forced-re6-register.pid"
        onDemandRegPid="${leRoot}/.ctrl/onDemand-register.pid"
        validIdn=$(grep "letsencrypt" ${acctsDir}/*/account_id.json 2>&1)
        validReg=$(grep "valid" ${acctsDir}/*/registration_info.json 2>&1)
        validIPr=$(grep "${_LOC_IP}" ${acctsDir}/*/registration_info.json 2>&1)
        _HOUR=$(date +%H 2>&1)
        _HOUR=${_HOUR//[^0-9-]/}
        if [ -e "${dehydSrcPath}" ]; then
          cp -af ${dehydSrcPath} ${dehydFull}
          chown ${tUsr}:users ${dehydFull}
          chmod 0700 ${dehydFull}
        fi
        if [ -e "${dehydFull}" ] \
          && [ ! -e "${normalRegPid}" ]; then
          if [ "${_HOUR}" = "5" ] \
            || [ "${_HOUR}" = "17" ] \
            || [ -e "${onDemandRegPid}" ]; then
            su -s /bin/bash - ${tUsr} -c "bash ${exeLe} --register --accept-terms"
            wait
            touch ${normalRegPid}
          fi
        fi
        if [ -e "${lockLeFile}" ]; then
          rm -f ${lockLeFile}
          sleep 1
        fi
        if [ -e "${demoPid}" ]; then
          rm -f ${demoPid}
        fi
        if [ "${_HOUR}" = "11" ] \
          || [ "${_HOUR}" = "23" ] \
          || [ -e "${onDemandRegPid}" ]; then
          if [ -e "${legacyLeShFile}" ] \
            || [ -e "${acctsDemoDir}" ] \
            || [[ ! "${validIdn}" =~ "letsencrypt" ]] \
            || [[ ! "${validReg}" =~ "valid" ]] \
            || [[ ! "${validIPr}" =~ "${_LOC_IP}" ]] \
            || [ ! -e "${forcedRegPid}" ]; then
            rm -f ${legacyLeShFile}
            rm -rf ${acctsDemoDir}
            rm -rf ${acctsDir}
            rm -f ${leRoot}/.ctrl/.forced*
            rm -f ${leRoot}/.ctrl/.normal*
            rm -f ${leRoot}/.ctrl/forced*
            rm -f ${leRoot}/.ctrl/normal*
            if [ -e "${exeLe}" ]; then
              su -s /bin/bash - ${tUsr} -c "bash ${exeLe} --register --accept-terms"
              wait
              touch ${forcedRegPid}
              touch ${normalRegPid}
            fi
          fi
        fi
      fi
    done
    touch ${pthLog}/hosting_le_vt.ctrl.${tRee}.${_X_SE}.pid
  fi

  if [ -e "/var/xdrago/manage_solr_config.sh" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${pthLog}/websh.fix-regr-04.ctrl.${tRee}.${_X_SE}.pid" ]; then
    mv -f /bin/websh /var/xdrago/websh.sh.old
    curl ${crlGet} "${urlHmr}/helpers/websh.sh.txt" -o /bin/websh
    if [ -e "/bin/websh" ]; then
      chmod 755 /bin/websh
      chown root:root /bin/websh
      touch ${pthLog}/websh.fix-regr-04.ctrl.${tRee}.${_X_SE}.pid
    else
      mv -f /var/xdrago/websh.sh.old /bin/websh
    fi
  fi

  _Dir="/data/all/000/modules"
  _REDIS_T_VERSION=8.x-1.6.1
  if [ -e "/var/xdrago/manage_solr_config.sh" ]; then
    if [ ! -e "${_Dir}/redis_nine_ten/ver-${_REDIS_T_VERSION}.${_X_SE}.info" ]; then
      mkdir -p ${_Dir}
      cd ${_Dir}
      rm -rf ${_Dir}/redis_nine_ten
      get_dev_contrib "redis_nine_ten-${_REDIS_T_VERSION}.tar.gz"
      echo update > ${_Dir}/redis_nine_ten/ver-${_REDIS_T_VERSION}.${_X_SE}.info
      find ${_Dir} -type d -exec chmod 0755 {} \; &> /dev/null
      find ${_Dir} -type f -exec chmod 0644 {} \; &> /dev/null
      touch ${pthLog}/redis_nine_ten.ctrl.${_X_SE}.log
    fi
  fi

  _Dir="/data/all/000/modules"
  _REDIS_C_VERSION=com-19-04-2021
  if [ -e "/var/xdrago/manage_solr_config.sh" ]; then
    if [ ! -e "${_Dir}/redis_compr/ver-${_REDIS_C_VERSION}.${_X_SE}.info" ]; then
      mkdir -p ${_Dir}
      cd ${_Dir}
      rm -rf ${_Dir}/redis_compr
      get_dev_contrib "redis_compr-${_REDIS_C_VERSION}.tar.gz"
      echo update > ${_Dir}/redis_compr/ver-${_REDIS_C_VERSION}.${_X_SE}.info
      find ${_Dir} -type d -exec chmod 0755 {} \; &> /dev/null
      find ${_Dir} -type f -exec chmod 0644 {} \; &> /dev/null
      touch ${pthLog}/redis_compr.ctrl.${_X_SE}.log
    fi
  fi

  _Dir="/data/all/000/modules"
  _REDIS_L_VERSION=7.x-3.19.1
  if [ -e "/var/xdrago/manage_solr_config.sh" ]; then
    if [ ! -e "${_Dir}/redis_edge/ver-${_REDIS_L_VERSION}.${_X_SE}.info" ]; then
      mkdir -p ${_Dir}
      cd ${_Dir}
      rm -rf ${_Dir}/redis_edge
      get_dev_contrib "redis_edge-${_REDIS_L_VERSION}.tar.gz"
      echo update > ${_Dir}/redis_edge/ver-${_REDIS_L_VERSION}.${_X_SE}.info
      find ${_Dir} -type d -exec chmod 0755 {} \; &> /dev/null
      find ${_Dir} -type f -exec chmod 0644 {} \; &> /dev/null
      touch ${pthLog}/redis_edge.ctrl.${_X_SE}.log
    fi
  fi

  _Dir="/data/all/000/modules"
  _REDIS_N_VERSION=com-19-04-2021
  if [ -e "/var/xdrago/manage_solr_config.sh" ]; then
    if [ ! -e "${_Dir}/redis_eight/ver-${_REDIS_N_VERSION}.${_X_SE}.info" ]; then
      mkdir -p ${_Dir}
      cd ${_Dir}
      rm -rf ${_Dir}/redis_eight
      get_dev_contrib "redis_eight-${_REDIS_N_VERSION}.tar.gz"
      echo update > ${_Dir}/redis_eight/ver-${_REDIS_N_VERSION}.${_X_SE}.info
      find ${_Dir} -type d -exec chmod 0755 {} \; &> /dev/null
      find ${_Dir} -type f -exec chmod 0644 {} \; &> /dev/null
      touch ${pthLog}/redis_eight.ctrl.${_X_SE}.log
    fi
  fi
}

fix_core_dgd() {
  # sed -i "s/^_PERMISSIONS_FIX=.*/_PERMISSIONS_FIX=YES/g" ${barCnf}

  saCoreS="${saCoreN}-D7"
  saIncDb="includes/database/database.inc"
  saPatch="/var/xdrago/conf/${saCoreS}.patch"

  saQCoreN="${saCoreN}"
  saQCoreS="${saQCoreN}-D8"
  saQIncDb="core/includes/database.inc"
  saQPatch="/var/xdrago/conf/${saQCoreS}.patch"

  saXCoreN="${saCoreN}"
  saXCoreS="${saXCoreN}-D6"
  saXIncDb="includes/database.inc"
  saXPatch="/var/xdrago/conf/${saXCoreS}.patch"

  saBCoreP="${saCoreN}-provision"
  saBPatch="/var/xdrago/conf/${saBCoreP}.patch"

  # SA-CORE D8 patch
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${saQPatch}" ]; then
    mkdir -p /var/xdrago/conf
    curl ${crlGet} "${urlHmr}/patches/8-core/${saQCoreS}.patch" -o ${saQPatch}
  fi

  # SA-CORE D7 patch
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${saPatch}" ]; then
    mkdir -p /var/xdrago/conf
    curl ${crlGet} "${urlHmr}/patches/7-core/${saCoreS}.patch" -o ${saPatch}
  fi

  # SA-CORE D6 patch
  # if [ -e "/var/xdrago" ] \
  #   && [ -e "/var/aegir/drush" ] \
	#   && [ ! -e "${saXPatch}" ]; then
	#   mkdir -p /var/xdrago/conf
	#   curl ${crlGet} "${urlHmr}/patches/6-core/${saXCoreS}.patch" -o ${saXPatch}
  # fi

  # SA-CORE for Octopus hostmaster platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -d "/data/u" ] \
    && [ -e "${saPatch}" ]; then
    if [ -d "/data/all" ] \
      && [ ! -e "${pthLog}/hostmaster-octopus-${saCoreN}-fixed-d7.log" ]; then
      for File in `find /data/disk/*/aegir/distro/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
        fi
      done
      touch ${pthLog}/hostmaster-octopus-${saCoreN}-fixed-d7.log
    fi
    cd
  fi

  # SA-CORE for Barracuda hostmaster platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saPatch}" ]; then
    if [ -d "/data/all" ] \
      && [ ! -e "${pthLog}/hostmaster-barracuda-${saCoreN}-fixed-d7.log" ]; then
      for File in `find /var/aegir/host_master/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
        fi
      done

      for File in `find /var/aegir/hostmaster*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
        fi
      done

      touch ${pthLog}/hostmaster-barracuda-${saCoreN}-fixed-d7.log
    fi
    cd
  fi

  # SA-CORE for built-in D7 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saPatch}" ] \
    && [ ! -e "${pthLog}/${saCoreN}-fixed-d7.log" ]; then
    if [ -d "/data/all/000/core" ]; then
      for Core in `find /data/all/000/core/drupal-7* \
        -maxdepth 0 -mindepth 0 | sort`; do
        cd ${Core}
        patch -p1 < ${saPatch} &> /dev/null
      done
    elif [ -d "/data/disk/all/000/core" ]; then
      for Core in `find /data/disk/all/000/core/drupal-7* \
        -maxdepth 0 -mindepth 0 | sort`; do
        cd ${Core}
        patch -p1 < ${saPatch} &> /dev/null
      done
    fi
    touch ${pthLog}/${saCoreN}-fixed-d7.log
    cd
  fi

  # SA-CORE for ancient D7 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saPatch}" ]; then
    if [ -d "/data/all" ] \
      && [ ! -e "${pthLog}/legacy-${saCoreN}-fixed-d7.log" ]; then
      for File in `find /data/all/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
        fi
      done
      touch ${pthLog}/legacy-${saCoreN}-fixed-d7.log
    elif [ -d "/data/disk/all" ] \
      && [ ! -e "${pthLog}/legacy-${saCoreN}-fixed-d7eee.log" ]; then
      for File in `find /data/disk/all/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
        fi
      done
      touch ${pthLog}/legacy-${saCoreN}-fixed-d7eee.log
    fi
    cd
  fi

  # SA-CORE for custom D7 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saPatch}" ]; then
    if [ -d "/data/u" ] \
      && [ ! -e "${pthLog}/batch-custom-${saCoreN}-fixed-d7.log" ]; then
      for File in `find /data/disk/*/static/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/*/${saIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saCoreS}-fix.info
        fi
      done
    fi
    cd
    touch ${pthLog}/batch-custom-${saCoreN}-fixed-d7.log
  fi

  # SA-CORE for D8 platforms in ~/static
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saQPatch}" ]; then
    if [ -d "/data/u" ] \
      && [ ! -e "${pthLog}/batch-custom-${saQCoreN}-fixed-d8.log" ]; then
      for File in `find /data/disk/*/static/*/${saQIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/core.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saQCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saQPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saQCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/${saQIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/core.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saQCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saQPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saQCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/${saQIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/core.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saQCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saQPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saQCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/${saQIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/core.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saQCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saQPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saQCoreS}-fix.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/*/${saQIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/core.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saQCoreS}-fix.info" ]; then
          cd ${Core}
          patch -p1 < ${saQPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saQCoreS}-fix.info
        fi
      done
    fi
    cd
    touch ${pthLog}/batch-custom-${saQCoreN}-fixed-d8.log
  fi

  # SA-CORE for built-in D6 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saXPatch}" ] \
    && [ ! -e "${pthLog}/${saXCoreN}-finally-fixed-d6.log" ]; then
    if [ -d "/data/all/000/core" ]; then
      for Core in `find /data/all/000/core/pressflow-6* \
        -maxdepth 0 -mindepth 0 | sort`; do
        cd ${Core}
        patch -p1 < ${saXPatch} &> /dev/null
      done
    elif [ -d "/data/disk/all/000/core" ]; then
      for Core in `find /data/disk/all/000/core/pressflow-6* \
        -maxdepth 0 -mindepth 0 | sort`; do
        cd ${Core}
        patch -p1 < ${saXPatch} &> /dev/null
      done
    fi
    touch ${pthLog}/${saXCoreN}-finally-fixed-d6.log
    cd
  fi

  # SA-CORE for ancient D6 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saXPatch}" ]; then
    if [ -d "/data/all" ] \
      && [ ! -e "${pthLog}/legacy-${saXCoreN}-finally-fixed-d6.log" ]; then
      for File in `find /data/all/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
        fi
      done
      touch ${pthLog}/legacy-${saXCoreN}-finally-fixed-d6.log
    elif [ -d "/data/disk/all" ] \
      && [ ! -e "${pthLog}/legacy-${saXCoreN}-finally-fixed-d6eee.log" ]; then
      for File in `find /data/disk/all/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] && [ ! -e "${Core}/core" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
        fi
      done
      touch ${pthLog}/legacy-${saXCoreN}-finally-fixed-d6eee.log
    fi
    cd
  fi

  # SA-CORE for custom D6 platforms
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ -e "${saXPatch}" ]; then
    if [ -d "/data/u" ] \
      && [ ! -e "${pthLog}/batch-custom-${saXCoreN}-finally-fixed-d6.log" ]; then
      for File in `find /data/disk/*/static/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saXCoreS}-fix-finally.info" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saXCoreS}-fix-finally.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saXCoreS}-fix-finally.info" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saXCoreS}-fix-finally.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saXCoreS}-fix-finally.info" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saXCoreS}-fix-finally.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saXCoreS}-fix-finally.info" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saXCoreS}-fix-finally.info
        fi
      done
      for File in `find /data/disk/*/static/*/*/*/*/*/${saXIncDb} \
        -maxdepth 0 -mindepth 0 | sort`; do
        Core=$(echo $File \
          | sed 's/\/includes.*//g' \
          | awk '{print $1}' 2> /dev/null)
        if [ -d "${Core}" ] \
          && [ ! -e "${Core}/core" ] \
          && [ ! -e "${Core}/profiles/${saXCoreS}-fix-finally.info" ]; then
          cd ${Core}
          patch -p1 < ${saXPatch} &> /dev/null
          echo fixed > ${Core}/profiles/${saXCoreS}-fix-finally.info
        fi
      done
    fi
    cd
    touch ${pthLog}/batch-custom-${saXCoreN}-finally-fixed-d6.log
  fi
}

fix_ping_perms() {
  if [ -e "/bin/ping" ]; then
    _PING_TEST=$(ls -la /bin/ping | grep rwsr-xr-x 2>&1)
    if [ -z "${_PING_TEST}" ]; then
      chown root:root /bin/ping
      chmod 4755 /bin/ping
    fi
  fi
}

fix_fpm_process_max() {
  if [ ! -e "${pthLog}/process.max.ctrl.${tRee}.${_X_SE}.pid" ]; then
    sed -i "s/process.max =.*/process.max = 0/g" /opt/php*/etc/php*-fpm.conf
    touch ${pthLog}/process.max.ctrl.${tRee}.${_X_SE}.pid
  fi
}

fix_node_in_lshell_access() {
  if [ ! -e "${pthLog}/node.lshell-fix-scp.ctrl.${tRee}.${_X_SE}.pid" ] \
    && [ -e "/etc/lshell.conf" ]; then
    PrTestPhantom=$(grep "PHANTOM" /root/.*.octopus.cnf 2>&1)
    PrTestCluster=$(grep "CLUSTER" /root/.*.octopus.cnf 2>&1)
    if [[ "${PrTestPhantom}" =~ "PHANTOM" ]] \
      || [[ "${PrTestCluster}" =~ "CLUSTER" ]] \
      || [ -e "/root/.allow.node.lshell.cnf" ]; then
      _ALLOW_NODE=YES
    else
      _ALLOW_NODE=NO
      sed -i "s/, 'node',/,/g" /etc/lshell.conf
      wait
      sed -i "s/, 'node',/,/g" /var/xdrago/conf/lshell.conf
      wait
      sed -i "s/, 'npm',/,/g" /etc/lshell.conf
      wait
      sed -i "s/, 'npm',/,/g" /var/xdrago/conf/lshell.conf
      wait
      sed -i "s/, 'npx',/,/g" /etc/lshell.conf
      wait
      sed -i "s/, 'npx',/,/g" /var/xdrago/conf/lshell.conf
      wait
      sed -i "s/, 'find',/,/g" /etc/lshell.conf
      wait
      sed -i "s/, 'find',/,/g" /var/xdrago/conf/lshell.conf
      wait
      sed -i "s/, 'scp',/,/g" /etc/lshell.conf
      wait
      sed -i "s/, 'scp',/,/g" /var/xdrago/conf/lshell.conf
      wait
    fi
    touch ${pthLog}/node.lshell-fix-scp.ctrl.${tRee}.${_X_SE}.pid
  fi
}

fix_python() {
  _PYTHON_VRN=3.12.5
  _DCY_PTN="/usr/local/bin/python3"
  if [ -x "${_DCY_PTN}" ]; then
    _PYTHON_TEST=$(${_DCY_PTN} --version 2>&1)
  fi
  if [[ ! "${_PYTHON_TEST}" =~ "Python ${_PYTHON_VRN}" ]] \
    || [ ! -x "${_DCY_PTN}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install -y \
        intltool \
        libffi-dev \
        par2 \
        python3-pip \
        python3-venv \
        python3 \
        rclone \
        rdiff \
        tzdata
    cd /var/opt
    rm -rf Python*
    get_dev_src "Python-${_PYTHON_VRN}.tgz"
    tar -xzf Python-${_PYTHON_VRN}.tgz
    cd Python-${_PYTHON_VRN}
    if [ -d "/usr/local/ssl3" ]; then
      bash ./configure --with-openssl=/usr/local/ssl3
    else
      bash ./configure --with-openssl=/usr/local/ssl
    fi
    make -j $(nproc) --quiet
    make install --quiet
    cd
    apt_clean_update
    apt-get install python3-pip -y
    pip3 install --upgrade pip --root-user-action ignore
  fi
}

if_fix_python() {
  _PYTHON_FIX=NO
  _LSHELL_CHK_VRN=0.9.18
  isLshell=$(which lshell 2>&1)
  if [ -x "${isLshell}" ]; then
    _LSHELL_ITD=$(${isLshell} --version 2>&1 \
      | tr -d "\n" \
      | cut -d"-" -f2 \
      | awk '{ print $1}' 2>&1)
    if [ "${_LSHELL_ITD}" != "${_LSHELL_CHK_VRN}" ] \
      || [[ "${_LSHELL_ITD}" =~ "Traceback" ]] \
      || [[ "${_LSHELL_ITD}" =~ "ImportError" ]]; then
      _PYTHON_FIX=YES
    fi
  fi
  _DUPLICITY_CHK_VRN=3.0.2
  isDuplicity=$(which duplicity 2>&1)
  if [ -x "${isDuplicity}" ]; then
    _DUPLICITY_ITD=$(${isDuplicity} --version 2>&1 \
      | tr -d "\n" \
      | cut -d" " -f2 \
      | awk '{ print $1}' 2>&1)
    if [ "${_DUPLICITY_ITD}" != "${_DUPLICITY_CHK_VRN}" ]; then
      _PYTHON_FIX=YES
    fi
  fi
  [ "${_PYTHON_FIX}" = "YES" ] && fix_python
}

fix_lshell() {
  _LSHELL_VRN=0.9.18.10
  _PATH_LSHELL="${usrBin}/lshell"
  _LSHELL_CHK_VRN=0.9.18
  _LSHELL_FORCE_REINSTALL=NO
  isLshell=$(which lshell 2>&1)
  _LSHELL_ITD=$(${isLshell} --version 2>&1 \
    | tr -d "\n" \
    | cut -d"-" -f2 \
    | awk '{ print $1}' 2>&1)
  if [ "${_LSHELL_ITD}" != "${_LSHELL_CHK_VRN}" ] \
    || [[ "${_LSHELL_ITD}" =~ "Traceback" ]] \
    || [[ "${_LSHELL_ITD}" =~ "ImportError" ]]; then
    _LSHELL_FORCE_REINSTALL=YES
  fi
  if [ -e "${_PATH_LSHELL}" ] \
    && [ "${_LSHELL_FORCE_REINSTALL}" = "YES" ]; then
    cp -af /etc/lshell.conf /etc/lshell.conf-bak-${_LSHELL_VRN}-hotfix5
    apt_clean_update
    apt-get install python3-pip -y
    pip3 install --upgrade pip --root-user-action ignore
    cd /var/opt
    rm -rf lshell*
    get_dev_src "lshell-${_LSHELL_VRN}.tar.gz"
    for Files in `find /var/opt/lshell-${_LSHELL_VRN} -type f`; do
      sed -i "s/kicked/logged/g" $Files &> /dev/null
      wait
      sed -i "s/Kicked/Logged/g" $Files &> /dev/null
      wait
    done
    rm -rf /usr/local/lib/python*/site-packages/lshell*
    rm -rf /usr/local/lib/python*/dist-packages/lshell*
    cd /var/opt/lshell-${_LSHELL_VRN}
    if [ -x "/usr/bin/pip" ]; then
      usePip=/usr/bin/pip
    elif [ -x "/usr/local/bin/pip" ]; then
      usePip=/usr/local/bin/pip
    fi
    _PIP_TEST=$(${usePip} --version 2>&1)
    if [[ "${_PIP_TEST}" =~ "python 3.11" ]] \
      || [[ "${_PIP_TEST}" =~ "python 3.12" ]]; then
      ${usePip} install . --break-system-packages --root-user-action ignore
    else
      ${usePip} install .
    fi
    cp -af /etc/lshell.conf-bak-${_LSHELL_VRN}-hotfix5 /etc/lshell.conf
    rm -f /etc/logrotate.d/lshell
    addgroup --system lshellg &> /dev/null
    mkdir -p /var/log/lsh
    chown :lshellg /var/log/lsh
    chmod 770 /var/log/lsh &> /dev/null
    touch ${pthLog}/lshell-build-${_LSHELL_VRN}.log-hotfix5
    who | awk '$1 !~ /root/{ cmd="pkill -KILL -u " $1; system(cmd) }'
    touch ${pthLog}/lshell-fix-build-${_LSHELL_VRN}.log
  fi
  if [ -f "${usrBin}/lshell" ]; then
    if [ ! -L "/usr/bin/lshell" ]; then
      ln -sfn ${usrBin}/lshell /usr/bin/lshell &> /dev/null
    fi
  fi
}

fix_log4j() {
  _LOG4J_VRN=2.17.1
  _DO_SOLR_RESTART=
  if [ -x "/etc/init.d/solr7" ] && [ -e "/etc/default/solr7.in.sh" ]; then
    if [ -e "/opt/solr-7.7.3" ] \
      && [ ! -e "/opt/solr-7.7.3/server/lib/ext/log4j-core-${_LOG4J_VRN}.jar" ]; then
      cd /var/opt
      rm -rf apache-log4j*
      get_dev_src "apache-log4j-${_LOG4J_VRN}-bin.tar.gz"
      if [ -e "/var/opt/apache-log4j-${_LOG4J_VRN}-bin/log4j-core-${_LOG4J_VRN}.jar" ]; then
        cd /var/opt/apache-log4j-${_LOG4J_VRN}-bin
        mkdir -p /var/backups/log4j/solr-7.7.3/
        mv -f /opt/solr-7.7.3/server/lib/ext/log4j* /var/backups/log4j/solr-7.7.3/
        rm -f /opt/solr-7.7.3/contrib/prometheus-exporter/lib/log4j*
        cp -af log4j-1.2-api-${_LOG4J_VRN}.jar    /opt/solr-7.7.3/server/lib/ext/
        cp -af log4j-core-${_LOG4J_VRN}.jar       /opt/solr-7.7.3/server/lib/ext/
        cp -af log4j-core-${_LOG4J_VRN}.jar       /opt/solr-7.7.3/contrib/prometheus-exporter/lib/
        cp -af log4j-slf4j-impl-${_LOG4J_VRN}.jar /opt/solr-7.7.3/server/lib/ext/
        cp -af log4j-slf4j-impl-${_LOG4J_VRN}.jar /opt/solr-7.7.3/contrib/prometheus-exporter/lib/
        cp -af log4j-api-${_LOG4J_VRN}.jar        /opt/solr-7.7.3/server/lib/ext/
        cp -af log4j-api-${_LOG4J_VRN}.jar        /opt/solr-7.7.3/contrib/prometheus-exporter/lib/
        chown root:root /opt/solr-7.7.3/server/lib/ext/log4j*
        chown root:root /opt/solr-7.7.3/contrib/prometheus-exporter/lib/log4j*
        _DO_SOLR_RESTART=YES
      fi
    fi
    if [ -e "/opt/solr-7.6.0" ] \
      && [ ! -e "/opt/solr-7.6.0/server/lib/ext/log4j-core-${_LOG4J_VRN}.jar" ]; then
      cd /var/opt
      rm -rf apache-log4j*
      get_dev_src "apache-log4j-${_LOG4J_VRN}-bin.tar.gz"
      if [ -e "/var/opt/apache-log4j-${_LOG4J_VRN}-bin/log4j-core-${_LOG4J_VRN}.jar" ]; then
        cd /var/opt/apache-log4j-${_LOG4J_VRN}-bin
        mkdir -p /var/backups/log4j/solr-7.6.0/
        mv -f /opt/solr-7.6.0/server/lib/ext/log4j* /var/backups/log4j/solr-7.6.0/
        rm -f /opt/solr-7.6.0/contrib/prometheus-exporter/lib/log4j*
        cp -af log4j-1.2-api-${_LOG4J_VRN}.jar    /opt/solr-7.6.0/server/lib/ext/
        cp -af log4j-core-${_LOG4J_VRN}.jar       /opt/solr-7.6.0/server/lib/ext/
        cp -af log4j-core-${_LOG4J_VRN}.jar       /opt/solr-7.6.0/contrib/prometheus-exporter/lib/
        cp -af log4j-slf4j-impl-${_LOG4J_VRN}.jar /opt/solr-7.6.0/server/lib/ext/
        cp -af log4j-slf4j-impl-${_LOG4J_VRN}.jar /opt/solr-7.6.0/contrib/prometheus-exporter/lib/
        cp -af log4j-api-${_LOG4J_VRN}.jar        /opt/solr-7.6.0/server/lib/ext/
        cp -af log4j-api-${_LOG4J_VRN}.jar        /opt/solr-7.6.0/contrib/prometheus-exporter/lib/
        chown root:root /opt/solr-7.6.0/server/lib/ext/log4j*
        chown root:root /opt/solr-7.6.0/contrib/prometheus-exporter/lib/log4j*
        _DO_SOLR_RESTART=YES
      fi
    fi
    _RESULT_LOG4J=$(grep "LOG4J_FORMAT_MSG_NO_LOOKUPS=true" /etc/default/solr7.in.sh 2>&1)
    if [[ ! "${_RESULT_LOG4J}" =~ "LOG4J" ]]; then
      echo "LOG4J_FORMAT_MSG_NO_LOOKUPS=true" >> /etc/default/solr7.in.sh
    fi
    if [[ ! "${_RESULT_LOG4J}" =~ "LOG4J" ]] || [ ! -z "${_DO_SOLR_RESTART}" ]; then
      #kill -9 $(ps aux | grep '[s]olr' | awk '{print $2}') &> /dev/null
      service solr7 restart &> /dev/null
    fi
  fi
}

fix_authorized_keys() {
  if [ ! -e "${pthLog}/fix_authorized_keys.ctrl.${tRee}.${_X_SE}.pid" ]; then
    chmod 0600 /home/*/.ssh/authorized_keys &> /dev/null
    chmod 0700 /home/*/.ssh &> /dev/null
    touch ${pthLog}/fix_authorized_keys.ctrl.${tRee}.${_X_SE}.pid
  fi
}

fix_tcp() {
  _TCP_FIX=$(grep "tcp_challenge_ack_limit" /etc/sysctl.conf 2>&1)
  if [ -z "${_TCP_FIX}" ]; then
    echo "net.ipv4.tcp_challenge_ack_limit = 1073741823" >> /etc/sysctl.conf
  fi
}

fix_aio() {
  _AIO_FIX=$(grep "fs.aio-max-nr" /etc/sysctl.conf 2>&1)
  if [ -z "${_AIO_FIX}" ]; then
    echo "fs.aio-max-nr = 2097152" >> /etc/sysctl.conf
  fi
}

fix_console_print() {
  _PRK_FIX=$(grep "kernel.printk" /etc/sysctl.conf 2>&1)
  if [ -z "${_PRK_FIX}" ]; then
    echo "kernel.printk = 4 1 1 7" >> /etc/sysctl.conf
  fi
}

fix_java_symlinks() {
  if [ "${_OS_CODE}" = "jessie" ] && [ -x "/usr/lib/jvm/java-7-openjdk/jre/bin/java" ]; then
    if [ ! -e "/usr/bin/java" ] || [ ! -e "/etc/alternatives/java" ]; then
      ln -sfn /usr/lib/jvm/java-7-openjdk/jre/bin/java /etc/alternatives/java
      ln -sfn /etc/alternatives/java /usr/bin/java
      echo fixed java symlinks for ${_OS_CODE}
    fi
  fi
  if [ "${_OS_CODE}" = "stretch" ] && [ -x "/usr/lib/jvm/java-8-openjdk/jre/bin/java" ]; then
    if [ ! -e "/usr/bin/java" ] || [ ! -e "/etc/alternatives/java" ]; then
      ln -sfn /usr/lib/jvm/java-8-openjdk/jre/bin/java /etc/alternatives/java
      ln -sfn /etc/alternatives/java /usr/bin/java
      echo fixed java symlinks for ${_OS_CODE}
    fi
  fi
  if [ "${_OS_CODE}" = "daedalus" ] || [ "${_OS_CODE}" = "bookworm" ]; then
    if [ -x "/usr/lib/jvm/java-11-openjdk/bin/java" ]; then
      if [ ! -e "/usr/bin/java" ] || [ ! -e "/etc/alternatives/java" ]; then
        ln -sfn /usr/lib/jvm/java-11-openjdk/bin/java /etc/alternatives/java
        ln -sfn /etc/alternatives/java /usr/bin/java
        echo fixed java symlinks for ${_OS_CODE}
      fi
    fi
  else
    if [ -x "/usr/lib/jvm/java-11-openjdk/bin/java" ]; then
      if [ ! -e "/usr/bin/java" ] || [ ! -e "/etc/alternatives/java" ]; then
        ln -sfn /usr/lib/jvm/java-11-openjdk/bin/java /etc/alternatives/java
        ln -sfn /etc/alternatives/java /usr/bin/java
        echo fixed java symlinks for ${_OS_CODE}
      fi
    fi
  fi
}

fix_wkhtml_perms() {

  _WKHTML_ARRAY="/usr/local/bin/wkhtmltopdf \
                  /usr/bin/wkhtmltopdf \
                  /usr/bin/wkhtmltopdf-0.12.4 \
                  /usr/local/bin/wkhtmltoimage \
                  /usr/bin/wkhtmltoimage \
                  /usr/bin/wkhtmltoimage-0.12.4"

  for _WKHTML_ITEM in ${_WKHTML_ARRAY}; do
    if [ -x "${_WKHTML_ITEM}" ]; then
      _PERM_TEST=$(ls -la ${_WKHTML_ITEM} | grep rwxr-xr-x 2>&1)
      if [ -z "${_PERM_TEST}" ]; then
        chgrp root ${_WKHTML_ITEM} &> /dev/null
        chmod 755 ${_WKHTML_ITEM} &> /dev/null
      fi
    fi
  done
}

fix_wkhtml() {
  if [ -x "/usr/local/bin/wkhtmltopdf" ] \
    && [ -L "/usr/bin/wkhtmltopdf" ]; then
    rm -f /usr/bin/wkhtmltopdf
    cp -af /usr/local/bin/wkhtmltopdf /usr/bin/wkhtmltopdf
    chgrp root /usr/bin/wkhtmltopdf &> /dev/null
    chmod 755 /usr/bin/wkhtmltopdf &> /dev/null
  fi
  if [ -x "/usr/local/bin/wkhtmltoimage" ] \
    && [ -L "/usr/bin/wkhtmltoimage" ]; then
    rm -f /usr/bin/wkhtmltoimage
    cp -af /usr/local/bin/wkhtmltoimage /usr/bin/wkhtmltoimage
    chgrp root /usr/bin/wkhtmltoimage &> /dev/null
    chmod 755 /usr/bin/wkhtmltoimage &> /dev/null
  fi
  if [ ! -x "/usr/local/bin/wkhtmltopdf" ] \
    && [ -x "/usr/bin/wkhtmltopdf" ]; then
    rm -f /usr/local/bin/wkhtmltopdf
    cp -af /usr/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf
    chgrp root /usr/local/bin/wkhtmltopdf &> /dev/null
    chmod 755 /usr/local/bin/wkhtmltopdf &> /dev/null
  fi
  if [ ! -x "/usr/local/bin/wkhtmltoimage" ] \
    && [ -x "/usr/bin/wkhtmltoimage" ]; then
    rm -f /usr/local/bin/wkhtmltoimage
    cp -af /usr/bin/wkhtmltoimage /usr/local/bin/wkhtmltoimage
    chgrp root /usr/local/bin/wkhtmltoimage &> /dev/null
    chmod 755 /usr/local/bin/wkhtmltoimage &> /dev/null
  fi
}

fix_eldir() {
  if [ -e "/var/xdrago" ] \
    && [ -e "/var/aegir/drush" ] \
    && [ ! -e "${eldirP}" ]; then
    mkdir -p /var/xdrago/conf
    curl ${crlGet} "${urlHmr}/patches/${eldirF}" -o ${eldirP}
  fi
}

fix_drupal_core_ten() {
  if [ -e "/var/xdrago" ]; then
    if [ ! -e "${dctpP}" ] || [ ! -e "${dctrP}" ]; then
      mkdir -p /data/conf/patches
      curl ${crlGet} "${urlHmr}/patches/${dctrF}" -o ${dctrP}
      cp -af ${dctrP} ${dctpP}
    fi
  fi
}

fix_pure_ftpd() {
  if [ -e "/usr/local/etc/pure-ftpd.conf" ]; then
    _PAM_AUTH=$(grep "^PAMAuthentication" /usr/local/etc/pure-ftpd.conf 2>&1)
    if [ ! -z "${_PAM_AUTH}" ]; then
      sed -i "s/^PAMAuthentication/# PAMAuthentication/g" /usr/local/etc/pure-ftpd.conf
      killall -9 pure-ftpd &> /dev/null
    fi
  fi
}

fix_hosting_le() {
  if [ -d "/var/xdrago/conf" ]; then
    if [ ! -e "${hoLeIncFull}.ctrl.${tRee}.${_X_SE}.pid" ] \
      || [ -e "/var/xdrago/${provLeInc}" ] \
      || [ -e "/var/xdrago/${hoLeInc}" ] \
      || [ -e "/var/xdrago/${dehydName}" ] \
      || [ -e "/root/${provLeInc}" ] \
      || [ -e "/root/hosting_le_vhost.drush.inc.ctrl.${tRee}.${_X_SE}.pid" ] \
      || [ -e "/root/${hoLeInc}" ] \
      || [ -e "${legacyLeSh}" ] \
      || [ ! -e "${dehydSrcPath}" ] \
      || [ ! -e "${provLeIncFull}.ctrl.${tRee}.${_X_SE}.pid" ]; then
      mkdir -p /var/xdrago/conf
      rm -f /var/xdrago/*.drush.inc*
      rm -f /root/*.drush.inc*
      rm -f ${legacyLeSh}
      rm -f ${dehydSrcPath}.ctrl.${tRee}.${_X_SE}.pid
      rm -f ${hoLeIncFull}.ctrl.${tRee}.${_X_SE}.pid
      rm -f ${provLeIncFull}.ctrl.${tRee}.${_X_SE}.pid
      curl ${crlGet} "${urlHmr}/helpers/${dehydName}" -o ${dehydSrcPath}.ctrl.${tRee}.${_X_SE}.pid
      cp -af ${dehydSrcPath}.ctrl.${tRee}.${_X_SE}.pid ${dehydSrcPath}
      curl ${crlGet} "${urlHmr}/patches/${hoLeInc}" -o ${hoLeIncFull}.ctrl.${tRee}.${_X_SE}.pid
      cp -af ${hoLeIncFull}.ctrl.${tRee}.${_X_SE}.pid ${hoLeIncFull}
      curl ${crlGet} "${urlHmr}/patches/${provLeInc}" -o ${provLeIncFull}.ctrl.${tRee}.${_X_SE}.pid
      cp -af ${provLeIncFull}.ctrl.${tRee}.${_X_SE}.pid ${provLeIncFull}
    fi
  fi
}

fix_newrelic() {
  _PHP_EXT_DIR_74="/opt/php74/lib/php/extensions/no-debug-non-zts-20190902"
  _NR_SO="/usr/lib/newrelic-php5/agent/x64/newrelic-20190902.so"
  if [ -e "${_PHP_EXT_DIR_74}" ] \
    && [ -e "${_NR_SO}" ] \
    && [ ! -e "${_PHP_EXT_DIR_74}/newrelic.so" ]; then
    ln -s ${_NR_SO} ${_PHP_EXT_DIR_74}/newrelic.so
    service php74-fpm reload
  fi
  _PHP_EXT_DIR_56="/opt/php56/lib/php/extensions/no-debug-non-zts-20131226"
  _NR_SO="/usr/lib/newrelic-php5/agent/x64/newrelic-20131226.so"
  if [ -e "${_PHP_EXT_DIR_56}" ] \
    && [ ! -e "${_NR_SO}" ] \
    && [ -L "${_PHP_EXT_DIR_56}/newrelic.so" ]; then
    rm -f ${_PHP_EXT_DIR_56}/newrelic.so
    service php56-fpm reload
  fi
}

fix_leftovers() {
  if [ -e "/data/disk/arch/static/control" ]; then
    rm -rf /data/disk/arch/static
  fi
}

force_rebuild() {
  if [ ! -e "${pthLog}/forced.rebuild.glibc.txt" ]; then
    echo "_GIT_FORCE_REINSTALL=YES" >> ${barCnf}
    echo "_NGX_FORCE_REINSTALL=YES" >> ${barCnf}
    echo "_PHP_FORCE_REINSTALL=YES" >> ${barCnf}
    echo "_SSH_FORCE_REINSTALL=YES" >> ${barCnf}
    echo "_SSL_FORCE_REINSTALL=YES" >> ${barCnf}
    rm -f ${pthLog}/pure-ftpd-build*
    rm -f ${pthLog}/mss-build*
    rm -f ${pthLog}/lshell-build*
    rm -f ${pthLog}/redis-*
    touch ${pthLog}/forced.rebuild.glibc.txt
  fi
}

#
# Detect, remove, and report broken symlinks
check_and_remove_broken_symlinks() {
  local dir=$1

  # Find broken symlinks in the directory
  broken_symlinks=$(find "${dir}" -maxdepth 1 -type l ! -exec test -e {} \; -print)

  if [ -n "${broken_symlinks}" ]; then
    if [ "${_DEBUG_MODE}" = "YES" ]; then
      echo "CLNP: Removing the following broken symlinks from ${dir}:"
      echo "CLNP: ${broken_symlinks}"
    fi

    for symlink in $broken_symlinks; do
      rm "${symlink}"
      if [ "${_DEBUG_MODE}" = "YES" ]; then
        echo "CLNP: Removed broken symlink: ${symlink}"
      fi
    done

    # Set the ifAnySymlinksCleaned variable to true since we removed broken symlinks
    ifAnySymlinksCleaned=YES
  else
    if [ "${_DEBUG_MODE}" = "YES" ]; then
      echo "CLNP: No broken symlinks found in ${dir}"
    fi
  fi
}

#
# Check and move disallowed versions
check_and_move() {
  local dir=$1

  # Determine the name of the backup subdirectory based on the source directory
  local backup_dir="${backLegBase}$(echo "${dir}" | tr '/' '_')"

  # Find any libcurl.so files in the directory, excluding the allowed version and those without a complete version number
  found_versions=$(find "${dir}" -maxdepth 1 -type f -name "libcurl.so.*" ! -name "${allowedFile}" | grep -E "libcurl\.so\.[0-9]+\.[0-9]+\.[0-9]+$")

  if [ -n "${found_versions}" ]; then
    if [ "${_DEBUG_MODE}" = "YES" ]; then
      echo "CLNP: Moving the following disallowed versions from ${dir} to ${backup_dir}:"
      echo "CLNP: ${found_versions}"
    fi

    # Create the backup directory if it doesn't exist
    mkdir -p "${backup_dir}"

    # Move each found version to the backup directory
    for file in ${found_versions}; do
      mv -f "${file}" "${backup_dir}/"
      if [ "${_DEBUG_MODE}" = "YES" ]; then
        echo "CLNP: Moved ${file} to ${backup_dir}/"
      fi
    done

    # Set the ifAnyFilesCleaned variable to true since we moved files
    ifAnyFilesCleaned=YES
  else
    if [ "${_DEBUG_MODE}" = "YES" ]; then
      echo "CLNP: Only the allowed version (${allowedFile}) is present in ${dir}"
    fi
  fi
}

if_reinstall_curl() {
  _CURL_VRN=8.9.1
  _CURL_INSTALL_REQUIRED=NO
  if ! command -v lsb_release &> /dev/null; then
    apt-get update -qq &> /dev/null
    apt-get install lsb-release -y -qq &> /dev/null
  fi
  _OS_CODE=$(lsb_release -ar 2>/dev/null | grep -i codename | cut -s -f2 2>&1)
  [ "${_OS_CODE}" = "jessie" ] && _CURL_VRN=7.71.1
  [ "${_OS_CODE}" = "stretch" ] && _CURL_VRN=8.2.1

  if [ -e "/var/aegir/drush" ] \
    && [ "${_OS_CODE}" != "jessie" ] \
    && [ "${_OS_CODE}" != "stretch" ]; then

    # Target version
    allowedFile="libcurl.so.4.8.0"

    # Directories to check
    dirsToClean=("/usr/lib" "/usr/local/lib" "/usr/lib/x86_64-linux-gnu")

    # Backup base directory
    backLegBase="/var/backups/legacy-libcurl-boa-${_NOW}"

    # Variable to track if any files were moved
    ifAnyFilesCleaned=NO

    # Variable to track if any broken symlinks were found and removed
    ifAnySymlinksCleaned=NO

    # Iterate over the directories and apply the check_and_move function
    for dir in "${dirsToClean[@]}"; do
      check_and_move "${dir}"
    done

    # Iterate over the directories and apply the check_and_remove_broken_symlinks function
    for dir in "${dirsToClean[@]}"; do
      check_and_remove_broken_symlinks "${dir}"
    done

    # Export the ifAnyFilesCleaned variable for later use
    export ifAnyFilesCleaned

    # Export the ifAnySymlinksCleaned variable for later use
    export ifAnySymlinksCleaned

  fi

  if [ "${ifAnySymlinksCleaned}" = "YES" ] \
    || [ "${ifAnyFilesCleaned}" = "YES" ]; then
    ldconfig 2> /dev/null
    _CURL_INSTALL_REQUIRED=YES
    bkLibcurlPre="/var/backups/legacy-libcurl-pre-${_CURL_VRN}-${_NOW}"
    mkdir -p ${bkLibcurlPre}
    mv -f /usr/lib/x86_64-linux-gnu/libcurl.so* ${bkLibcurlPre}/ &> /dev/null
    mv -f /usr/lib/x86_64-linux-gnu/libcurl.la ${bkLibcurlPre}/ &> /dev/null
    mv -f /usr/lib/x86_64-linux-gnu/libcurl.a ${bkLibcurlPre}/ &> /dev/null
  fi

  _CURL_ITD=$(curl --version 2>&1 \
    | tr -d "\n" \
    | cut -d" " -f2 \
    | awk '{ print $1}' 2>&1)
  _CURL_SSL_ITD=$(curl --version 2>&1 \
    | tr -d "\n" \
    | cut -d" " -f5 \
    | awk '{ print $1}' \
    | cut -d"/" -f2 \
    | awk '{ print $1}' 2>&1)
  _CURL_LIB_ITD=$(curl --version 2>&1 \
    | tr -d "\n" \
    | cut -d" " -f4 \
    | awk '{ print $1}' \
    | cut -d"/" -f2 \
    | awk '{ print $1}' 2>&1)

  if [ "${_CURL_ITD}" != "${_CURL_VRN}" ]; then
    _CURL_INSTALL_REQUIRED=YES
    echo "INFO: Installed cURL/lib ${_CURL_ITD}/${_CURL_LIB_ITD}, upgrade required"
  fi

  isCurl=$(curl --version 2>&1)
  if [[ ! "${isCurl}" =~ "OpenSSL" ]] \
    || [[ "${isCurl}" =~ "libcurl.so.4" ]] \
    || [ -z "${isCurl}" ] \
    || [ "${ifAnySymlinksCleaned}" = "YES" ] \
    || [ "${ifAnyFilesCleaned}" = "YES" ] \
    || [ "${_CURL_INSTALL_REQUIRED}" = "YES" ]; then
    if [ -e "/var/aegir/drush" ]; then
      echo "OOPS: cURL is broken! Re-installing.."
    fi
    if [ -e "/var/aegir/drush" ]; then
      if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
        && [ -e "/etc/apt/apt.conf.d" ]; then
        echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
      fi
      apt_clean_update
      apt-get build-dep curl -y 2> /dev/null
      apt-get remove libssl1.0-dev -y --purge --auto-remove -qq 2> /dev/null
      apt-get autoremove -y 2> /dev/null
      apt-get install libssl-dev -y -qq 2> /dev/null
      apt-get install libc-client2007e libc-client2007e-dev -y -qq 2> /dev/null
    fi
    if [ -e "/var/aegir/drush" ]; then
      echo "INFO: Installing curl from sources..."
      mkdir -p /var/opt
      rm -rf /var/opt/curl*
      cd /var/opt
      wget -q -U iCab http://files.aegir.cc/dev/src/curl-${_CURL_VRN}.tar.gz &> /dev/null
      tar -xzf curl-${_CURL_VRN}.tar.gz &> /dev/null
      if [ -e "/root/.install.modern.openssl.cnf" ] \
        && [ -x "/usr/local/ssl3/bin/openssl" ]; then
        _SSL_BINARY=/usr/local/ssl3/bin/openssl
      else
        _SSL_BINARY=/usr/local/ssl/bin/openssl
      fi
      if [ -e "/usr/local/ssl3/lib64/libssl.so.3" ]; then
        _SSL_PATH="/usr/local/ssl3"
        _SSL_LIB_PATH="${_SSL_PATH}/lib64"
      else
        _SSL_PATH="/usr/local/ssl"
        _SSL_LIB_PATH="${_SSL_PATH}/lib"
      fi
      _PKG_CONFIG_PATH="${_SSL_LIB_PATH}/pkgconfig"

      if [ -e "${_PKG_CONFIG_PATH}" ] \
        && [ -e "/var/opt/curl-${_CURL_VRN}" ]; then
        cd /var/opt/curl-${_CURL_VRN}
        LIBS="-ldl -lpthread" PKG_CONFIG_PATH="${_PKG_CONFIG_PATH}" ./configure \
          --with-openssl \
          --with-zlib=/usr \
          --prefix=/usr/local &> /dev/null
        make -j $(nproc) --quiet &> /dev/null
        make --quiet install &> /dev/null
        ldconfig 2> /dev/null
      fi
    fi
    if [ -x "/usr/local/bin/curl" ]; then
      _CURL_ITD=$(/usr/local/bin/curl --version 2>&1 \
        | tr -d "\n" \
        | cut -d" " -f2 \
        | awk '{ print $1}' 2>&1)
      if [ "${_CURL_ITD}" != "${_CURL_VRN}" ]; then
        echo "ERRR: /usr/local/bin/curl is broken"
        echo "ERRR: Please install cURL and debug manually"
      else
        echo "GOOD: /usr/local/bin/curl works"
        echo "curl hold" | dpkg --set-selections &> /dev/null
        if [ -x "/usr/local/bin/curl" ]; then
          if [ -x "/usr/bin/curl" ] && [ ! -L "/usr/bin/curl" ]; then
            mv -f /usr/bin/curl /usr/bin/old-curl-$(date +%y%m%d-%H%M%S 2>&1)
          fi
          ln -sfn /usr/local/bin/curl /usr/bin/curl
        fi
        if [ ! -e "${_SSL_PATH}/certs/ca-certificates.crt" ]; then
          cp -af /etc/ssl/certs/* ${_SSL_PATH}/certs/ &> /dev/null
        fi
        if [ -e "/usr/local/lib/libcurl.so.4.8.0" ]; then
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/libcurl.so
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/libcurl.so.4
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/libcurl.so.4.8.0
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/x86_64-linux-gnu/libcurl.so
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/x86_64-linux-gnu/libcurl.so.4
          ln -sfn /usr/local/lib/libcurl.so.4.8.0 /usr/lib/x86_64-linux-gnu/libcurl.so.4.8.0
        fi
        if [ -e "/usr/local/lib/libcurl.a" ]; then
          ln -sfn /usr/local/lib/libcurl.a /usr/lib/x86_64-linux-gnu/libcurl.a
          ln -sfn /usr/local/lib/libcurl.a /usr/lib/libcurl.a
        fi
        if [ -e "/usr/local/lib/libcurl.la" ]; then
          ln -sfn /usr/local/lib/libcurl.la /usr/lib/x86_64-linux-gnu/libcurl.la
          ln -sfn /usr/local/lib/libcurl.la /usr/lib/libcurl.la
        fi
        ldconfig 2> /dev/null
        if [ -d "/usr/local/include/curl" ] \
          && [ -d "/usr/include/x86_64-linux-gnu/curl" ] \
          && [ ! -L "/usr/include/x86_64-linux-gnu/curl" ]; then
          apt_clean_update
          apt-get remove libcurl4-openssl-dev -y --purge --auto-remove -qq 2> /dev/null
          ln -sfn /usr/local/include/curl /usr/include/x86_64-linux-gnu/curl
          ldconfig 2> /dev/null
        fi
      fi
    fi
  fi
}

if_boa_key_tools_update_allowed() {
  if [ -e "/root/.run-to-daedalus.cnf" ] \
    || [ -e "/root/.run-to-chimaera.cnf" ] \
    || [ -e "/root/.run-to-beowulf.cnf" ]; then
    _BOA_KEY_TOOLS_UPDATE_ALLOWED=NO
  else
    _BOA_KEY_TOOLS_UPDATE_ALLOWED=YES
  fi
}

update_boa_tools() {
  mkdir -p ${usrBin}
  if [ -e "${pthLog}" ] && [ ! -e "${pthLog}/updateFx07.ctrl.${tRee}.${_X_SE}.pid" ]; then
    fxPp="fix-drupal-platform-permissions.sh"
    fxSp="fix-drupal-site-permissions.sh"
    fxPo="fix-drupal-platform-ownership.sh"
    fxSo="fix-drupal-site-ownership.sh"
    fxLo="lock-local-drush-permissions.sh"
    curl ${crlGet} "${urlHmr}/${tBn}/${fxPp}" -o ${usrBin}/${fxPp}
    curl ${crlGet} "${urlHmr}/${tBn}/${fxSp}" -o ${usrBin}/${fxSp}
    curl ${crlGet} "${urlHmr}/${tBn}/${fxPo}" -o ${usrBin}/${fxPo}
    curl ${crlGet} "${urlHmr}/${tBn}/${fxSo}" -o ${usrBin}/${fxSo}
    curl ${crlGet} "${urlHmr}/${tBn}/${fxLo}" -o ${usrBin}/${fxLo}
    chmod 700 ${usrBin}/${fxPp}
    chmod 700 ${usrBin}/${fxSp}
    chmod 700 ${usrBin}/${fxPo}
    chmod 700 ${usrBin}/${fxSo}
    chmod 700 ${usrBin}/${fxLo}
    touch ${pthLog}/updateFx07.ctrl.${tRee}.${_X_SE}.pid
  fi
  mkdir -p ${optBin}
  rm -f ${usrBin}/{autoinit*,barracuda*,boa*,fancynow*,killer*,octopus*}
  if [ ! -d "/data/u" ]; then
    ln -s ${optBin}/autoinit  ${usrBin}/autoinit
    ln -s ${optBin}/barracuda ${usrBin}/barracuda
    ln -s ${optBin}/boa       ${usrBin}/boa
    ln -s ${optBin}/fancynow  ${usrBin}/fancynow
    ln -s ${optBin}/killer    ${usrBin}/killer
    ln -s ${optBin}/octopus   ${usrBin}/octopus
  fi
  boaBins="autobeowulf \
           autochimaera \
           autodaedalus \
           autoinit \
           autoupboa \
           barracuda \
           boa \
           fancynow \
           ffmirror \
           killer \
           mycnfup \
           octopus \
           randpass \
           sqlmagic \
           syncpass \
           thinkdifferent \
           weblogx \
           xboa"
  for cbn in ${boaBins}; do
    if [ -e "${optBin}/${cbn}" ]; then
      if [ `ps aux | grep -v "grep" | grep --count "/${cbn}"` -gt "0" ]; then
        echo "The ${cbn} is running!"
      else
        if [ "${cbn}" = "weblogx" ] \
          && [ `ps aux | grep -v "grep" | grep --count "/daily.sh"` -gt "0" ]; then
          echo "The ${cbn} and daily.sh is running!"
        else
          rm -f ${optBin}/${cbn}.new
          curl ${crlGet} "${urlHmr}/${tBn}/${cbn}" -o ${optBin}/${cbn}.new
          mv -f ${optBin}/${cbn} ${optBin}/${cbn}.prev
          mv -f ${optBin}/${cbn}.new ${optBin}/${cbn}
          if [ -e "${optBin}/${cbn}" ]; then
            chmod 755 ${optBin}/${cbn}
            rm -f ${optBin}/${cbn}.prev
          else
            mv -f ${optBin}/${cbn}.prev ${optBin}/${cbn}
          fi
        fi
      fi
    else
      curl ${crlGet} "${urlHmr}/${tBn}/${cbn}" -o ${optBin}/${cbn}
    fi
  done
  echo "### ${_TODAY} ###" >> ${optBin}/autoinit
  echo "### ${_TODAY} ###" >> ${optBin}/barracuda
  echo "### ${_TODAY} ###" >> ${optBin}/boa
  echo "### ${_TODAY} ###" >> ${optBin}/fancynow
  echo "### ${_TODAY} ###" >> ${optBin}/killer
  echo "### ${_TODAY} ###" >> ${optBin}/octopus
  [ -e "/root/.backboa.autoupdate" ] && rm -f /root/.backboa.autoupdate
  if [ `ps aux | grep -v "grep" | grep --count "duplicity"` -gt "0" ]; then
    echo "The duplicity backup is running!"
  else
    rm -f ${optBin}/{backboa,duobackboa}
    curl ${crlGet} "${urlHmr}/${tBn}/backboa"      -o ${optBin}/backboa
    curl ${crlGet} "${urlHmr}/${tBn}/duobackboa"   -o ${optBin}/duobackboa
    chmod 700 ${optBin}/{backboa,duobackboa}
    if [ ! -e "${pthLog}/duplicity.ctrl.${tRee}.${_X_SE}.pid" ] \
      && [ -x "/usr/local/bin/duplicity" ] \
      && [ -e "/root/.cache/duplicity" ] \
      && [ -e "/var/aegir/drush" ] \
      && [ -e "/var/xdrago" ]; then
      backboa install
      touch ${pthLog}/duplicity.ctrl.${tRee}.${_X_SE}.pid
      touch /root/.backboa.autoupdate
    fi
  fi
  chmod 700 ${optBin}/{autoinit,autodaedalus,autochimaera,autobeowulf,autoupboa,backboa,duobackboa}
  chmod 700 ${optBin}/{barracuda,boa,ffmirror,killer,mycnfup,octopus,syncpass,xboa,weblogx}
  chmod 755 ${optBin}/{fancynow,randpass,sqlmagic,thinkdifferent}
}

if_update_boa_key_tools_only() {
  sed -i "s/.*files.aegir.cc.*//g" /etc/hosts
  wait
  sed -i "s/.*github.*//g" /etc/hosts
  wait
  echo >>/etc/hosts
  sed -i "/^$/d" /etc/hosts
  wait
  if [ ! -f "/etc/resolv.conf" ]; then
    rm -f /etc/resolv.conf
    echo "nameserver 127.0.0.1" > /etc/resolv.conf
    if [ -e "${vBs}/resolv.conf.vanilla" ]; then
      cat ${vBs}/resolv.conf.vanilla >> /etc/resolv.conf
    fi
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
    echo "nameserver 1.0.0.1" >> /etc/resolv.conf
    echo "nameserver 8.8.8.8" >> /etc/resolv.conf
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf
    check_dns_settings
  else
    check_dns_settings
  fi
  if [ -x "/usr/sbin/unbound-control" ] \
    && [ -e "/etc/resolvconf/run/interface/lo.unbound" ]; then
    unbound-control reload &> /dev/null
  fi

  if_reinstall_curl

  _CURL_TEST=$(curl -L -k -s \
    --max-redirs 10 \
    --retry 3 \
    --retry-delay 10 \
    -I "http://${_USE_MIR}" 2> /dev/null)
  if [[ ! "${_CURL_TEST}" =~ "200 OK" ]]; then
    if [[ "${_CURL_TEST}" =~ "unknown option was passed in to libcurl" ]]; then
      echo "ERROR: cURL libs are out of sync! Re-installing.."
      if_reinstall_curl
    fi
    echo "ERROR: ${_USE_MIR} is not available, please try later"
    exit 1
  else
    urlHmr="http://${_USE_MIR}/versions/${tRee}/boa/aegir"
  fi
  _LSB_TEST=$(which lsb_release 2> /dev/null)
  if [ ! -x "${_LSB_TEST}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install lsb-release ${aptYesUnth} &> /dev/null
  fi
  _IPSET_TEST=$(which ipset 2> /dev/null)
  if [ ! -x "${_IPSET_TEST}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    if [ -L "/sbin/ipset" ]; then
      rm -f /sbin/ipset
    fi
    if [ -L "/usr/sbin/ipset" ]; then
      rm -f /usr/sbin/ipset
    fi
    apt-get install ipset ${aptYesUnth} &> /dev/null
  fi
  if [ -x "/sbin/ipset" ] && [ ! -e "/usr/sbin/ipset" ]; then
    ln -s /sbin/ipset /usr/sbin/ipset
  fi
  if [ -x "/usr/sbin/ipset" ] && [ ! -e "/sbin/ipset" ]; then
    ln -s /usr/sbin/ipset /sbin/ipset
  fi
  if [ -x "/usr/sbin/csf" ] \
    && [ -e "/etc/csf/csf.deny" ] \
    && [ ! -x "/etc/csf/csfpost.sh" ]; then
    echo "" > /etc/csf/csfpost.sh
    echo "iptables -t raw -A PREROUTING -p tcp --dport 21 -j CT --helper ftp" >> /etc/csf/csfpost.sh
    echo "iptables -t raw -A OUTPUT -p tcp --dport 21 -j CT --helper ftp" >> /etc/csf/csfpost.sh
    chmod 700 /etc/csf/csfpost.sh
    _CSF_TEST=$(which csf 2> /dev/null)
    if [ -x "${_CSF_TEST}" ]; then
      service clean-boa-env start &> /dev/null
      wait
      if_fix_iptables_symlinks
      csf -uf
      wait
      _NFTABLES_TEST=$(iptables -V 2>&1)
      if [[ "${_NFTABLES_TEST}" =~ "nf_tables" ]]; then
        if [ -e "/usr/sbin/iptables-legacy" ]; then
          update-alternatives --set iptables /usr/sbin/iptables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/ip6tables-legacy" ]; then
          update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/arptables-legacy" ]; then
          update-alternatives --set arptables /usr/sbin/arptables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/ebtables-legacy" ]; then
          update-alternatives --set ebtables /usr/sbin/ebtables-legacy &> /dev/null
        fi
      fi
      sed -i "s/.*DHCP.*//g" /etc/csf/csf.allow
      wait
      sed -i "/^$/d" /etc/csf/csf.allow
      if [ -e "/var/log/daemon.log" ]; then
        _DHCP_LOG="/var/log/daemon.log"
      else
        _DHCP_LOG="/var/log/syslog"
      fi
      _DHCP_TEST=$(grep DHCPREQUEST ${_DHCP_LOG} | cut -d ' ' -f13 | sort | uniq 2>&1)
      if [[ "${_DHCP_TEST}" =~ "port" ]]; then
        for _IP in `grep DHCPREQUEST ${_DHCP_LOG} | cut -d ' ' -f12 | sort | uniq`;do echo "udp|out|d=67|d=${_IP} # Local DHCP out" >> /etc/csf/csf.allow;done
      else
        for _IP in `grep DHCPREQUEST ${_DHCP_LOG} | cut -d ' ' -f13 | sort | uniq`;do echo "udp|out|d=67|d=${_IP} # Local DHCP out" >> /etc/csf/csf.allow;done
      fi
      csf -q
      ### Linux kernel TCP SACK CVEs mitigation
      ### CVE-2019-11477 SACK Panic
      ### CVE-2019-11478 SACK Slowness
      ### CVE-2019-11479 Excess Resource Consumption Due to Low MSS Values
      if [ -x "/usr/sbin/csf" ] && [ -e "/etc/csf/csf.deny" ]; then
        _SACK_TEST=$(ip6tables --list | grep tcpmss 2>&1)
        if [[ ! "${_SACK_TEST}" =~ "tcpmss" ]]; then
          sysctl net.ipv4.tcp_mtu_probing=0 &> /dev/null
          iptables -A INPUT -p tcp -m tcpmss --mss 1:500 -j DROP &> /dev/null
          ip6tables -A INPUT -p tcp -m tcpmss --mss 1:500 -j DROP &> /dev/null
        fi
      fi
    fi
  fi
  if [ -x "/usr/sbin/csf" ] && [ -e "/etc/csf/csf.conf" ]; then
    _CC_SRC_TEST=$(grep 'CC_SRC\ =' /etc/csf/csf.conf 2>&1)
    echo _CC_SRC_TEST 1 is "${_CC_SRC_TEST}"
    if [[ ! ${_CC_SRC_TEST} =~ CC_SRC\ =\ \"2\" ]]; then
      echo _CC_SRC_TEST 2 is "${_CC_SRC_TEST}"
      service clean-boa-env start &> /dev/null
      wait
      if_fix_iptables_symlinks
      csf -uf
      wait
      _NFTABLES_TEST=$(iptables -V 2>&1)
      if [[ "${_NFTABLES_TEST}" =~ "nf_tables" ]]; then
        if [ -e "/usr/sbin/iptables-legacy" ]; then
          update-alternatives --set iptables /usr/sbin/iptables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/ip6tables-legacy" ]; then
          update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/arptables-legacy" ]; then
          update-alternatives --set arptables /usr/sbin/arptables-legacy &> /dev/null
        fi
        if [ -e "/usr/sbin/ebtables-legacy" ]; then
          update-alternatives --set ebtables /usr/sbin/ebtables-legacy &> /dev/null
        fi
      fi
      sed -i "s/^CC_SRC .*/CC_SRC = \"2\"/g" /etc/csf/csf.conf
      wait
      sed -i "s/^AUTO_UPDATES .*/AUTO_UPDATES = \"0\"/g" /etc/csf/csf.conf
      csf -q
    fi
  fi
  update_boa_tools
  if [ "${1}" = "verbose" ] || [ -z "${1}" ]; then
    echo
    echo "BOA Meta Installers setup completed"
    echo "Please check INSTALL.md and UPGRADE.md at https://github.com/omega8cc/boa"
    echo "Bye"
    echo
  fi
}

setup() {
  _BENG_VS=NO
  _VMFAMILY=NO
  _CHECK_HOST=$(uname -n 2>&1)
  _VM_TEST=$(uname -a 2>&1)
  if [[ "${_VM_TEST}" =~ "-beng" ]]; then
    _BENG_VS=YES
  fi
  if [ "${_BENG_VS}" = "YES" ]; then
    _RANDOMIZE=YES
  else
    _RANDOMIZE=NO
  fi
  if_hosted_sys
  if [ "${hostedSys}" = "YES" ]; then
    _VMFAMILY=HOSTED
  fi
  sed -i "s/.*files.aegir.cc.*//g" /etc/hosts
  wait
  sed -i "s/.*github.*//g" /etc/hosts
  wait
  echo >>/etc/hosts
  sed -i "/^$/d" /etc/hosts
  wait
  if [ ! -f "/etc/resolv.conf" ]; then
    rm -f /etc/resolv.conf
    echo "nameserver 127.0.0.1" > /etc/resolv.conf
    if [ -e "${vBs}/resolv.conf.vanilla" ]; then
      cat ${vBs}/resolv.conf.vanilla >> /etc/resolv.conf
    fi
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
    echo "nameserver 1.0.0.1" >> /etc/resolv.conf
    echo "nameserver 8.8.8.8" >> /etc/resolv.conf
    echo "nameserver 8.8.4.4" >> /etc/resolv.conf
    check_dns_settings
  else
    check_dns_settings
  fi
  if [ -x "/usr/sbin/unbound-control" ] \
    && [ -e "/etc/resolvconf/run/interface/lo.unbound" ]; then
    unbound-control reload &> /dev/null
  fi

  if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
    && [ -e "/etc/apt/apt.conf.d" ]; then
    echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
  fi
  if [ ! -e "/etc/apt/apt.conf.d/99ignorestrict" ] \
    && [ -e "/etc/apt/apt.conf.d" ]; then
    echo "APT::Get::AllowInsecureRepositories \"true\";" > /etc/apt/apt.conf.d/99ignorestrict
    echo "APT::Get::AllowUnauthenticated \"true\";"     >> /etc/apt/apt.conf.d/99ignorestrict
    echo "Aptitude::CmdLine::Fix-Broken \"true\";"      >> /etc/apt/apt.conf.d/99ignorestrict
  fi
  apt_clean_update

  if [ ! -e "/var/aegir/drush" ] && [ ! -e "/var/xdrago/manage_solr_config.sh" ]; then
#     apt-get remove unscd -y --purge --auto-remove -qq &> /dev/null
#     apt-get remove dbus -y --purge --auto-remove -qq &> /dev/null
#     if [ -e "/usr/share/dbus-1" ]; then
#       rm -f /usr/share/dbus-1/*/*freedesktop*
#     fi
    userdel -r debian &> /dev/null
    sed -i "s/^#startup_message off/startup_message off/g" /etc/screenrc &> /dev/null
  fi

  isScreen=$(screen --version 2>&1)
  if [[ ! "${isScreen}" =~ "GNU" ]] || [ -z "${isScreen}" ]; then
    apt-get install screen -y &> /dev/null
    apt-get install net-tools -y &> /dev/null
    apt-get install hostname -y &> /dev/null
  fi

  if_reinstall_curl

  _CURL_TEST=$(curl -L -k -s \
    --max-redirs 10 \
    --retry 3 \
    --retry-delay 10 \
    -I "http://${_USE_MIR}" 2> /dev/null)
  if [[ ! "${_CURL_TEST}" =~ "200 OK" ]]; then
    if [[ "${_CURL_TEST}" =~ "unknown option was passed in to libcurl" ]]; then
      echo "ERROR: cURL libs are out of sync! Re-installing.."
      if_reinstall_curl
    fi
    echo "ERROR: ${_USE_MIR} is not available, please try later"
    exit 1
  else
    urlHmr="http://${_USE_MIR}/versions/${tRee}/boa/aegir"
  fi

  if_clean_boa_env

  _VIRT_TEST=$(which virt-what 2> /dev/null)
  if [ ! -x "${_VIRT_TEST}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install virt-what ${aptYesUnth} &> /dev/null
  fi
  _LSB_TEST=$(which lsb_release 2> /dev/null)
  if [ ! -x "${_LSB_TEST}" ]; then
    if [ ! -e "/etc/apt/apt.conf.d/00sandboxoff" ] \
      && [ -e "/etc/apt/apt.conf.d" ]; then
      echo "APT::Sandbox::User \"root\";" > /etc/apt/apt.conf.d/00sandboxoff
    fi
    apt_clean_update
    apt-get install lsb-release ${aptYesUnth} &> /dev/null
  fi
  update_boa_tools
  echo
  echo "BOA Meta Installers setup completed"
  echo "Please check INSTALL.md and UPGRADE.md at https://github.com/omega8cc/boa"
  echo "Bye"
  echo
}

count_cpu() {
  _CPU_INFO=$(grep -c processor /proc/cpuinfo 2>&1)
  _CPU_INFO=${_CPU_INFO//[^0-9]/}
  _NPROC_TEST=$(which nproc 2>&1)
  if [ -z "${_NPROC_TEST}" ]; then
    _CPU_NR="${_CPU_INFO}"
  else
    _CPU_NR=$(nproc 2>&1)
  fi
  _CPU_NR=${_CPU_NR//[^0-9]/}
  if [ ! -z "${_CPU_NR}" ] \
    && [ ! -z "${_CPU_INFO}" ] \
    && [ "${_CPU_NR}" -gt "${_CPU_INFO}" ] \
    && [ "${_CPU_INFO}" -gt "0" ]; then
    _CPU_NR="${_CPU_INFO}"
  fi
  if [ -z "${_CPU_NR}" ] || [ "${_CPU_NR}" -lt "1" ]; then
    _CPU_NR=1
  fi
  mkdir -p /data/all
  chmod 755 /data/all
  echo ${_CPU_NR} > /data/all/cpuinfo
  chmod 644 /data/all/cpuinfo
}

sysctl_update() {
  if [ ! -e "/root/.no.sysctl.update.cnf" ] \
    && [ ! -e "/var/backups/sysctl.conf.up-hf01-${_X_SE}.log" ]; then
    mkdir -p /var/backups
    cd /var/backups
    rm -f /var/backups/sysctl.conf
    curl ${crlGet} "${urlHmr}/conf/var/sysctl.conf" -o sysctl.conf
    if [ -e "/var/backups/sysctl.conf" ]; then
      cp -af /var/backups/sysctl.conf /etc/sysctl.conf
    fi
    if [ -e "/etc/security/limits.conf" ]; then
      _IF_NF=$(grep '2097152' /etc/security/limits.conf 2>&1)
      if [ ! -z "${_IF_NF}" ]; then
        sed -i "s/.*2097152.*//g" /etc/security/limits.conf
        wait
      fi
      _IF_NF=$(grep '524288' /etc/security/limits.conf 2>&1)
      if [ -z "${_IF_NF}" ]; then
        echo "*         hard    nofile      524288"  >> /etc/security/limits.conf
        echo "*         soft    nofile      524288"  >> /etc/security/limits.conf
        echo "root      hard    nofile      1048576" >> /etc/security/limits.conf
        echo "root      soft    nofile      1048576" >> /etc/security/limits.conf
      fi
      _IF_NF=$(grep '65556' /etc/security/limits.conf 2>&1)
      if [ -z "${_IF_NF}" ]; then
        echo "*         hard    nproc       65556"   >> /etc/security/limits.conf
        echo "*         soft    nproc       65556"   >> /etc/security/limits.conf
      fi
    fi
    if [ -e "/boot/grub/grub.cfg" ] || [ -e "/boot/grub/menu.lst" ]; then
      #echo never > /sys/kernel/mm/transparent_hugepage/enabled
      if [ -e "/etc/sysctl.conf" ]; then
        sysctl -p /etc/sysctl.conf &> /dev/null
      fi
    else
      if [ -e "/etc/sysctl.conf" ]; then
        sysctl -p /etc/sysctl.conf &> /dev/null
      fi
    fi
    if [ -e "/etc/default/nginx" ]; then
      _IF_ULNX=$(grep '524288' /etc/default/nginx 2>&1)
      if [ -z "${_IF_ULNX}" ]; then
        sed -i "s/^ULIMIT=.*//gi" /etc/default/nginx
        wait
        echo ULIMIT=\"-n 524288\" >> /etc/default/nginx
        ulimit -n 524288 &> /dev/null
        service nginx restart &> /dev/null
      fi
    fi
    if [ -e "/etc/security/limits.d" ] \
      && [ ! -e "/etc/security/limits.d/sshd.conf" ]; then
      echo "sshd soft nofile 524288" > /etc/security/limits.d/sshd.conf
      echo "sshd hard nofile 999999" >> /etc/security/limits.d/sshd.conf
      echo "redis soft nofile 65535" > /etc/security/limits.d/redis.conf
      echo "redis hard nofile 524288" >> /etc/security/limits.d/redis.conf
      echo "nginx soft nofile 524288" > /etc/security/limits.d/nginx.conf
      echo "nginx hard nofile 999999" >> /etc/security/limits.d/nginx.conf
      echo "jetty9 soft nofile 65535" > /etc/security/limits.d/jetty9.conf
      echo "jetty9 hard nofile 524288" >> /etc/security/limits.d/jetty9.conf
      echo "solr7 soft nofile 65535" > /etc/security/limits.d/solr7.conf
      echo "solr7 hard nofile 524288" >> /etc/security/limits.d/solr7.conf
      echo "@www-data soft nofile 65535" > /etc/security/limits.d/www.conf
      echo "@www-data hard nofile 524288" >> /etc/security/limits.d/www.conf
      service redis-server restart &> /dev/null
      service nginx restart &> /dev/null
      service sshd restart &> /dev/null
      _PHP_V="83 82 81 80 74 73 72 71 70 56"
      for e in ${_PHP_V}; do
        if [ -e "/etc/init.d/php${e}-fpm" ]; then
          service php${e}-fpm reload &> /dev/null
        fi
      done
    fi
    touch /var/backups/sysctl.conf.up-hf01-${_X_SE}.log
  fi
}

###--------------------###
if [ `whoami` = "root" ]; then

  locales_check_fix_early
  os_detection_minimal
  find_fast_mirror_early

  ### CVE-2021-44228 Log4j 2 Vulnerability
  ### CVE-2021-45046 Log4j 2 Vulnerability
  ### CVE-2021-45105 Log4j 2 Vulnerability
  fix_log4j

  ### Linux kernel TCP SACK CVEs mitigation
  ### CVE-2019-11477 SACK Panic
  ### CVE-2019-11478 SACK Slowness
  ### CVE-2019-11479 Excess Resource Consumption Due to Low MSS Values
  if [ -x "/usr/sbin/csf" ] && [ -e "/etc/csf/csf.deny" ]; then
    _SACK_TEST=$(ip6tables --list | grep tcpmss 2>&1)
    if [[ ! "${_SACK_TEST}" =~ "tcpmss" ]]; then
      sysctl net.ipv4.tcp_mtu_probing=0 &> /dev/null
      iptables -A INPUT -p tcp -m tcpmss --mss 1:500 -j DROP &> /dev/null
      ip6tables -A INPUT -p tcp -m tcpmss --mss 1:500 -j DROP &> /dev/null
    fi
  fi
  ### More aggressive mitigation affecting network performance
  # if [ -e "/proc/sys/net/ipv4/tcp_sack" ]; then
  #   _SACK_TEST=$(cat /proc/sys/net/ipv4/tcp_sack 2>&1)
  #   _SACK_TEST=$(echo -n ${_SACK_TEST} | tr -d "\n" 2>&1)
  #   if [[ "${_SACK_TEST}" =~ "1" ]]; then
  #     echo "0" > /proc/sys/net/ipv4/tcp_sack
  #   fi
  # fi

  ### Block known attackers IPs
  _CSF_TEST=$(which csf 2> /dev/null)
  if [ -x "${_CSF_TEST}" ]; then
    _IP_BLOCK="185.206.225.30 185.253.97.238"
    for _IP in ${_IP_BLOCK}; do
      _FW_TEST=$(csf -g ${_IP} 2>&1)
      if [[ "${_FW_TEST}" =~ "DENY Match:${_IP} Setting" ]] \
        && [[ "${_FW_TEST}" =~ "csf.deny: ${_IP}" ]]; then
        echo "${_IP} already denied for Flooding user/password"
      else
        csf -d ${_IP} Flooding user/password
      fi
    done
  fi

  ### Linux kernel CVE-2017-2636 hotfix
  if [ -e "/etc/modprobe.d" ] \
    && [ ! -e "/etc/modprobe.d/blacklist-n_hdlc.conf" ]; then
    echo "install n_hdlc /bin/true" > /etc/modprobe.d/blacklist-n_hdlc.conf
    rmmod n_hdlc &> /dev/null
  fi

  ### Linux kernel CVE-2017-6074 hotfix
  if [ -e "/etc/modprobe.d" ] \
    && [ ! -e "/etc/modprobe.d/blacklist-dccp-all.conf" ]; then
    echo "install dccp /bin/true" > /etc/modprobe.d/blacklist-dccp-all.conf
    echo "install dccp_diag /bin/true" >> /etc/modprobe.d/blacklist-dccp-all.conf
    echo "install dccp_ipv4 /bin/true" >> /etc/modprobe.d/blacklist-dccp-all.conf
    echo "install dccp_ipv6 /bin/true" >> /etc/modprobe.d/blacklist-dccp-all.conf
    echo "install dccp_probe /bin/true" >> /etc/modprobe.d/blacklist-dccp-all.conf
    rmmod dccp &> /dev/null
    rmmod dccp_diag &> /dev/null
    rmmod dccp_ipv4 &> /dev/null
    rmmod dccp_ipv6 &> /dev/null
    rmmod dccp_probe &> /dev/null
  fi

  if [ -x "/usr/sbin/unbound" ] \
    && [ ! -e "/etc/resolvconf/run/interface/lo.unbound" ]; then
    mkdir -p /etc/resolvconf/run/interface
    echo "nameserver 127.0.0.1" > /etc/resolvconf/run/interface/lo.unbound
    resolvconf -u &> /dev/null
    [ -e "/etc/resolvconf/update.d/unbound" ] && chmod -x /etc/resolvconf/update.d/unbound
    killall -9 unbound &> /dev/null
    service unbound restart &> /dev/null
    wait
    unbound-control reload &> /dev/null
  fi

  if [ ! -e "/data/all/cpuinfo" ]; then
    count_cpu
  fi

  if_boa_key_tools_update_allowed

  if [ "${_BOA_KEY_TOOLS_UPDATE_ALLOWED}" = "YES" ] \
    && [ -e "/opt/etc/fpm/fpm-pool-common.conf" ] \
    && [ -e "/var/xdrago" ]; then
    if [ -e "${barCnf}" ]; then
      source ${barCnf}
    fi
    if [ ! -z "${_SKYNET_MODE}" ] && [ "${_SKYNET_MODE}" = "OFF" ]; then
      if [ -n "${SSH_TTY+x}" ]; then
        echo "STATUS: Skynet Agent is Inactive!"
        echo "STATUS: Please remove the _SKYNET_MODE=OFF line from"
        echo "STATUS: ${barCnf} to enable me again."
        echo "NOTE: Critically important BOA tools will be still updated"
        if_update_boa_key_tools_only verbose
        exit 0
      else
        if_update_boa_key_tools_only silent
        exit 0
      fi
    else
      if [ -n "${SSH_TTY+x}" ]; then
        echo "STATUS: Skynet Agent is Active, OK!"
        echo "STATUS: You can add the _SKYNET_MODE=OFF line in"
        echo "STATUS: ${barCnf} to disable me, if needed."
      fi
    fi
  else
    if [ -z "$STY" ]; then
      _SCREEN_INIT=YES
    fi
  fi
  if [ -d "/.newrelic" ]; then
    rm -rf /.newrelic
  fi
  chmod a+w /dev/null
  if [ ! -e "/dev/fd" ]; then
    if [ -e "/proc/self/fd" ]; then
      rm -rf /dev/fd
      ln -s /proc/self/fd /dev/fd
    fi
  fi
  if [ "${_BOA_KEY_TOOLS_UPDATE_ALLOWED}" = "YES" ]; then
    setup
  fi
  if [ "${_BOA_KEY_TOOLS_UPDATE_ALLOWED}" = "YES" ] \
    && [ -e "/var/log/barracuda_log.txt" ]; then
    fix_ping_perms
    fix_fpm_process_max
    if_fix_python
    fix_lshell
    fix_node_in_lshell_access
    fix_authorized_keys
    fix_tcp
    fix_aio
    fix_console_print
    fix_java_symlinks
    fix_wkhtml
    fix_wkhtml_perms
    fix_eldir
    fix_drupal_core_ten
    fix_pure_ftpd
    fix_hosting_le
    fix_newrelic
    fix_leftovers
    update_agents
    sysctl_update
    # saCoreN="SA-CORE-2018-002"
    # fix_core_dgd
    # sleep 3
    # saCoreN="SA-CORE-2018-004"
    # fix_core_dgd
    # sleep 3
    # saCoreN="SA-CORE-2018-006"
    # fix_core_dgd
    # sleep 3
    # saCoreN="SA-CORE-2019-004"
    # fix_core_dgd
    # sleep 3
    # saCoreN="3143016-83"
    # fix_core_dgd
  fi
  if [ ! -e "/etc/ssl/private/4096.dhp" ] && [ -d "/var/xdrago" ]; then
    echo "Generating 4096.dhp -- it may take a very long time..."
    openssl dhparam -out /etc/ssl/private/4096.dhp 4096 > /dev/null 2>&1 &
  fi
  if [ -e "/etc/ssl/private/4096.dhp" ]; then
    chown -R root:ssl-cert /etc/ssl/private
    chmod 640 /etc/ssl/private/*
    chmod 710 /etc/ssl/private
  fi
  if [ ! -e "/root/.upstart.cnf" ]; then
    service cron reload &> /dev/null
  fi
  if [ "${_SCREEN_INIT}" = "YES" ]; then
    clear
    echo
    echo "The system is ready for BOA installation!"
    echo
    echo "We will start screen session for you in 15 seconds"
    echo "to avoid problems with dropped SSH connections"
    echo "during BOA stack installation, which may take up to"
    echo "30-60 minutes, depending on your server speed."
    echo
    echo "If your connection will drop, simply log in again"
    echo "and re-attach your session with 'screen -R' command."
    echo
    echo "Please wait a moment until this message disappears."
    echo
    echo "Enjoy!"
    echo
    sleep 15
    screen
  else
    exit 0
  fi
else
  echo "ERROR: This script should be run as a root user"
  exit 1
fi
